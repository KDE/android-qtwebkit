#!/usr/bin/perl -w

use strict;
use FindBin;
use Cwd;
use lib $FindBin::Bin;
use webkitdirs;

chdirWebKit();

my $verbose = $ARGV[0] && $ARGV[0] eq "-v";

my $workingDir = getcwd();
my $WebCoreDirectory = "$workingDir/WebCore";
my $testDirectory = "$WebCoreDirectory/layout-tests";

my @suites = ( {"name" => "DOM Level 1 Core   (html)", "directory" => "dom/html/level1/core"},
	       {"name" => "DOM Level 2 Core   (html)", "directory" => "dom/html/level2/core"},
	       {"name" => "DOM Level 2 Events (html)", "directory" => "dom/html/level2/events"},
	       {"name" => "DOM Level 2 HTML   (html)", "directory" => "dom/html/level2/html"} );

my $totalCount = 0;
my $totalSuccesses = 0;
my $totalDisabled = 0;
my $totalFailed = 0;

foreach my $suite (@suites) {

    my %suite = %$suite;
    my $directory = $suite{"directory"};
    my $name = $suite{"name"};
    my @results = `find "${testDirectory}/${directory}" -name "*-expected.txt"`;
    my @disabled = `find "${testDirectory}/${directory}" -name "*.html-disabled"`;

    my @failures = ();
    my $count = 0;

    foreach my $result (@results) {
	$count++;
	my $success = 0;
	open RESULT, "<$result";
	while (<RESULT>) {
	    if (/Success/) {
		$success = 1;
		last;
	    }
	}
	close RESULT;
	if (!$success) {
	    push @failures, $result;
	}
    }

    my $disabledCount = (scalar @disabled);
    my $failureCount = (scalar @failures);

    $count += $disabledCount;

    my $successCount = $count - $failureCount - $disabledCount;
    my $percentage = (sprintf "%.1f", ($successCount * 100.0 / $count));
    
    print "${name}: ${successCount} out of ${count} tests succeeded (${percentage}%)\n";
    if ($verbose) {
	print "\n";
	if (@disabled) {
	    print "    Disabled:\n";
	    
	    foreach my $failure (sort @disabled) {
		$failure =~ s|.*/||;
		$failure =~ s|-disabled||;
		print "        ${directory}/${failure}";
	    }
	}
	if (@failures) {
	    print "    Failed:\n";
	    
	    foreach my $failure (sort @failures) {
		$failure =~ s|.*/||;
		$failure =~ s|-expected\.txt|.html|;
		print "        ${directory}/${failure}";
	    }
	}

	print "\n";
    }

    $totalCount += $count;
    $totalSuccesses += $successCount;
    $totalDisabled += $disabledCount;
    $totalFailed += $failureCount;
}


my $totalPercentage = (sprintf "%.1f", ($totalSuccesses * 100.0 / $totalCount));
my $totalDisabledPercentage = (sprintf "%.1f", ($totalDisabled * 100.0 / $totalCount));
my $totalFailedPercentage = (sprintf "%.1f", ($totalFailed * 100.0 / $totalCount));

print "Total: ${totalSuccesses} out of ${totalCount} tests succeeded (${totalPercentage}%)\n";
print "       ${totalDisabled} tests disabled (${totalDisabledPercentage}%)\n";
print "       ${totalFailed} tests failed (${totalFailedPercentage}%)\n";
