<p>This test checks cross-frame access security (rdar://problem/5251309).</p>
<iframe src="http://localhost:8000/security/resources/cross-frame-iframe.html" style=""></iframe>
<pre id="console"></pre>

<script>
function log(s)
{
    document.getElementById("console").appendChild(document.createTextNode(s + "\n"));
}

function shouldBe(a, b)
{
    var evalA, evalB;
    try {
        evalA = eval(a);
        evalB = eval(b);
    } catch(e) {
        evalA = e;
    }

    var message = (evalA === evalB)
                    ? "PASS: " + a + " should be '" + evalB + "' and is."
                    : "*** FAIL: " + a + " should be '" + evalB + "' but instead is " + evalA + ". ***";
    log(message);
}

function shouldBeTrue(a) 
{ 
    shouldBe(a, "true"); 
}

function shouldBeFalse(b) 
{ 
    shouldBe(b, "false"); 
}

function canGet(keyPath)
{
    try {
        return eval("window." + keyPath) !== undefined;
    } catch(e) {
        return false;
    }
}

window.marker = { };

function canSet(keyPath, valuePath)
{
    if (valuePath === undefined)
        valuePath = "window.marker";

    try {
        eval("window." + keyPath + " = " + valuePath);
        return eval("window." + keyPath) === eval("window." + valuePath);
    } catch(e) {
        return false;
    }
}

function canCall(keyPath, argumentString)
{
    try {
        eval("window." + keyPath + "(" + (argumentString === undefined ? "" : "'" + argumentString + "'") + ")");
        return true;
    } catch(e) {
        return false;
    }
}

function toString(expression, valueForException)
{
    if (valueForException === undefined)
        valueForException = "[exception]";
        
    try {
        var evalExpression = eval(expression);
        if (evalExpression === undefined)
            throw null;
        return String(evalExpression);
    } catch(e) {
        return valueForException;
    }
}

var windowPropertiesNotAllowed = [
    "Attr", 
    "CDATASection", 
    "CSSPrimitiveValue", 
    "CSSRule", 
    "CSSStyleDeclaration", 
    "CSSValue", 
    "CharacterData", 
    "Comment", 
    "DOMException", 
    "DOMImplementation", 
    "DOMParser", 
    "Document", 
    "DocumentFragment", 
    "DocumentType", 
    "Element", 
    "Entity", 
    "EntityReference", 
    "EvalError", 
    "Event", 
    "HTMLAnchorElement", 
    "HTMLAppletElement", 
    "HTMLAreaElement", 
    "HTMLBRElement", 
    "HTMLBaseElement", 
    "HTMLBaseFontElement", 
    "HTMLBodyElement", 
    "HTMLButtonElement", 
    "HTMLCanvasElement", 
    "HTMLDListElement", 
    "HTMLDirectoryElement", 
    "HTMLDivElement", 
    "HTMLDocument", 
    "HTMLElement", 
    "HTMLFieldSetElement", 
    "HTMLFontElement", 
    "HTMLFormElement", 
    "HTMLFrameElement", 
    "HTMLFrameSetElement", 
    "HTMLHRElement", 
    "HTMLHeadElement", 
    "HTMLHeadingElement", 
    "HTMLHtmlElement", 
    "HTMLIFrameElement", 
    "HTMLImageElement", 
    "HTMLInputElement", 
    "HTMLIsIndexElement", 
    "HTMLLIElement", 
    "HTMLLabelElement", 
    "HTMLLegendElement", 
    "HTMLLinkElement", 
    "HTMLMapElement", 
    "HTMLMarqueeElement", 
    "HTMLMenuElement", 
    "HTMLMetaElement", 
    "HTMLModElement", 
    "HTMLOListElement", 
    "HTMLOptGroupElement", 
    "HTMLOptionElement", 
    "HTMLParagraphElement", 
    "HTMLParamElement", 
    "HTMLPreElement", 
    "HTMLQuoteElement", 
    "HTMLScriptElement", 
    "HTMLSelectElement", 
    "HTMLStyleElement", 
    "HTMLTableCaptionElement", 
    "HTMLTableCellElement", 
    "HTMLTableColElement", 
    "HTMLTableElement", 
    "HTMLTableRowElement", 
    "HTMLTableSectionElement", 
    "HTMLTextAreaElement", 
    "HTMLTitleElement", 
    "HTMLUListElement", 
    "Image", 
    "MutationEvent", 
    "Node", 
    "NodeFilter", 
    "Notation", 
    "Option", 
    "ProcessingInstruction", 
    "Range", 
    "RangeError", 
    "RangeException", 
    "ReferenceError", 
    "SyntaxError", 
    "Text", 
    "TypeError", 
    "URIError", 
    "XMLDocument", 
    "XMLHttpRequest", 
    "XMLSerializer", 
    "XPathEvaluator", 
    "XPathResult", 
    "XSLTProcessor", 
    "addEventListener", 
    "alert", 
    "atob", 
    "btoa", 
    "captureEvents", 
    "clearInterval", 
    "clearTimeout", 
    "clientInformation", 
    "confirm", 
    "console", 
    "crypto", 
    "defaultStatus", 
    "defaultstatus", 
    "devicePixelRatio", 
    "document",
    "embeds",
    "eval",
    "event", 
    "find", 
    "frameElement", 
    "getComputedStyle",
    "getMatchedCSSRules", 
    "getSelection", 
    "images",
    "innerHeight", 
    "innerWidth", 
    "locationbar", 
    "menubar", 
    "moveBy", 
    "moveTo", 
    "name", 
    "navigator", 
    "offscreenBuffering", 
    "onabort", 
    "onbeforeunload", 
    "onblur", 
    "onchange", 
    "onclick", 
    "ondblclick", 
    "onerror", 
    "onfocus", 
    "onkeydown", 
    "onkeypress", 
    "onkeyup", 
    "onload", 
    "onmousedown", 
    "onmousemove", 
    "onmouseout", 
    "onmouseover", 
    "onmouseup", 
    "onmousewheel", 
    "onreset", 
    "onresize", 
    "onscroll", 
    "onsearch", 
    "onselect", 
    "onsubmit", 
    "onunload", 
    "open", 
    "outerHeight", 
    "outerWidth", 
    "pageXOffset", 
    "pageYOffset", 
    "personalbar", 
    "plugins",
    "print", 
    "prompt", 
    "releaseEvents", 
    "removeEventListener", 
    "resizeBy", 
    "resizeTo", 
    "screen", 
    "screenLeft", 
    "screenTop", 
    "screenX", 
    "screenY", 
    "scroll", 
    "scrollBy", 
    "scrollTo", 
    "scrollX", 
    "scrollY", 
    "scrollbars", 
    "setInterval", 
    "setTimeout", 
    "showModalDialog", 
    "status", 
    "statusbar", 
    "stop", 
    "toolbar"
];

var windowPropertiesAllowed = [
    "blur",
    "close",
    "closed",
    "focus",
    "frames",
    "history",
    "length",
    "opener",
    "parent",
    "self",
    "top",
    "window",
];

window.targetWindow = frames[0];

window.onload = function()
{
    if (window.layoutTestController) {
        layoutTestController.dumpAsText();
        layoutTestController.suppressConsoleMessages();
    }
        
    log("\n----- tests for getting/setting vanilla properties -----\n");
    
    for (var i = 0; i < windowPropertiesAllowed.length; i++) { //>
        var property = windowPropertiesAllowed[i];
        shouldBeTrue("canGet('targetWindow." + property + "')");
    }

    for (var i = 0; i < windowPropertiesNotAllowed.length; i++) { //>
        var property = windowPropertiesNotAllowed[i];
        if (property == "document")
            log("Firefox allows access to 'document' but throws an exception when you access its properties.");
        shouldBeFalse("canGet('targetWindow." + property + "')");
        shouldBeFalse("canSet('targetWindow." + property + "')");
    }

    log("\n----- tests for getting/setting interesting properties -----\n");
    
    // built-in property
    shouldBeFalse("canGet('targetWindow.Object')");
    shouldBeFalse("canSet('targetWindow.Object')");

    // pre-existing custom property
    shouldBeFalse("canGet('targetWindow.existingCustomProperty')");
    shouldBeFalse("canSet('targetWindow.existingCustomProperty')");

    // new custom property
    shouldBeFalse("canSet('targetWindow.newCustomProperty')");

    // built-in prototype property
    shouldBeFalse("canGet('targetWindow.hasOwnProperty')");
    shouldBeFalse("canSet('targetWindow.hasOwnProperty')");

    // custom prototype property
    shouldBeFalse("canGet('targetWindow.prototypeCustomProperty')");
    shouldBeFalse("canSet('targetWindow.prototypeCustomProperty')");
    
    // window object itself
    shouldBeFalse("canGet('targetWindow.toString')");
    shouldBeFalse("canSet('targetWindow.toString')");
    log("FIXME: Firefox allows converting a window to string -- maybe WebKit should, too.");
    shouldBe("toString('targetWindow', '')", "''");

    // frame by name
    shouldBeTrue("canGet('targetWindow.testiframe')");
    
    // element by name
    shouldBeFalse("canGet('targetWindow.testimage')");

    // frames array
    shouldBe("targetWindow.frames.length", 1);
    shouldBeTrue("canGet('targetWindow.frames[0]')");
    shouldBeTrue("canGet('targetWindow[0]')");

    shouldBeTrue("canGet('targetWindow.location')");
    shouldBe("toString('targetWindow.location', '')", "''");

    log("Firefox allows access to 'location.toString' but throws an exception when you call it.");
    shouldBeFalse("canGet('targetWindow.location.toString')");
    shouldBeFalse("canSet('targetWindow.location.toString')");

    shouldBeFalse("canGet('targetWindow.location.href')");
    shouldBeFalse("canGet('targetWindow.location.hash')");
    shouldBeFalse("canGet('targetWindow.location.host')");
    shouldBeFalse("canGet('targetWindow.location.hostname')");
    shouldBeFalse("canGet('targetWindow.location.pathname')");
    shouldBeFalse("canGet('targetWindow.location.port')");
    shouldBeFalse("canGet('targetWindow.location.protocol')");
    shouldBeFalse("canGet('targetWindow.location.search')");

    // FIXME -- not sure these settable tests actually test anything (because you can't read the results)
    shouldBeFalse("canSet('targetWindow.location')");
    shouldBeFalse("canSet('targetWindow.location.href')");
    shouldBeFalse("canSet('targetWindow.location.hash')");
    shouldBeFalse("canSet('targetWindow.location.host')");
    shouldBeFalse("canSet('targetWindow.location.hostname')");
    shouldBeFalse("canSet('targetWindow.location.pathname')");
    shouldBeFalse("canSet('targetWindow.location.port')");
    shouldBeFalse("canSet('targetWindow.location.protocol')");
    shouldBeFalse("canSet('targetWindow.location.search')");

    shouldBeTrue("canGet('targetWindow.location.assign')");
    shouldBeTrue("canGet('targetWindow.location.reload')");
    shouldBeTrue("canGet('targetWindow.location.replace')");

    log("Firefox allows calling the 'location' functions exception, bizzarely, 'assign'");
    shouldBeTrue("canCall('targetWindow.location.assign', 'data:text/html,<p>in ur location object</p>')");
    shouldBeTrue("canCall('targetWindow.location.reload')");
    shouldBeTrue("canCall('targetWindow.location.replace', 'data:text/html,<p>in ur location object</p>')");

    // history object
    log("Firefox prohibits getting 'history.length' but that seems unnecessarily strict since you're allowed to use the 'history' object.");
    shouldBeTrue("canGet('targetWindow.history.length')");

    shouldBeTrue("canGet('targetWindow.history.back')");
    shouldBeTrue("canGet('targetWindow.history.forward')");
    shouldBeTrue("canGet('targetWindow.history.go')");
    shouldBeTrue("canCall('targetWindow.history.back')");
    shouldBeTrue("canCall('targetWindow.history.forward')");
    shouldBeTrue("canCall('targetWindow.history.go', '-1')");

    shouldBeTrue("canGet('targetWindow.history.toString')");
    shouldBe("toString('targetWindow.history')", "'[object History]'");

    // Work around DRT bug that causes subsequent tests to fail.
    window.stop();
    frames[0].stop();
}
</script>
