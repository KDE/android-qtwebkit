<html>
<head>
<link rel="stylesheet" href="../../fast/js/resources/js-test-style.css">
<script src="../../fast/js/resources/js-test-pre.js"></script>
<script src="../../fast/js/resources/js-test-post-function.js"></script>
<script src="resources/shared.js"></script>
</head>
<body>
<p id="description"></p>
<div id="console"></div>
<script>

description("Test IndexedDB's KeyRange.");
if (window.layoutTestController)
    layoutTestController.waitUntilDone();

function checkSingleKeyRange(value)
{
    keyRange = evalAndLog("webkitIDBKeyRange.only(" + value + ")");
    shouldBe("keyRange.left", "" + value);
    shouldBe("keyRange.right", "" + value);
    shouldBe("keyRange.flags", "keyRange.SINGLE");
}

function checkLeftBoundKeyRange(value, open)
{
    keyRange = evalAndLog("webkitIDBKeyRange.leftBound(" + value + "," + open + ")");
    shouldBe("keyRange.left", "" + value);
    shouldBeNull("keyRange.right");
    shouldBe("keyRange.flags", open ? "keyRange.LEFT_OPEN | keyRange.LEFT_BOUND" : "keyRange.LEFT_BOUND");
}

function checkRightBoundKeyRange(value, open)
{
    keyRange = evalAndLog("webkitIDBKeyRange.rightBound(" + value + "," + open + ")");
    shouldBe("keyRange.right", "" + value);
    shouldBeNull("keyRange.left");
    shouldBe("keyRange.flags", open ? "keyRange.RIGHT_OPEN | keyRange.RIGHT_BOUND" : "keyRange.RIGHT_BOUND");
}

function checkBoundKeyRange(left, right, openLeft, openRight)
{
    keyRange = evalAndLog("webkitIDBKeyRange.bound(" + left + "," + right + "," + openLeft + "," + openRight + ")");
    shouldBe("keyRange.left", "" + left);
    shouldBe("keyRange.right", "" + right);
    leftFlags = keyRange.flags & (keyRange.LEFT_OPEN | keyRange.LEFT_BOUND);
    shouldBe("leftFlags", openLeft ? "keyRange.LEFT_OPEN | keyRange.LEFT_BOUND" : "keyRange.LEFT_BOUND");
    rightFlags = keyRange.flags & (keyRange.RIGHT_OPEN | keyRange.RIGHT_BOUND);
    shouldBe("rightFlags", openRight ? "keyRange.RIGHT_OPEN | keyRange.RIGHT_BOUND" : "keyRange.RIGHT_BOUND");
}

function test()
{
    shouldBeTrue("'SINGLE' in webkitIDBKeyRange");
    shouldBeTrue("'LEFT_OPEN' in webkitIDBKeyRange");
    shouldBeTrue("'RIGHT_OPEN' in webkitIDBKeyRange");
    shouldBeTrue("'LEFT_BOUND' in webkitIDBKeyRange");
    shouldBeTrue("'RIGHT_BOUND' in webkitIDBKeyRange");
    shouldBeFalse("'left' in webkitIDBKeyRange");
    shouldBeFalse("'right' in webkitIDBKeyRange");
    shouldBeFalse("'flags' in webkitIDBKeyRange");
    shouldBeTrue("'only' in webkitIDBKeyRange");
    shouldBeTrue("'leftBound' in webkitIDBKeyRange");
    shouldBeTrue("'rightBound' in webkitIDBKeyRange");
    shouldBeTrue("'bound' in webkitIDBKeyRange");

    debug("");

    var instance = evalAndLog("instance = webkitIDBKeyRange.only(1)");
    shouldBeTrue("'SINGLE' in instance");
    shouldBeTrue("'LEFT_OPEN' in instance");
    shouldBeTrue("'RIGHT_OPEN' in instance");
    shouldBeTrue("'LEFT_BOUND' in instance");
    shouldBeTrue("'RIGHT_BOUND' in instance");
    shouldBeTrue("'left' in instance");
    shouldBeTrue("'right' in instance");
    shouldBeTrue("'flags' in instance");
    shouldBeFalse("'only' in instance");
    shouldBeFalse("'leftBound' in instance");
    shouldBeFalse("'rightBound' in instance");
    shouldBeFalse("'bound' in instance");

    debug("");

    checkSingleKeyRange(1);
    checkSingleKeyRange("'a'");

    checkLeftBoundKeyRange(10, true);
    checkLeftBoundKeyRange(11, false);
    checkLeftBoundKeyRange(12);
    checkLeftBoundKeyRange("'aa'", true);
    checkLeftBoundKeyRange("'ab'", false);
    checkLeftBoundKeyRange("'ac'");

    checkRightBoundKeyRange(20, true);
    checkRightBoundKeyRange(21, false);
    checkRightBoundKeyRange(22);
    checkRightBoundKeyRange("'ba'", true);
    checkRightBoundKeyRange("'bb'", false);
    checkRightBoundKeyRange("'bc'");

    checkBoundKeyRange(30, 40);
    checkBoundKeyRange(31, 41, false, false);
    checkBoundKeyRange(32, 42, false, true);
    checkBoundKeyRange(33, 43, true, false);
    checkBoundKeyRange(34, 44, true, true);

    checkBoundKeyRange("'aaa'", "'aba'", false, false);
    checkBoundKeyRange("'aab'", "'abb'");
    checkBoundKeyRange("'aac'", "'abc'", false, false);
    checkBoundKeyRange("'aad'", "'abd'", false, true);
    checkBoundKeyRange("'aae'", "'abe'", true, false);
    checkBoundKeyRange("'aaf'", "'abf'", true, true);

    try {
        debug("Passing an invalid key into only([])");
        webkitIDBKeyRange.only([]);
        testFailed("No exception thrown");
    } catch (e) {
        testPassed("Caught exception: " + e.toString());
    }

    try {
        debug("Passing an invalid key into rightBound([])");
        webkitIDBKeyRange.rightBound([]);
        testFailed("No exception thrown");
    } catch (e) {
        testPassed("Caught exception: " + e.toString());
    }
 
    try {
        debug("Passing an invalid key into leftBound([])");
        webkitIDBKeyRange.leftBound([]);
        testFailed("No exception thrown");
    } catch (e) {
        testPassed("Caught exception: " + e.toString());
    }

    try {
        debug("Passing an invalid key into bound(null, [])");
        webkitIDBKeyRange.bound(null, []);
        testFailed("No exception thrown");
    } catch (e) {
        testPassed("Caught exception: " + e.toString());
    }

    try {
        debug("Passing an invalid key into bound([],null)");
        webkitIDBKeyRange.bound([], null);
        testFailed("No exception thrown");
    } catch (e) {
        testPassed("Caught exception: " + e.toString());
    }

    try {
        debug("Passing an invalid key into bound([], [])");
        webkitIDBKeyRange.bound([], []);
        testFailed("No exception thrown");
    } catch (e) {
        testPassed("Caught exception: " + e.toString());
    }
}

test();

var successfullyParsed = true;
done();

</script>
</body>
</html>
