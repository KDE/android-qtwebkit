<html>
<head>
<script src="../http/tests/inspector/inspector-test2.js"></script>
<script src="../http/tests/inspector/debugger-test2.js"></script>
<script>

function appendElement(parentId, childId)
{
    var child = document.createElement("div");
    child.id = childId;
    document.getElementById(parentId).appendChild(child);
}

function modifyAttribute(elementId, name, value)
{
    var element = document.getElementById(elementId);
    element.setAttribute(name, value);
}

function removeElement(elementId)
{
    var element = document.getElementById(elementId);
    element.parentNode.removeChild(element);
}

var test = function()
{
    InspectorTest.startDebuggerTest(step1);

    function step1()
    {
        findDOMNodeById("d0", step2);
    }

    function step2(node)
    {
        InspectorTest.addResult("Found dom node d0.");
        WebInspector.domBreakpointManager.setBreakpoint(node, WebInspector.DOMBreakpoint.Types.SubtreeModified);
        InspectorTest.addResult("Set subtree modified DOM breakpoint on d0.");
        InspectorTest.evaluateInConsole("appendElement('d0', 'd1')");
        InspectorTest.waitUntilPaused(step3.bind(null, node));
    }

    function step3(node, callFrames)
    {
        InspectorTest.addResult("line: " + callFrames[0].line + ", function: " + callFrames[0].functionName);
        WebInspector.domBreakpointManager.removeBreakpointsForNode(node);
        InspectorTest.resumeExecution(findDOMNodeById.bind(null, "d1", step4));
    }

    function step4(node)
    {
        InspectorTest.addResult("Found dom node d1.");
        WebInspector.domBreakpointManager.setBreakpoint(node, WebInspector.DOMBreakpoint.Types.AttributeModified);
        InspectorTest.addResult("Set attribute modified DOM breakpoint on d1.");
        InspectorTest.evaluateInConsole("modifyAttribute('d1', 'className', 'foo')");
        InspectorTest.waitUntilPaused(step5.bind(null, node));
    }

    function step5(node, callFrames)
    {
        InspectorTest.addResult("line: " + callFrames[0].line + ", function: " + callFrames[0].functionName);
        WebInspector.domBreakpointManager.removeBreakpointsForNode(node);
        InspectorTest.resumeExecution(findDOMNodeById.bind(null, "d1", step6));
    }

    function step6(node)
    {
        InspectorTest.addResult("Found dom node d1.");
        WebInspector.domBreakpointManager.setBreakpoint(node, WebInspector.DOMBreakpoint.Types.NodeRemoved);
        InspectorTest.addResult("Set node removed DOM breakpoint on d1.");
        InspectorTest.evaluateInConsole("removeElement('d1')");
        InspectorTest.waitUntilPaused(step7.bind(null, node));
    }

    function step7(node, callFrames)
    {
        InspectorTest.addResult("line: " + callFrames[0].line + ", function: " + callFrames[0].functionName);
        WebInspector.domBreakpointManager.removeBreakpointsForNode(node);
        InspectorTest.completeDebuggerTest();
    }

    function findDOMNodeById(id, callback)
    {
        InspectorTest.findDOMNode(null, function(node) {
            return node.getAttribute("id") === id;
        }, callback);
    }
};

</script>
</head>

<body onload="runTest()">
<p>
Tests DOM breakpoints. <a href="https://bugs.webkit.org/show_bug.cgi?id=42886">Bug 42886</a>
</p>
<div id="d0"></div>
</body>
</html>

