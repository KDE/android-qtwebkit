<html>
<head>
  <script src="../http/tests/inspector/inspector-test2.js"></script>
<script>

function fib(n) {
    return n < 2 ? 1 : fib(n - 1) + fib(n - 2);
}

function eternal_fib() {
    console.profile();  // Make sure we capture the current callstack.
    for (var i = 0; i < 50; ++i) {
        fib(20);
    }
    console.profileEnd();
}

function run()
{
    eternal_fib();
    runTest();
}

function initialize_ProfilerTests()
{
    InspectorTest.findDisplayedNode = function() {
        var panel = WebInspector.panels.profiles; 
        var tree = panel.visibleView.profileDataGridTree;
        if (!tree) {
            window.setTimeout(InspectorTest.findDisplayedNode, 100);
            return;
        }
        var node = tree.children[0];
        if (!node) {
            // Profile hadn't been queried yet, re-schedule.
            window.setTimeout(InspectorTest.findDisplayedNode, 100);
            return;
        }

        // Iterate over displayed functions and search for a function
        // that is called "fib" or "eternal_fib". If found, this will mean
        // that we actually have profiled page's code.
        while (node) {
            if (node.functionName.indexOf("fib") !== -1) {
                InspectorTest.addResult("found fib");
                break;
            }
            node = node.traverseNextNode(true, null, true);
        }

        InspectorTest.completeTest();
    }

    InspectorTest.findVisibleView = function() {
        var panel = WebInspector.panels.profiles; 
        if (!panel.visibleView) {
            setTimeout(InspectorTest.findVisibleView, 0);
            return;
        }
        setTimeout(InspectorTest.findDisplayedNode, 0);
    }
}

function test()
{
    WebInspector.showPanel("profiles");
    InspectorTest.findVisibleView();
}

</script>
</head>
<body onload="run()">
<p>
Tests that CPU profiling works.
</p>
</body>
</html>
