<html>
<head>
    <script src="../js/resources/js-test-pre.js"></script>
</head>
<body onload="runTest()">
  
<image id="dragSource" src="resources/abe.png" width="76" height="103"
       ondragstart="dragStart(event)" ondrag="drag(event)" ondragend="dragEnd(event)">
<div id="dragTarget" style="width: 100px; height: 100px; border: 1px solid gray;"
        ondragenter="dragEnter(event)" ondragover="dragOver(event)"
        ondragleave="dragLeave(event)" ondrop="drop(event)">
</div>

<p>This automated layout test checks that effectAllowed and dropEffect are set properly in drag
   callbacks.<br>
   If you're running this in a browser, you can simulate part of it by dragging Abe onto the box.</p>
<div id="console"></div>

<script>

function assert(result, what)
{
    if (!result)
        testFailed("Expected that " + what);
    else
        testPassed(what);
}

function assertEqual(test, expected, what, quiet)
{
    if (test !== expected)
        testFailed(what + " = '" + test + "' ... expected '" + expected + "'");
    else if (!quiet)
         testPassed(what + " = '" + test + "'");
}


var dragStartCalled = 0, dragCalled = 0, dragEndCalled = 0;
var dragEnterCalled = 0, dragOverCalled = 0, dragLeaveCalled = 0, dropCalled = 0;

var effectAllowedToSet = "copyMove";
var defaultDropEffect = "copy";
var dropEffectToSet = "move";
var expectedDropEffect = "move";


// DRAG SOURCE EVENT HANDLERS:
function dragStart(event)
{
    dragStartCalled++;
    assertEqual(event.dataTransfer.effectAllowed, "uninitialized", "effectAllowed in dragStart");
    assertEqual(event.dataTransfer.dropEffect, "none", "dropEffect in dragStart");
    event.dataTransfer.effectAllowed = effectAllowedToSet;
}

function drag(event)
{
    dragCalled++;
    assertEqual(event.dataTransfer.effectAllowed, effectAllowedToSet, "effectAllowed in drag", true);
    assertEqual(event.dataTransfer.dropEffect,
                dragLeaveCalled < dragEnterCalled ?expectedDropEffect :"none", 
                "dropEffect in drag",
                true);
}

function dragEnd(event)
{
    dragEndCalled++;
    assertEqual(event.dataTransfer.effectAllowed, effectAllowedToSet, "effectAllowed in dragEnd");
    assertEqual(event.dataTransfer.dropEffect, 
                dragLeaveCalled < dragEnterCalled ? expectedDropEffect : "none",
                "dropEffect in dragEnd");
}


// DRAG DESTINATION EVENT HANDLERS:
function dragEnter(event)
{
    dragEnterCalled++;
    assertEqual(event.dataTransfer.effectAllowed, effectAllowedToSet, "effectAllowed in dragEnter");
    assertEqual(event.dataTransfer.dropEffect, defaultDropEffect, "dropEffect in dragEnter");
    event.dataTransfer.dropEffect = dropEffectToSet;
    event.preventDefault();
}

function dragOver(event)
{
    dragOverCalled++;
    assertEqual(event.dataTransfer.effectAllowed, effectAllowedToSet, "effectAllowed in dragOver", true);
    assertEqual(event.dataTransfer.dropEffect, defaultDropEffect, "dropEffect in dragOver", true);
    event.dataTransfer.dropEffect = dropEffectToSet;
    event.preventDefault();
}

function dragLeave(event)
{
    dragLeaveCalled++;
    assertEqual(event.dataTransfer.effectAllowed, effectAllowedToSet, "effectAllowed in dragLeave");
    assertEqual(event.dataTransfer.dropEffect, "none", "dropEffect in dragLeave");
    event.preventDefault();
}

function drop(event)
{
    dropCalled++;
    assertEqual(event.dataTransfer.effectAllowed, effectAllowedToSet, "effectAllowed in drop");
    assertEqual(event.dataTransfer.dropEffect, expectedDropEffect, "dropEffect in drop");
    event.preventDefault();
}


function performDrag(srcId, dstId)
{
    function moveMouseToCenterOf(id)
    {
        var element = document.getElementById(id);
        var x = element.offsetLeft + element.offsetWidth / 2;
        var y = element.offsetTop + element.offsetHeight / 2;
        eventSender.mouseMoveTo(x, y);
    }
    
    dragStartCalled = dragCalled = dragEndCalled = 0;
    dragEnterCalled = dragOverCalled = dragLeaveCalled = dropCalled = 0;
    
    moveMouseToCenterOf(srcId);
    eventSender.mouseDown();
    moveMouseToCenterOf(dstId);
    eventSender.mouseUp();
}

function runTest()
{
    if (!window.layoutTestController)
        return;
    try {
      
      debug("*** Testing a successful drag...");
      effectAllowedToSet = "copyMove";
      defaultDropEffect = "copy";
      dropEffectToSet = "move";
      expectedDropEffect = "move";
      performDrag('dragSource', 'dragTarget');
      
      assertEqual(dragStartCalled, 1, "calls to dragStart");
      // Whether drag is called depends on timing. In a real-life drag it will be called, but
      // with the artificial mouse events generated by the test controller, it may not be.
      // So I've removed the assertion that dragCalled > 0.
      assertEqual(dragEndCalled, 1, "calls to dragEnd");
      assertEqual(dragEnterCalled, 1, "calls to dragEnter");
      // dragOver won't necessarily be called if there was only one mouse event over
      // the drop target, as in performDrag.
      // dragLeave isn't called because the drag never exits the drop target.
      assertEqual(dropCalled, 1, "calls to drop");

      debug("*** Testing a failed drag...");
      effectAllowedToSet = "link";
      defaultDropEffect = "link";
      dropEffectToSet = "move";
      expectedDropEffect = "none";
      performDrag('dragSource', 'dragTarget');
      
      assertEqual(dragStartCalled, 1, "calls to dragStart");
      // As described above, drag might not be called, under test conditions, so don't check dragCalled.
      assertEqual(dragEndCalled, 1, "calls to dragEnd");
      assertEqual(dragEnterCalled, 1, "calls to dragEnter");
      assertEqual(dropCalled, 0, "calls to drop");
      
      // Finally run the post-test function:
      isSuccessfullyParsed();

    } catch (x) {
      debug("FAILED by throwing " + x);
    }
    // OK, now DRT can quit.
    layoutTestController.notifyDone();
}

// Tell DRT not to quit immediately, because the actual runTest() function won't be called
// until the onload event is sent (otherwise the fake drag stuff crashes: bug 29101.)
layoutTestController.waitUntilDone();

var successfullyParsed = true;
</script>

<script src="../js/resources/js-test-post-function.js"></script>

</body>
</html>
