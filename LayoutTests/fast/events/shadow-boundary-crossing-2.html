<html>
<head>
<script>

var logDiv;

function log(msg, success)
{
    logDiv.appendChild(document.createElement('div')).textContent = msg + ': ' + (success ? 'PASS' : 'FAIL');
}

function clickOn(element)
{
    if (!window.eventSender)
        return;

    var x = element.offsetLeft + element.offsetWidth / 2;
    var y = element.offsetTop + element.offsetHeight / 2;
    eventSender.mouseMoveTo(x, y);
    eventSender.mouseDown();
    eventSender.mouseUp();
}

var tests = {
    mutationEventPropagation: function()
    {
        var textarea = document.body.appendChild(document.createElement('textarea'));
        var mutationEventFired;
        textarea.addEventListener('DOMSubtreeModified', function(e)
        {
            mutationEventFired = true;
        }, false);
        textarea.value = 'test';
        // Trigger style recalc and sadly, the actual mutation of the textarea shadow DOM.
        textarea.offsetHeight;
        log('Mutation events should not propagate out of the shadow DOM', !mutationEventFired);
        textarea.parentNode.removeChild(textarea);
    },
    eventInProgress: function()
    {
        var textInput = document.body.appendChild(document.createElement('input'));
        textInput.addEventListener('click', function(e)
        {
            log('Other events should be retargeted', e.target == textInput);
        }, false);
        clickOn(textInput);
        textInput.parentNode.removeChild(textInput);
    },
    finalEventObject: function()
    {
        var textInput = document.body.appendChild(document.createElement('input'));
        var storedEvent;
        textInput.addEventListener('click', function(e)
        {
            storedEvent = e;
        }, false);
        clickOn(textInput);
        log('After event dispatch, the event object should not reveal shadow DOM', storedEvent && storedEvent.target == textInput);
        textInput.parentNode.removeChild(textInput);
    }
};

function runTest()
{
    if (window.layoutTestController)
        layoutTestController.dumpAsText();

    logDiv = document.getElementById('log');
    for(var testName in tests) {
        tests[testName]();
    }
}

</script>
</head>
<body onload="runTest()">
    <p>Tests to ensure that shadow DOM boundary is not crossed during event propagation. Can only run within DRT.
    <p>See <a href="https://bugs.webkit.org/show_bug.cgi?id=46015">bug 46015</a> for details.
    <div id="log"></div>
</body>
</html>