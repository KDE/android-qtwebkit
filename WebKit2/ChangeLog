2010-06-24  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Fix for https://bugs.webkit.org/show_bug.cgi?id=41168
        <rdar://problem/8124605>
        Webkit2: Add WKPageReloadFromOrigin() to match old-WebKit functionality

        * UIProcess/API/C/WKPage.cpp:
        (WKPageReload):
        (WKPageReloadFromOrigin):
        * UIProcess/API/C/WKPage.h:
        * UIProcess/WebPageProxy.cpp:
        (WebKit::WebPageProxy::reload):
        * UIProcess/WebPageProxy.h:
        * WebProcess/WebPage/WebPage.cpp:
        (WebKit::WebPage::reload):
        (WebKit::WebPage::didReceiveMessage):
        * WebProcess/WebPage/WebPage.h:

2010-06-24  Adam Roben  <aroben@apple.com>

        Windows build fix

        Fixes <http://webkit.org/b/41158>.

        Reviewed by Anders Carlsson.

        * Shared/win/UpdateChunk.cpp: Updated header name.

        * UIProcess/Plugins/win/PluginInfoStoreWin.cpp: Added.
        (WebKit::PluginInfoStore::pluginDirectories):
        (WebKit::PluginInfoStore::pluginPathsInDirectory):
        (WebKit::PluginInfoStore::getPluginInfo):
        (WebKit::PluginInfoStore::shouldUsePlugin):
        Stubbed these out.

        * win/WebKit2.vcproj: Added UIProcess/Plugins to the include path for
        all configurations. Added UIProcess/Plugins files to the project.

2010-06-23  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Have the UI process compute the plug-in data
        https://bugs.webkit.org/show_bug.cgi?id=41118

        * Shared/CoreIPCSupport/WebProcessProxyMessageKinds.h:
        (WebProcessProxyMessage::):
        Add GetPlugin message kind.

        * Shared/WebCoreArgumentCoders.h:
        Add argument coders for PluginInfo and MimeClassInfo.
        
        * UIProcess/Plugins/mac/PluginInfoStoreMac.mm:
        (WebKit::safeCreateCFString):
        (WebKit::PluginInfoStore::pluginPathsInDirectory):
        (WebKit::PluginInfoStore::getPluginInfo):
        Use safeCreateCFString.
        
        * UIProcess/WebProcessProxy.cpp:
        (WebKit::WebProcessProxy::getPlugins):
        Ask the plug-in info store for the plug-in list.

        (WebKit::WebProcessProxy::didReceiveSyncMessage):
        Handle GetPlugins.

        * UIProcess/WebProcessProxy.h:
        * WebProcess/WebCoreSupport/WebFrameLoaderClient.cpp:
        (WebKit::WebFrameLoaderClient::objectContentType):
        Implement.

        * WebProcess/WebCoreSupport/WebPlatformStrategies.cpp:
        (WebKit::WebPlatformStrategies::populatePluginCache):
        Send a sync GetPlugins message.

2010-06-23  Anders Carlsson  <andersca@apple.com>

        Reviewed by Dan Bernstein.

        Add ArgumentCoder for vectors.

        * Platform/CoreIPC/ArgumentCoders.h:
        (CoreIPC::):

2010-06-23  Anders Carlsson  <andersca@apple.com>

        Reviewed by Dan Bernstein.

        Rename WebCoreTypeArgumentMarshalling.h to WebCoreArgumentCoders.h

        * Shared/WebCoreArgumentCoders.h: Copied from Shared/WebCoreTypeArgumentMarshalling.h.
        * Shared/WebCoreTypeArgumentMarshalling.h: Removed.
        * Shared/WebEvent.h:
        * Shared/WebNavigationDataStore.h:
        * Shared/WebPreferencesStore.h:
        * Shared/mac/UpdateChunk.cpp:
        * UIProcess/ChunkedUpdateDrawingAreaProxy.cpp:
        * UIProcess/WebContext.cpp:
        * UIProcess/WebPageProxy.cpp:
        * WebKit2.xcodeproj/project.pbxproj:
        * WebProcess/InjectedBundle/InjectedBundle.cpp:
        * WebProcess/WebCoreSupport/WebChromeClient.cpp:
        * WebProcess/WebCoreSupport/WebFrameLoaderClient.cpp:
        * WebProcess/WebPage/ChunkedUpdateDrawingArea.cpp:
        * WebProcess/WebPage/WebPage.cpp:
        * WebProcess/WebProcess.cpp:

2010-06-23  Anders Carlsson  <andersca@apple.com>

        Reviewed by Dan Bernstein.

        MessageIDs should always have the most significant bit zeroed out
        https://bugs.webkit.org/show_bug.cgi?id=41112

        The most significant bit is used by the Mac implementation of CoreIPC, and
        should always be zero in MessageID objects.

        * Platform/CoreIPC/Connection.cpp:
        (CoreIPC::Connection::waitForMessage):
        * Platform/CoreIPC/MessageID.h:
        (CoreIPC::MessageID::):
        (CoreIPC::MessageID::MessageID):
        (CoreIPC::MessageID::operator==):
        (CoreIPC::MessageID::fromInt):
        (CoreIPC::MessageID::isSync):
        (CoreIPC::MessageID::stripMostSignificantBit):
        * Platform/CoreIPC/mac/ConnectionMac.cpp:
        (CoreIPC::Connection::sendOutgoingMessage):
        (CoreIPC::createArgumentDecoder):

2010-06-23  John Sullivan  <sullivan@apple.com>

        Rubber-stamped by Anders Carlsson.

        * mac/WebKit2.exp:
        Added yet another symbol needed by Mac clients.

2010-06-23  John Sullivan  <sullivan@apple.com>

        Rubber-stamped by Anders Carlsson.

        * mac/WebKit2.exp:
        Added another symbol needed by Mac clients.

2010-06-23  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Rename SimpleArgumentCoder.h to ArgumentCoders.h

        * Platform/CoreIPC/ArgumentCoders.h: Copied from Platform/CoreIPC/SimpleArgumentCoder.h.
        * Platform/CoreIPC/SimpleArgumentCoder.h: Removed.
        * Shared/WebCoreTypeArgumentMarshalling.h:
        * WebKit2.xcodeproj/project.pbxproj:

2010-06-23  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Add a plug-in info cache to WebPlatformStrategies
        https://bugs.webkit.org/show_bug.cgi?id=41087

        This is in preparation for proxying the getPlugins call over to the UI process.

        * WebProcess/WebCoreSupport/WebPlatformStrategies.cpp:
        (WebKit::WebPlatformStrategies::WebPlatformStrategies):
        (WebKit::WebPlatformStrategies::populatePluginCache):
        (WebKit::WebPlatformStrategies::refreshPlugins):
        (WebKit::WebPlatformStrategies::getPluginInfo):
        * WebProcess/WebCoreSupport/WebPlatformStrategies.h:

2010-06-23  Sam Weinig  <sam@webkit.org>

        Reviewed by John Sullivan.

        Stop silently ignoring crashes.

        * WebProcess/Launching/mac/WebProcessMain.mm:

2010-06-23  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Add missing include to WKRetainPtr.

        * UIProcess/API/cpp/WKRetainPtr.h:

2010-06-23  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Fix for https://bugs.webkit.org/show_bug.cgi?id=41073
        WebKit2: Flesh out more of the InjectedBundle client API

        * WebProcess/InjectedBundle/API/c/WKBundle.h:
        * WebProcess/InjectedBundle/API/c/WKBundlePage.h:
        * WebProcess/InjectedBundle/InjectedBundle.cpp:
        (WebKit::InjectedBundle::willDestroyPage):
        * WebProcess/InjectedBundle/InjectedBundle.h:
        * WebProcess/InjectedBundle/InjectedBundlePageClient.cpp:
        (WebKit::InjectedBundlePageClient::didStartProvisionalLoadForFrame):
        (WebKit::InjectedBundlePageClient::didReceiveServerRedirectForProvisionalLoadForFrame):
        (WebKit::InjectedBundlePageClient::didFailProvisionalLoadWithErrorForFrame):
        (WebKit::InjectedBundlePageClient::didCommitLoadForFrame):
        (WebKit::InjectedBundlePageClient::didFinishLoadForFrame):
        (WebKit::InjectedBundlePageClient::didFailLoadWithErrorForFrame):
        (WebKit::InjectedBundlePageClient::didReceiveTitleForFrame):
        * WebProcess/InjectedBundle/InjectedBundlePageClient.h:
        * WebProcess/InjectedBundle/mac/InjectedBundleMac.cpp:
        (WebKit::InjectedBundle::load): Add some error logging on failure to load the bundle.
        * WebProcess/WebCoreSupport/WebFrameLoaderClient.cpp:
        (WebKit::WebFrameLoaderClient::dispatchDidReceiveServerRedirectForProvisionalLoad):
        (WebKit::WebFrameLoaderClient::dispatchDidStartProvisionalLoad):
        (WebKit::WebFrameLoaderClient::dispatchDidReceiveTitle):
        (WebKit::WebFrameLoaderClient::dispatchDidCommitLoad):
        (WebKit::WebFrameLoaderClient::dispatchDidFailProvisionalLoad):
        (WebKit::WebFrameLoaderClient::dispatchDidFailLoad):
        (WebKit::WebFrameLoaderClient::dispatchDidFinishLoad):
        * WebProcess/WebPage/WebPage.cpp:
        (WebKit::WebPage::close):
        * mac/WebKit2.exp:

2010-06-22  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Add a SimpleArgumentCoder class template that works on POD types
        https://bugs.webkit.org/show_bug.cgi?id=41023

        * Platform/CoreIPC/SimpleArgumentCoder.h: Added.
        (CoreIPC::SimpleArgumentCoder::encode):
        (CoreIPC::SimpleArgumentCoder::decode):
        * Shared/WebCoreTypeArgumentMarshalling.h:
        (CoreIPC::):
        * WebKit2.xcodeproj/project.pbxproj:

2010-06-22  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Use the ArgumentCoder class template for decoding
        https://bugs.webkit.org/show_bug.cgi?id=41021

        * Platform/CoreIPC/ArgumentCoder.h:
        (CoreIPC::ArgumentCoder::decode):
        * Platform/CoreIPC/ArgumentDecoder.h:
        (CoreIPC::ArgumentDecoder::decode):
        * Shared/WebCoreTypeArgumentMarshalling.h:
        (CoreIPC::):

2010-06-22  Anders Carlsson  <andersca@apple.com>

        Reviewed by Dan Bernstein.

        Change the encode functions to be specializations of a class template
        https://bugs.webkit.org/show_bug.cgi?id=41015

        * Platform/CoreIPC/ArgumentCoder.h: Added.
        (CoreIPC::ArgumentCoder::encode):
        * Platform/CoreIPC/ArgumentEncoder.h:
        (CoreIPC::ArgumentEncoder::encode):
        * Shared/WebCoreTypeArgumentMarshalling.h:
        (CoreIPC::):
        * WebKit2.xcodeproj/project.pbxproj:

2010-06-22  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Implement PluginInfoStore::shouldUsePlugin.

        * UIProcess/Plugins/PluginInfoStore.h:
        * UIProcess/Plugins/mac/PluginInfoStoreMac.mm:
        (WebKit::PluginInfoStore::getPluginInfo):
        (WebKit::PluginInfoStore::shouldUsePlugin):
        * WebKit2.xcodeproj/project.pbxproj:

2010-06-21  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Support reading plug-in info from Carbon resources
        https://bugs.webkit.org/show_bug.cgi?id=40959

        * UIProcess/Plugins/mac/PluginInfoStoreMac.mm:
        (WebKit::ResourceMap::ResourceMap):
        (WebKit::ResourceMap::~ResourceMap):
        (WebKit::ResourceMap::isValid):
        (WebKit::getStringListResource):
        (WebKit::getPluginInfoFromCarbonResources):
        (WebKit::PluginInfoStore::getPluginInfo):

2010-06-21  Anders Carlsson  <andersca@apple.com>

        Build fix.

        * UIProcess/Plugins/mac/PluginInfoStoreMac.mm:
        (WebKit::PluginInfoStore::getPluginInfo):

2010-06-21  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Have PluginInfoStoreMac actually get plug-in info and populate the plug-in list
        https://bugs.webkit.org/show_bug.cgi?id=40957

        * UIProcess/Plugins/PluginInfoStore.cpp:
        (WebKit::PluginInfoStore::loadPluginsIfNecessary):
        (WebKit::PluginInfoStore::loadPluginsInDirectory):
        (WebKit::PluginInfoStore::loadPlugin):
        (WebKit::PluginInfoStore::getPlugins):
        * UIProcess/Plugins/PluginInfoStore.h:
        * UIProcess/Plugins/mac/PluginInfoStoreMac.mm: Added.
        (WebKit::PluginInfoStore::pluginDirectories):
        (WebKit::PluginInfoStore::pluginPathsInDirectory):
        (WebKit::getPluginArchitecture):
        (WebKit::getPluginInfoFromPropertyLists):
        (WebKit::PluginInfoStore::getPluginInfo):
        (WebKit::PluginInfoStore::shouldUsePlugin):
        * WebKit2.xcodeproj/project.pbxproj:

2010-06-21  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Add PluginInfoStore class
        https://bugs.webkit.org/show_bug.cgi?id=40949

        * Shared/WebPreferencesStore.cpp:
        (WebKit::WebPreferencesStore::WebPreferencesStore):
        * Shared/WebPreferencesStore.h:
        (WebKit::WebPreferencesStore::encode):
        (WebKit::WebPreferencesStore::decode):
        Add plugInsEnabled to the preferences store.

        * UIProcess/Plugins: Added.
        * UIProcess/Plugins/PluginInfoStore.cpp: Added.
        (WebKit::PluginInfoStore::shared):
        (WebKit::PluginInfoStore::PluginInfoStore):
        (WebKit::PluginInfoStore::refresh):
        (WebKit::PluginInfoStore::getPlugins):
        * UIProcess/Plugins/PluginInfoStore.h: Added.
        * UIProcess/Plugins/mac: Added.
        * WebKit2.xcodeproj/project.pbxproj:
        * WebProcess/WebCoreSupport/WebPlatformStrategies.cpp:
        (WebKit::WebPlatformStrategies::refreshPlugins):
        (WebKit::WebPlatformStrategies::getPluginInfo):
        * WebProcess/WebPage/WebPage.cpp:
        (WebKit::WebPage::WebPage):

2010-06-21  Simon Fraser  <simon.fraser@apple.com>

        Reviewed by Anders Carlsson.

        Rename DrawingAreaProxyUpdateChunk to ChunkedUpdateDrawingArea
        https://bugs.webkit.org/show_bug.cgi?id=40948

        Rename UIProcess version of DrawingAreaUpdateChunk to ChunkedUpdateDrawingAreaProxy,
        and rename the Mac/Win versions of the various DrawingArea files too.
        
        Also rename the DrawingAreaUpdateChunkType enum to ChunkedUpdateDrawingAreaType.

        * UIProcess/API/mac/WKView.mm:
        (-[WKView initWithFrame:pageNamespaceRef:]):
        * UIProcess/ChunkedUpdateDrawingArea.cpp: Removed.
        * UIProcess/ChunkedUpdateDrawingArea.h: Removed.
        * UIProcess/ChunkedUpdateDrawingAreaProxy.cpp: Added.
        (WebKit::ChunkedUpdateDrawingAreaProxy::ChunkedUpdateDrawingAreaProxy):
        (WebKit::ChunkedUpdateDrawingAreaProxy::~ChunkedUpdateDrawingAreaProxy):
        (WebKit::ChunkedUpdateDrawingAreaProxy::paint):
        (WebKit::ChunkedUpdateDrawingAreaProxy::setSize):
        (WebKit::ChunkedUpdateDrawingAreaProxy::setPageIsVisible):
        (WebKit::ChunkedUpdateDrawingAreaProxy::didSetSize):
        (WebKit::ChunkedUpdateDrawingAreaProxy::update):
        (WebKit::ChunkedUpdateDrawingAreaProxy::didReceiveMessage):
        * UIProcess/ChunkedUpdateDrawingAreaProxy.h: Added.
        (WebKit::ChunkedUpdateDrawingAreaProxy::encode):
        * UIProcess/DrawingAreaProxy.h:
        (WebKit::DrawingAreaProxy::):
        * UIProcess/mac/ChunkedUpdateDrawingAreaProxyMac.mm: Added.
        (WebKit::ChunkedUpdateDrawingAreaProxy::page):
        (WebKit::ChunkedUpdateDrawingAreaProxy::ensureBackingStore):
        (WebKit::ChunkedUpdateDrawingAreaProxy::invalidateBackingStore):
        (WebKit::ChunkedUpdateDrawingAreaProxy::platformPaint):
        (WebKit::ChunkedUpdateDrawingAreaProxy::drawUpdateChunkIntoBackingStore):
        * UIProcess/mac/DrawingAreaProxyUpdateChunkMac.mm: Removed.
        * UIProcess/win/ChunkedUpdateDrawingAreaProxyWin.cpp: Added.
        (WebKit::ChunkedUpdateDrawingAreaProxy::page):
        (WebKit::ChunkedUpdateDrawingAreaProxy::ensureBackingStore):
        (WebKit::ChunkedUpdateDrawingAreaProxy::invalidateBackingStore):
        (WebKit::ChunkedUpdateDrawingAreaProxy::platformPaint):
        (WebKit::ChunkedUpdateDrawingAreaProxy::drawUpdateChunkIntoBackingStore):
        * UIProcess/win/DrawingAreaProxyUpdateChunkWin.cpp: Removed.
        * UIProcess/win/WebView.cpp:
        (WebKit::WebView::WebView):
        * WebKit2.xcodeproj/project.pbxproj:
        * WebProcess/WebPage/ChunkedUpdateDrawingArea.cpp: Added.
        (WebKit::ChunkedUpdateDrawingArea::ChunkedUpdateDrawingArea):
        (WebKit::ChunkedUpdateDrawingArea::~ChunkedUpdateDrawingArea):
        (WebKit::ChunkedUpdateDrawingArea::invalidateWindow):
        (WebKit::ChunkedUpdateDrawingArea::invalidateContentsAndWindow):
        (WebKit::ChunkedUpdateDrawingArea::invalidateContentsForSlowScroll):
        (WebKit::ChunkedUpdateDrawingArea::scroll):
        (WebKit::ChunkedUpdateDrawingArea::setNeedsDisplay):
        (WebKit::ChunkedUpdateDrawingArea::display):
        (WebKit::ChunkedUpdateDrawingArea::scheduleDisplay):
        (WebKit::ChunkedUpdateDrawingArea::setSize):
        (WebKit::ChunkedUpdateDrawingArea::suspendPainting):
        (WebKit::ChunkedUpdateDrawingArea::resumePainting):
        (WebKit::ChunkedUpdateDrawingArea::didUpdate):
        (WebKit::ChunkedUpdateDrawingArea::didReceiveMessage):
        * WebProcess/WebPage/ChunkedUpdateDrawingArea.h: Added.
        * WebProcess/WebPage/DrawingArea.cpp:
        (WebKit::DrawingArea::create):
        * WebProcess/WebPage/DrawingArea.h:
        (WebKit::DrawingArea::):
        * WebProcess/WebPage/DrawingAreaUpdateChunk.cpp: Removed.
        * WebProcess/WebPage/DrawingAreaUpdateChunk.h: Removed.
        * WebProcess/WebPage/mac/ChunkedUpdateDrawingAreaMac.cpp: Added.
        (WebKit::ChunkedUpdateDrawingArea::paintIntoUpdateChunk):
        * WebProcess/WebPage/mac/DrawingAreaUpdateChunkMac.cpp: Removed.
        * WebProcess/WebPage/win/ChunkedUpdateDrawingAreaWin.cpp: Added.
        (WebKit::ChunkedUpdateDrawingArea::paintIntoUpdateChunk):
        * WebProcess/WebPage/win/DrawingAreaUpdateChunkWin.cpp: Removed.
        * win/WebKit2.vcproj:

2010-06-21  Simon Fraser  <simon.fraser@apple.com>

        Reviewed by Anders Carlsson.

        Rename DrawingAreaProxyUpdateChunk to ChunkedUpdateDrawingArea
        https://bugs.webkit.org/show_bug.cgi?id=40948
        
        Rename DrawingAreaUpdateChunk to ChunkedUpdateDrawingArea.

        * UIProcess/API/mac/WKView.mm:
        (-[WKView initWithFrame:pageNamespaceRef:]):
        * UIProcess/ChunkedUpdateDrawingArea.cpp: Added.
        (WebKit::ChunkedUpdateDrawingArea::ChunkedUpdateDrawingArea):
        (WebKit::ChunkedUpdateDrawingArea::~ChunkedUpdateDrawingArea):
        (WebKit::ChunkedUpdateDrawingArea::paint):
        (WebKit::ChunkedUpdateDrawingArea::setSize):
        (WebKit::ChunkedUpdateDrawingArea::setPageIsVisible):
        (WebKit::ChunkedUpdateDrawingArea::didSetSize):
        (WebKit::ChunkedUpdateDrawingArea::update):
        (WebKit::ChunkedUpdateDrawingArea::didReceiveMessage):
        * UIProcess/ChunkedUpdateDrawingArea.h: Added.
        (WebKit::ChunkedUpdateDrawingArea::encode):
        * UIProcess/DrawingAreaProxyUpdateChunk.cpp: Removed.
        * UIProcess/DrawingAreaProxyUpdateChunk.h: Removed.
        * UIProcess/mac/DrawingAreaProxyUpdateChunkMac.mm:
        (WebKit::ChunkedUpdateDrawingArea::page):
        (WebKit::ChunkedUpdateDrawingArea::ensureBackingStore):
        (WebKit::ChunkedUpdateDrawingArea::invalidateBackingStore):
        (WebKit::ChunkedUpdateDrawingArea::platformPaint):
        (WebKit::ChunkedUpdateDrawingArea::drawUpdateChunkIntoBackingStore):
        * UIProcess/win/DrawingAreaProxyUpdateChunkWin.cpp:
        (WebKit::ChunkedUpdateDrawingArea::page):
        (WebKit::ChunkedUpdateDrawingArea::ensureBackingStore):
        (WebKit::ChunkedUpdateDrawingArea::invalidateBackingStore):
        (WebKit::ChunkedUpdateDrawingArea::platformPaint):
        (WebKit::ChunkedUpdateDrawingArea::drawUpdateChunkIntoBackingStore):
        * UIProcess/win/WebView.cpp:
        (WebKit::WebView::WebView):
        * WebKit2.xcodeproj/project.pbxproj:
        * win/WebKit2.vcproj:

2010-06-21  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Patch for https://bugs.webkit.org/show_bug.cgi?id=40940
        Add message passing support to the WebKit2 API.

        Adds message passing for both InjectedBundle -> WebContext
        and WebContext -> InjectedBundle.

        * Shared/CoreIPCSupport/WebProcessMessageKinds.h:
        (WebProcessMessage::):
        * Shared/CoreIPCSupport/WebProcessProxyMessageKinds.h: Added.
        (WebProcessProxyMessage::):
        (CoreIPC::):
        * UIProcess/API/C/WKContext.cpp:
        (WKContextSetInjectedBundleClient):
        (WKContextPostMessageToInjectedBundle):
        * UIProcess/API/C/WKContext.h:
        * UIProcess/WebContext.cpp:
        (WebKit::WebContext::initializeInjectedBundleClient):
        (WebKit::WebContext::forwardMessageToWebContext):
        (WebKit::WebContext::postMessageToInjectedBundle):
        * UIProcess/WebContext.h:
        * UIProcess/WebContextInjectedBundleClient.cpp: Added.
        (WebKit::WebContextInjectedBundleClient::WebContextInjectedBundleClient):
        (WebKit::WebContextInjectedBundleClient::initialize):
        (WebKit::WebContextInjectedBundleClient::didRecieveMessageFromInjectedBundle):
        * UIProcess/WebContextInjectedBundleClient.h: Added.
        * UIProcess/WebProcessManager.cpp:
        (WebKit::WebProcessManager::processDidClose):
        * UIProcess/WebProcessProxy.cpp:
        (WebKit::WebProcessProxy::didReceiveInjectedBundleMessage):
        (WebKit::WebProcessProxy::didReceiveMessage):
        * UIProcess/WebProcessProxy.h:
        * WebKit2.xcodeproj/project.pbxproj:
        * WebProcess/InjectedBundle/API/c/WKBundle.cpp:
        (WKBundlePostMessage):
        * WebProcess/InjectedBundle/API/c/WKBundle.h:
        * WebProcess/InjectedBundle/InjectedBundle.cpp:
        (WebKit::InjectedBundle::postMessage):
        (WebKit::InjectedBundle::didCreatePage):
        (WebKit::InjectedBundle::didRecieveMessage):
        * WebProcess/InjectedBundle/InjectedBundle.h:
        * WebProcess/WebProcess.cpp:
        (WebKit::WebProcess::loadInjectedBundle):
        (WebKit::WebProcess::forwardMessageToInjectedBundle):
        (WebKit::WebProcess::didReceiveMessage):
        * WebProcess/WebProcess.h:
        * mac/WebKit2.exp:
        * win/WebKit2.vcproj:

2010-06-21  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Make WebKit2 build with clang++

        * Platform/CoreIPC/Connection.h:
        * UIProcess/API/mac/WKView.mm:
        (-[WKView keyUp:]):
        (-[WKView keyDown:]):
        * UIProcess/WebHistoryClient.h:
        * UIProcess/WebPageProxy.h:
        * WebProcess/WebPage/WebPage.h:
        * WebProcess/WebProcess.h:

2010-06-21  Satish Sampath  <satish@chromium.org>

        Reviewed by Steve Block.

        Speech Input Patch 0: Added compilation argument to conditionally compile pending patches.

        Speech Input Patch 0: Added compilation argument to conditionally compile pending patches.
        https://bugs.webkit.org/show_bug.cgi?id=40878

        * Configurations/FeatureDefines.xcconfig:

2010-06-20  Jessie Berlin  <jberlin@apple.com>

        Reviewed by Dan Bernstein.

        Add #if USE(PLATFORM_STRATEGIES) where WebPlatformStrategies is being used.

        * WebProcess/WebCoreSupport/WebPlatformStrategies.cpp:
        * WebProcess/WebCoreSupport/WebPlatformStrategies.h:
        * WebProcess/WebProcess.cpp:
        (WebKit::WebProcess::WebProcess):
        Only initialize the web platform strategies if PLATFORM_STRATEGIES is being used.

2010-06-19  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Fix for https://bugs.webkit.org/show_bug.cgi?id=40882
        Add ability to have a WebProcess per WebContext.

        - Move to a one-to-one correspondence of WebContexts to WebProcessProxies.
        - Add explicit shared contexts for general use.
        - Only non-shared contexts can use injected bundles.

        * UIProcess/API/C/WKContext.cpp:
        (WKContextCreate):
        (WKContextCreateWithInjectedBundlePath):
        (WKContextGetSharedProcessContext):
        (WKContextGetSharedThreadContext):
        * UIProcess/API/C/WKContext.h:
        * UIProcess/API/C/WKContextPrivate.h:
        Change API for WKContext to no longer take a WKProcessModel type and instead
        have explicit Create/Get functions for the different kind of contexts. Added
        two shared contexts, one threaded, one process, and made the threaded on private
        for now.

        * UIProcess/API/mac/WKView.mm:
        (-[WKView initWithFrame:]):
        Make WKViews that don't have an explicit context use the shared process
        context by default.

        * UIProcess/Launcher/WebProcessLauncher.h:
        * UIProcess/Launcher/mac/WebProcessLauncher.mm:
        (WebKit::launchWebProcess):
        * UIProcess/Launcher/win/WebProcessLauncher.cpp:
        (WebKit::launchWebProcess):
        Use a boolean argument to note whether we are using a thread or a process
        instead of using the process model enum.

        * UIProcess/ProcessModel.h:
        (WebKit::):
        Convert to using explicit Shared modifier for shared contexts.

        * UIProcess/WebContext.cpp:
        (WebKit::WebContext::sharedProcessContext):
        (WebKit::WebContext::sharedThreadContext):
        (WebKit::WebContext::ensureWebProcess):
        (WebKit::WebContext::createWebPage):
        (WebKit::WebContext::reviveIfNecessary):
        * UIProcess/WebContext.h:
        (WebKit::WebContext::create):
        (WebKit::WebContext::process):
        * UIProcess/WebPageNamespace.cpp:
        (WebKit::WebPageNamespace::createWebPage):
        (WebKit::WebPageNamespace::preferencesDidChange):
        (WebKit::WebPageNamespace::getStatistics):
        * UIProcess/WebPageNamespace.h:
        (WebKit::WebPageNamespace::process):
        (WebKit::WebPageNamespace::reviveIfNecessary):
        Move WebProcessProxy creation logic up into WebContext.

        * UIProcess/WebProcessManager.cpp:
        (WebKit::WebProcessManager::getWebProcess):
        (WebKit::WebProcessManager::processDidClose):
        * UIProcess/WebProcessManager.h:
        Keep a map of WebContexts to WebProcessProxies in addition to the two
        shared processes.

        * UIProcess/WebProcessProxy.cpp:
        (WebKit::WebProcessProxy::create):
        (WebKit::WebProcessProxy::WebProcessProxy):
        (WebKit::WebProcessProxy::connect):
        (WebKit::WebProcessProxy::didClose):
        * UIProcess/WebProcessProxy.h:
        Store a WebContext instead of the process model.

        * mac/WebKit2.exp:
        Add new functions.

2010-06-18  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Make WebCoreSystemInterface.h a C++ only header
        https://bugs.webkit.org/show_bug.cgi?id=40867

        * WebKit2.xcodeproj/project.pbxproj:
        * WebProcess/WebCoreSupport/mac/WebSystemInterface.h:
        * WebProcess/WebCoreSupport/mac/WebSystemInterface.m: Removed.
        * WebProcess/WebCoreSupport/mac/WebSystemInterface.mm: Copied from WebKit2/WebProcess/WebCoreSupport/mac/WebSystemInterface.m.
        * mac/WebKit2.exp:

2010-06-18  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Add platform strategies for WebKit2.
        https://bugs.webkit.org/show_bug.cgi?id=40863

        * WebKit2.xcodeproj/project.pbxproj:
        * WebProcess/WebCoreSupport/WebPlatformStrategies.cpp: Added.
        (WebKit::WebPlatformStrategies::initialize):
        (WebKit::WebPlatformStrategies::WebPlatformStrategies):
        (WebKit::WebPlatformStrategies::createPluginStrategy):
        (WebKit::WebPlatformStrategies::refreshPlugins):
        (WebKit::WebPlatformStrategies::getPluginInfo):
        * WebProcess/WebCoreSupport/WebPlatformStrategies.h: Added.
        * WebProcess/WebProcess.cpp:
        (WebKit::WebProcess::WebProcess):

2010-06-18  Sam Weinig  <weinig@apple.com>

        Rolling http://trac.webkit.org/changeset/61297 back in.

        * WebKit2.xcodeproj/project.pbxproj:
        * WebProcess/InjectedBundle/API/c/WKBundlePage.cpp: Added.
        (WKBundlePageSetClient):
        (WKBundlePageGetMainFrameURL):
        * WebProcess/InjectedBundle/API/c/WKBundlePage.h: Added.
        * WebProcess/InjectedBundle/InjectedBundlePageClient.cpp: Added.
        (WebKit::InjectedBundlePageClient::InjectedBundlePageClient):
        (WebKit::InjectedBundlePageClient::initialize):
        (WebKit::InjectedBundlePageClient::didClearWindowObjectForFrame):
        * WebProcess/InjectedBundle/InjectedBundlePageClient.h: Added.
        * WebProcess/WebCoreSupport/WebFrameLoaderClient.cpp:
        (WebKit::WebFrameLoaderClient::dispatchDidClearWindowObjectInWorld):
        * WebProcess/WebPage/WebPage.cpp:
        (WebKit::WebPage::initializeInjectedBundleClient):
        (WebKit::WebPage::mainFrameURL):
        * WebProcess/WebPage/WebPage.h:
        (WebKit::WebPage::injectedBundleClient):
        * mac/WebKit2.exp:
        * win/WebKit2.vcproj:

2010-06-17  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Fix a race condition during startup where we would never send the InitializeConnection message to the server.

        * Platform/CoreIPC/mac/ConnectionMac.cpp:
        (CoreIPC::Connection::open):

2010-06-17  Ada Chan  <adachan@apple.com>

        Rolling out http://trac.webkit.org/changeset/61297 due to build errors.

        * WebKit2.xcodeproj/project.pbxproj:
        * WebProcess/InjectedBundle/API/c/WKBundlePage.cpp: Removed.
        * WebProcess/InjectedBundle/API/c/WKBundlePage.h: Removed.
        * WebProcess/InjectedBundle/InjectedBundlePageClient.cpp: Removed.
        * WebProcess/InjectedBundle/InjectedBundlePageClient.h: Removed.
        * WebProcess/WebCoreSupport/WebFrameLoaderClient.cpp:
        (WebKit::WebFrameLoaderClient::dispatchDidClearWindowObjectInWorld):
        * WebProcess/WebPage/WebPage.cpp:
        * WebProcess/WebPage/WebPage.h:
        * mac/WebKit2.exp:
        * win/WebKit2.vcproj:

2010-06-15  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Fix for <rdar://problem/8010805>
        Assertion failure ("mainThreadPthread") in isMainThread() mousing over cnn.com in Mini Browser

        Don't use WebCore::String::operator NSString*() from the UIProcess, since it uses
        StringImpl::createCFString() which expects to be called from WebCore's main thread.

        * UIProcess/API/mac/PageClientImpl.h:
        * UIProcess/API/mac/PageClientImpl.mm:
        (WebKit::nsStringFromWebCoreString):
        (WebKit::PageClientImpl::toolTipChanged):
        * UIProcess/API/mac/WKView.mm:
        (-[WKView view:stringForToolTip:point:userData:]):

2010-06-15  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Fix for https://bugs.webkit.org/show_bug.cgi?id=40630
        WebKit2: Add mechanism to inject code into the WebProcess on startup

        Add initial InjectedBundle support.

        * Shared/CoreIPCSupport/WebProcessMessageKinds.h:
        (WebProcessMessage::):
        Add new LoadInjectedBundle message kind.

        * UIProcess/API/C/WKContext.cpp:
        (toWK):
        (WKContextCreate):
        (WKContextCreateWithInjectedBundlePath):
        * UIProcess/API/C/WKContext.h:
        Rename WKContextCreateWithProcessModel to WKContextCreate and add
        WKContextCreateWithInjectedBundlePath for creating a context with
        a bundle.

        * UIProcess/WebContext.cpp:
        (WebKit::WebContext::WebContext):
        * UIProcess/WebContext.h:
        (WebKit::WebContext::create):
        (WebKit::WebContext::processModel):
        (WebKit::WebContext::bundlePath):
        * UIProcess/WebPageNamespace.cpp:
        (WebKit::WebPageNamespace::ensureWebProcess):
        (WebKit::WebPageNamespace::reviveIfNecessary):
        * UIProcess/WebProcessManager.cpp:
        (WebKit::WebProcessManager::getWebProcess):
        * UIProcess/WebProcessManager.h:
        * UIProcess/WebProcessProxy.cpp:
        (WebKit::WebProcessProxy::create):
        (WebKit::WebProcessProxy::WebProcessProxy):
        * UIProcess/WebProcessProxy.h:
        Thread the bundle path through process creation.

        * WebProcess/InjectedBundle: Added.
        * WebProcess/InjectedBundle/API: Added.
        * WebProcess/InjectedBundle/API/c: Added.
        * WebProcess/InjectedBundle/API/c/WKBundle.cpp: Added.
        (WKBundleSetClient):
        * WebProcess/InjectedBundle/API/c/WKBundle.h: Added.
        * WebProcess/InjectedBundle/API/c/WKBundleAPICast.h: Added.
        (WebKit::):
        (toWK):
        (toRef):
        * WebProcess/InjectedBundle/API/c/WKBundleBase.h: Added.
        * WebProcess/InjectedBundle/API/c/WKBundleInitialize.h: Added.
        * WebProcess/InjectedBundle/InjectedBundle.cpp: Added.
        (WebKit::InjectedBundle::InjectedBundle):
        (WebKit::InjectedBundle::~InjectedBundle):
        (WebKit::InjectedBundle::initializeClient):
        (WebKit::InjectedBundle::didCreatePage):
        * WebProcess/InjectedBundle/InjectedBundle.h: Added.
        (WebKit::InjectedBundle::create):
        Add bundle boilerplate.

        * WebProcess/InjectedBundle/mac: Added.
        * WebProcess/InjectedBundle/mac/InjectedBundleMac.cpp: Added.
        (WebKit::InjectedBundle::load):
        Load the InjectedBundle using CFBundle.

        * WebProcess/InjectedBundle/win: Added.
        * WebProcess/InjectedBundle/win/InjectedBundleWin.cpp: Added.
        (WebKit::pathGetFileName):
        (WebKit::directoryName):
        (WebKit::InjectedBundle::load):
        Load the InjectedBundle using HMODULE.

        * WebProcess/WebPage/WebPage.cpp:
        (WebKit::WebPage::WebPage):
        Add initial bundle callback for page creation. More to come.

        * WebProcess/WebProcess.cpp:
        (WebKit::WebProcess::loadInjectedBundle):
        (WebKit::WebProcess::didReceiveMessage):
        * WebProcess/WebProcess.h:
        (WebKit::WebProcess::injectedBundle):
        Load the InjectedBundle on LoadInjectedBundle message.

        * WebKit2.xcodeproj/project.pbxproj:
        * mac/WebKit2.exp:
        * win/WebKit2.vcproj:
        * win/WebKit2Generated.make:
        Add the new files.

2010-06-15  Darin Adler  <darin@apple.com>

        Reviewed by Adam Barth.

        Move functions out of Frame class that were marked "move to Chrome"
        https://bugs.webkit.org/show_bug.cgi?id=39636

        * WebProcess/WebPage/WebPage.cpp:
        (WebKit::WebPage::tryClose): Call shouldClose on FrameLoader instead of
        going through Frame.

2010-06-14  Steve Falkenburg  <sfalken@apple.com>

        Windows build fix.
        Reorder build event to fix cygwin path issue.

        * win/WebKit2Generated.vcproj:

2010-06-14  Steve Falkenburg  <sfalken@apple.com>

        Windows build fix.
        Add build failure stopping code.

        * win/WebKit2WebProcess.vcproj:

2010-06-14  Steve Falkenburg  <sfalken@apple.com>

        Windows build fix.
        Add build failure stopping code.

        * win/WebKit2Generated.vcproj:

2010-06-14  Ada Chan  <adachan@apple.com>

        Rubber-stamped by Steve Falkenburg.

        - Fix the release configuration to use release.vsprops.
        - Add Debug_Internal and Debug_All configurations to the WebKit2WebProcess project.
        - Fix launchWebProcess() to get the right path to the WebKit2WebProcess executable.

        * UIProcess/Launcher/win/WebProcessLauncher.cpp:
        (WebKit::launchWebProcess):
        * win/WebKit2WebProcess.vcproj:

2010-06-12  Ada Chan  <adachan@apple.com>

        Unreviewed fix for a linking error with WebKit2LocalizableStringsBundle for Windows release build.

        * WebProcess/win/WebLocalizableStrings.cpp:
        (findCachedString):

2010-06-11  Sam Weinig  <sam@webkit.org>

        Reviewed by Mark Rowe.

        Use -Os for optimized builds instead of -02. -02 wasn't giving the 
        right trade off at this time.

        * Configurations/Base.xcconfig:

2010-06-11  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Move WKRetain and WKRelease overloaded functions out of WKRetainPtr
        and into the files of the type they overload (eg, WKRetain(WKFrameRef 
        moves to WKFrame.h)).

        * UIProcess/API/C/WKBase.h:
        * UIProcess/API/C/WKContext.h:
        * UIProcess/API/C/WKFrame.h:
        * UIProcess/API/C/WKFramePolicyListener.h:
        * UIProcess/API/C/WKNavigationData.h:
        * UIProcess/API/C/WKPage.h:
        * UIProcess/API/C/WKPageNamespace.h:
        * UIProcess/API/C/WKPreferences.h:
        * UIProcess/API/C/WKString.h:
        * UIProcess/API/C/WKURL.h:
        * UIProcess/API/cpp/WKRetainPtr.h:
        * UIProcess/API/win/WKView.h:

2010-06-10  John Sullivan  <sullivan@apple.com>

        Reviewed by Dan Bernstein.

        * mac/WebKit2.exp:
        Added another symbol needed by Mac clients.

2010-06-09  Ilya Tikhonovsky  <loislo@chromium.org>

        Unreviewed build fix.

        * WebProcess/WebCoreSupport/WebInspectorClient.h:

2010-06-09  Ilya Tikhonovsky  <loislo@chromium.org>

        Unreviewed build fix.

        WebInspector: On the way to Remote Debugging we want to transfer dom/timeline/etc
        data from inspected page to WebInspector as JSON string via http. The native
        serialization to JSON string is supported by InspectorValue's classes. This patch
        has the implementation of sendMessageToFrontend function. WebKit version of it still
        uses ScriptFunctionCall and will be switched to another transport a little bit later.
        https://bugs.webkit.org/show_bug.cgi?id=40134

        * WebProcess/WebCoreSupport/WebInspectorClient.cpp:
        (WebKit::WebInspectorClient::sendMessageToFrontend):
        * WebProcess/WebCoreSupport/WebInspectorClient.h:

2010-06-08  Anders Carlsson  <andersca@apple.com>

        Reviewed by John Sullivan.

        <rdar://problem/8071268> WebKit2 URLs are displayed as 1-character strings in log statements

        Create a CFString from our WebCore string and then create the CFURL from the CFString.

        * UIProcess/API/C/cf/WKURLCF.cpp:
        (WKURLCopyCFURL):

2010-06-08  John Sullivan  <sullivan@apple.com>

        Rubber-stamped by Anders Carlsson.

        * mac/WebKit2.exp:
        Added _WKPageGetEstimatedProgress and _WKFrameGetPage

2010-06-08  Anders Carlsson  <andersca@apple.com>

        Reviewed by John Sullivan.

        Would like a way to query WKPageRef for the current progress value
        https://bugs.webkit.org/show_bug.cgi?id=40310
        <rdar://problem/8071299>

        Add WKPageGetEstimatedProgress. Remove the progress parameter from the didChangeProgress
        loader client callback function.

        * UIProcess/API/C/WKPage.cpp:
        (WKPageGetEstimatedProgress):
        * UIProcess/API/C/WKPage.h:
        * UIProcess/WebLoaderClient.cpp:
        (WebKit::WebLoaderClient::didChangeProgress):
        * UIProcess/WebLoaderClient.h:
        * UIProcess/WebPageProxy.cpp:
        (WebKit::WebPageProxy::WebPageProxy):
        (WebKit::WebPageProxy::close):
        (WebKit::WebPageProxy::didStartProgress):
        (WebKit::WebPageProxy::didChangeProgress):
        (WebKit::WebPageProxy::didFinishProgress):
        (WebKit::WebPageProxy::processDidExit):
        * UIProcess/WebPageProxy.h:
        (WebKit::WebPageProxy::estimatedProgress):

2010-06-08  Anders Carlsson  <andersca@apple.com>

        Reviewed by John Sullivan.

        Would like a way to tell which WKPageRef a WKFrameRef is part of
        https://bugs.webkit.org/show_bug.cgi?id=40308
        <rdar://problem/8071251>

        Add and implement WKFrameGetPage.

        * UIProcess/API/C/WKFrame.cpp:
        (WKFrameGetPage):
        * UIProcess/API/C/WKFrame.h:
        * UIProcess/WebFrameProxy.h:
        (WebKit::WebFrameProxy::page):

2010-06-08  John Sullivan  <sullivan@apple.com>

        Rubber-stamped by Mark Rowe.

        * mac/WebKit2.exp:
        Added a few more symbols needed by Mac clients.

2010-06-08  MORITA Hajime  <morrita@google.com>

        Unreviewed. An attempt to fix test break.

        * Configurations/FeatureDefines.xcconfig:

2010-06-06  MORITA Hajime  <morrita@google.com>

        Unreviewd, follow up to r60820

        https://bugs.webkit.org/show_bug.cgi?id=40219
        [Mac] ENABLE_METER_TAG should be enabled
        
        * Configurations/FeatureDefines.xcconfig:

2010-06-05  Mark Rowe  <mrowe@apple.com>

        Rubber-stamped by Dan Bernstein.

        <rdar://problem/8063622> Failure to launch WebProcess.app when framework is outside of the build directory

        * Configurations/WebProcess.xcconfig:

2010-06-04  John Sullivan  <sullivan@apple.com>

        Rubber-stamped by Ada Chan.

        Added a couple of symbols needed to start using WKFrameRefs in Mac clients.

        * mac/WebKit2.exp:
        Added _WKFrameRelease and _WKFrameRetain.

2010-06-04  Ada Chan  <adachan@apple.com>

        Reviewed by Anders Carlsson.

        http://bugs.webkit.org/show_bug.cgi?id=40186
        
        Need to close WebPageProxy when the WebView is destroyed.
        Also, WebPageProxy shouldn't hold an OwnPtr to the PageClient, which is the WebView on Windows.

        * UIProcess/WebPageProxy.cpp:
        (WebKit::WebPageProxy::WebPageProxy):
        (WebKit::WebPageProxy::setPageClient):
        * UIProcess/WebPageProxy.h:
        * UIProcess/win/WebView.cpp:
        (WebKit::WebView::close):

2010-06-03  Ada Chan  <adachan@apple.com>

        Reviewed by Adam Roben.

        https://bugs.webkit.org/show_bug.cgi?id=40152
        
        Need to remove the WebView from WindowMessageBroadcaster's listeners list when the WebView is destroyed.

        * UIProcess/API/win/WKView.cpp:
        (WKViewSetHostWindow): Expose API to change the host window of a WKView.
        (WKViewWindowAncestryDidChange): Expose API to allow clients to notify WebKit when a WKView's window ancestry has changed.
        * UIProcess/API/win/WKView.h:
        * UIProcess/win/WebView.cpp:
        (WebKit::WebView::wndProc): Set the WebView's host window to 0 when it's destroyed.  setHostWindow() will call 
        windowAncestryDidChange(), which will remove this WebView from the WindowMessageBroadcaster's listeners list.
        (WebKit::WebView::WebView): Initialize m_isBeingDestroyed.
        (WebKit::WebView::setHostWindow): Update the window's parent window and call windowAncestryDidChange().
        (WebKit::WebView::close): Set the host window to 0.
        * UIProcess/win/WebView.h:

2010-06-04  Tony Gentilcore  <tonyg@chromium.org>

        Reviewed by Adam Barth.

        Utilize new takeFirst() method where appropriate.
        https://bugs.webkit.org/show_bug.cgi?id=40089

        * Platform/CoreIPC/ArgumentDecoder.cpp:
        (CoreIPC::ArgumentDecoder::removeAttachment):

2010-06-03  Ada Chan  <adachan@apple.com>

        Reviewed by Anders Carlsson.

        Add UIProcess\API\cpp to the list of additional include directories.
        Allow WKViewRef to work with WKRetainPtr on Windows.

        * UIProcess/API/cpp/WKRetainPtr.h:
        * win/WebKit2.vcproj:

2010-06-01  Alice Liu  <alice.liu@apple.com>

        Build fix. Not reviewed

        * win/WebKit2Generated.make: Added WKRetainPtr.h

2010-06-01  John Sullivan  <sullivan@apple.com>

        Rubber-stamped by Anders Carlsson.

        Added _WKRetainPtr to .exp file, and added .exp file to Xcode project.

        * WebKit2.xcodeproj/project.pbxproj:
        Added mac/WebKit2.exp.
        
        * mac/WebKit2.exp:
        Added _WKRetainPtr.

2010-06-01  John Sullivan  <sullivan@apple.com>

        Rubber-stamped by Anders Carlsson.

        Fixed typo/wordo that prevented a certain flavor of constructor from compiling.

        * UIProcess/API/cpp/WKRetainPtr.h:
        (WebKit::WKRetainPtr::WKRetainPtr):
        Changed the mysterious "retainWKPtr" to "WKRetain".

2010-05-28  John Sullivan  <sullivan@apple.com>

        Rubber-stamped by Dan Bernstein.

        Add a using declaration for AdoptWK to match the one just added for WKRetainPtr.

        * UIProcess/API/cpp/WKRetainPtr.h:

2010-05-28  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Add a using declaration for WKRetainPtr matching what we do for our
        other smart pointers and fix the destructor.

        * UIProcess/API/cpp/WKRetainPtr.h:
        (WebKit::WKRetainPtr::~WKRetainPtr):

2010-05-25  Ada Chan  <adachan@apple.com>

        Reviewed by Darin Adler.

        https://bugs.webkit.org/show_bug.cgi?id=39686

        Fix the ProjectGUID of the WebKit2 project so it doesn't conflict with the one in WebKit.        

        * WebKit2.sln:
        * win/WebKit2.vcproj:

2010-05-24  Ada Chan  <adachan@apple.com>

        Rubber-stamped by Mark Rowe.
        
        Build fix for 32bit systems.

        * mac/WebKit2.exp:

2010-05-21  Mark Rowe  <mrowe@apple.com>

        Reviewed by Oliver Hunt.

        Teach WebKit2 to build in the Production configuration.

        * Configurations/Base.xcconfig: Restrict WebKit2 to Intel, and disable the order file.
        * Configurations/BaseTarget.xcconfig: Fix the path to the umbrella framework directory.
        This path is used to locate WebCore.framework, so it needs to be relative to WebKit.framework
        rather than WebKit2.framework.
        * Configurations/WebKit2.xcconfig: Update the install path.  Add an exports file.
        * Configurations/WebProcess.xcconfig: Update the install path.
        * WebKit2.xcodeproj/project.pbxproj: Add a Production configuration.
        * mac/WebKit2.exp: Added.

2010-05-21  Steve Block  <steveblock@google.com>

        Unreviewed build fix for WebKit2

        Pass 0 to Page constructor for DeviceOrientationClient.
        See http://trac.webkit.org/changeset/59935

        * WebProcess/WebPage/WebPage.cpp:
        (WebKit::WebPage::WebPage):

2010-05-11  Mark Rowe  <mrowe@apple.com>

        Fix the world.

        In r59162 a change was made to WebCore's FeatureDefines.xcconfig that enabled FILE_READER and FILE_WRITER.
        The author and reviewer of that patch ignored the carefully-worded warning at the top of that file asking
        that changes to the file be kept in sync across JavaScriptCore, WebCore and WebKit, as well as being kept
        in sync with build-webkit.  This led to WebCore and WebKit having different views of Document's vtable
        and results in crashes in Safari shortly after launch when virtual function calls resulted in the wrong
        function in WebCore being called.

        We fix this by bringing the FeatureDefines.xcconfig files in to sync.  Based on the ChangeLog message and
        other changes in r59162 it appears that enabling FILE_WRITER was unintentional so that particular change
        has been reverted.

        * Configurations/FeatureDefines.xcconfig:

2010-05-04  Anders Carlsson  <andersca@apple.com>

        Reviewed by Dan Bernstein.

        [WebKit2] The web process doesn't need to paint when the web view is hidden.
        https://bugs.webkit.org/show_bug.cgi?id=38549

        * Shared/CoreIPCSupport/DrawingAreaMessageKinds.h:
        (DrawingAreaMessage::):
        Add SuspendPainting/ResumePainting messages.
        
        * UIProcess/DrawingAreaProxyUpdateChunk.cpp:
        (WebKit::DrawingAreaProxyUpdateChunk::setPageIsVisible):
        Suspend and resume painting accordingly.
        
        * WebProcess/WebPage/DrawingAreaUpdateChunk.cpp:
        (WebKit::DrawingAreaUpdateChunk::DrawingAreaUpdateChunk):
        Initialize m_shouldPaint to true.
        
        (WebKit::DrawingAreaUpdateChunk::display):
        Return if m_shouldPaint is false.
        
        (WebKit::DrawingAreaUpdateChunk::scheduleDisplay):
        Ditto.
        
        (WebKit::DrawingAreaUpdateChunk::setSize):
        Assert that we should paint here.

        (WebKit::DrawingAreaUpdateChunk::suspendPainting):
        Set m_shouldPaint to false and stop the timer.
        
        (WebKit::DrawingAreaUpdateChunk::resumePainting):
        Set m_shouldPaint to true and paint if needed.

        (WebKit::DrawingAreaUpdateChunk::didReceiveMessage):
        handle SuspendPainting/ResumePainting messages.

        * WebProcess/WebPage/DrawingAreaUpdateChunk.h:

2010-05-03  Anders Carlsson  <andersca@apple.com>

        Reviewed by Jon Honeycutt.

        [WebKit2] WKView should respond to WM_SHOWWINDOW messages
        https://bugs.webkit.org/show_bug.cgi?id=38496

        * UIProcess/win/WebView.cpp:
        (WebKit::WebView::wndProc):
        Add case for WM_SHOWWINDOW.

        (WebKit::WebView::onShowWindowEvent):
        Update the page visibility accordingly.

        * UIProcess/win/WebView.h:

2010-05-03  Anders Carlsson  <andersca@apple.com>

        Reviewed by Dan Bernstein.

        Get rid of PageClient::isPageVisible and pass visibility directly in setPageIsVisible
        https://bugs.webkit.org/show_bug.cgi?id=38493

        * UIProcess/API/mac/PageClientImpl.h:
        * UIProcess/API/mac/PageClientImpl.mm:
        Remove isPageVisible.
        
        * UIProcess/API/mac/WKView.mm:
        (isViewVisible):
        New function (moved here from PageClientImpl).
        
        (-[WKView _updateVisibility]):
        Call didChangeVisibility.
        
        (-[WKView viewDidMoveToWindow]):
        (-[WKView viewDidHide]):
        (-[WKView viewDidUnhide]):
        Call _updateVisibility.
        
        * UIProcess/DrawingAreaProxy.h:
        Rename didChangeVisibility to setPageIsVisible and add an isVisible parameter.
        
        * UIProcess/DrawingAreaProxyUpdateChunk.cpp:
        (WebKit::DrawingAreaProxyUpdateChunk::setPageIsVisible):
        Don't call WebPageProxy::isVisible.

        * UIProcess/DrawingAreaProxyUpdateChunk.h:
        
        * UIProcess/PageClient.h:
        Remove isPageVisible.

        * UIProcess/WebPageProxy.cpp:
        * UIProcess/WebPageProxy.h:
        Remove isVisible.

2010-05-03  Anders Carlsson  <andersca@apple.com>

        Reviewed by Adam Roben.

        Implement PageClient::isPageVisible on Windows.
        https://bugs.webkit.org/show_bug.cgi?id=38483

        * UIProcess/PageClient.h:
        * UIProcess/win/WebView.cpp:
        (WebKit::WebView::isPageVisible):
        * UIProcess/win/WebView.h:

2010-05-03  Anders Carlsson  <andersca@apple.com>

        Fix Windows build.

        * Platform/CoreIPC/win/ConnectionWin.cpp:
        (CoreIPC::Connection::sendOutgoingMessage):
        * Shared/win/UpdateChunk.cpp:
        (WebKit::UpdateChunk::UpdateChunk):
        (WebKit::UpdateChunk::encode):
        (WebKit::UpdateChunk::decode):
        * Shared/win/UpdateChunk.h:
        (WebKit::UpdateChunk::rect):
        * UIProcess/DrawingAreaProxy.h:
        * UIProcess/DrawingAreaProxyUpdateChunk.h:
        * UIProcess/win/DrawingAreaProxyUpdateChunkWin.cpp:
        (WebKit::DrawingAreaProxyUpdateChunk::drawUpdateChunkIntoBackingStore):
        * WebProcess/WebPage/win/DrawingAreaUpdateChunkWin.cpp:
        (WebKit::DrawingAreaUpdateChunk::paintIntoUpdateChunk):
        * WebProcess/win/WebProcessMain.cpp:

2010-04-30  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        https://bugs.webkit.org/show_bug.cgi?id=38415
        Have the WKView notify the DrawingAreaProxy when its visibility changes.

        * UIProcess/API/mac/PageClientImpl.h:
        * UIProcess/API/mac/PageClientImpl.mm:
        (WebKit::PageClientImpl::isPageVisible):
        * UIProcess/API/mac/WKView.mm:
        (-[WKView viewDidMoveToWindow]):
        (-[WKView viewDidHide]):
        (-[WKView viewDidUnhide]):
        * UIProcess/DrawingAreaProxy.h:
        * UIProcess/DrawingAreaProxyUpdateChunk.cpp:
        (WebKit::DrawingAreaProxyUpdateChunk::DrawingAreaProxyUpdateChunk):
        (WebKit::DrawingAreaProxyUpdateChunk::didChangeVisibility):
        * UIProcess/DrawingAreaProxyUpdateChunk.h:
        * UIProcess/PageClient.h:
        * UIProcess/WebPageProxy.cpp:
        (WebKit::WebPageProxy::isVisible):
        * UIProcess/WebPageProxy.h:

2010-05-03  Jens Alfke  <snej@chromium.org>

        Reviewed by Darin Fisher.

        [chromium] Add "willSendSubmitEvent" hook to WebFrameClient and FrameLoaderClient
        https://bugs.webkit.org/show_bug.cgi?id=38397

        No tests (functionality is exposed only through native WebKit API.)

        * WebProcess/WebCoreSupport/WebFrameLoaderClient.h:
        (WebKit::WebFrameLoaderClient::dispatchWillSendSubmitEvent):

2010-05-01  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Fix for https://bugs.webkit.org/show_bug.cgi?id=38471
        Add generic callback mechanism

        Added GenericCallback class replacing RenderTreeExternalRepresentationCallback
        and ScriptReturnValueCallback.
        
        Also,
        - Standardize C API callbacks to take the context last.
        - Standardize C API callbacks to not have the _f suffix (now the block
          variants have a _b suffix).
        - Re-write toWK and toRef methods as a set of template functions using
          the generic API->implementation mapping information.

        * UIProcess/API/C/WKAPICast.h:
        * UIProcess/API/C/WKPage.cpp:
        (WKPageRunJavaScriptInMainFrame):
        (callRunJavaScriptBlockAndRelease):
        (disposeRunJavaScriptBlock):
        (WKPageRunJavaScriptInMainFrame_b):
        (WKPageRenderTreeExternalRepresentation):
        (WKPageRenderTreeExternalRepresentation_b):
        * UIProcess/API/C/WKPage.h:
        * UIProcess/API/C/WKPagePrivate.h:
        * UIProcess/GenericCallback.h: Added.
        (WebKit::GenericCallback::create):
        (WebKit::GenericCallback::~GenericCallback):
        (WebKit::GenericCallback::performCallbackWithReturnValue):
        (WebKit::GenericCallback::invalidate):
        (WebKit::GenericCallback::callbackID):
        (WebKit::GenericCallback::generateCallbackID):
        (WebKit::GenericCallback::GenericCallback):
        * UIProcess/RenderTreeExternalRepresentationCallback.cpp: Removed.
        * UIProcess/RenderTreeExternalRepresentationCallback.h: Removed.
        * UIProcess/ScriptReturnValueCallback.cpp: Removed.
        * UIProcess/ScriptReturnValueCallback.h: Removed.
        * UIProcess/WebPageProxy.cpp:
        (WebKit::WebPageProxy::didRunJavaScriptInMainFrame):
        (WebKit::WebPageProxy::didGetRenderTreeExternalRepresentation):
        * UIProcess/WebPageProxy.h:
        * WebKit2.xcodeproj/project.pbxproj:
        * win/WebKit2.vcproj:

2010-04-30  Sam Weinig  <sam@webkit.org>

        Fix the build.

        * Platform/CoreIPC/mac/ConnectionMac.cpp: Add missing #include.

2010-04-30  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        https://bugs.webkit.org/show_bug.cgi?id=38413
        Add callback based API to get the textual representation of the RenderTree.

        - Also ensures that any pending callbacks are invalidated if the WebPage
          closes (expectedly or unexpectedly).
        - A follow up patch will unify the callback mechanism with a common base
          class.

        * Shared/CoreIPCSupport/WebPageMessageKinds.h:
        (WebPageMessage::):
        * Shared/CoreIPCSupport/WebPageProxyMessageKinds.h:
        (WebPageProxyMessage::):
        * UIProcess/API/C/WKPage.cpp:
        (WKPageRunJavaScriptInMainFrame_f):
        (WKPageRenderTreeExternalRepresentation_f):
        (callRenderTreeExternalRepresentationBlockAndDispose):
        (disposeRenderTreeExternalRepresentationBlock):
        (WKPageRenderTreeExternalRepresentation):
        * UIProcess/API/C/WKPagePrivate.h: Added.
        * UIProcess/RenderTreeExternalRepresentationCallback.cpp: Added.
        (WebKit::generateCallbackID):
        (WebKit::RenderTreeExternalRepresentationCallback::RenderTreeExternalRepresentationCallback):
        (WebKit::RenderTreeExternalRepresentationCallback::~RenderTreeExternalRepresentationCallback):
        (WebKit::RenderTreeExternalRepresentationCallback::performCallbackWithReturnValue):
        (WebKit::RenderTreeExternalRepresentationCallback::invalidate):
        * UIProcess/RenderTreeExternalRepresentationCallback.h: Added.
        (WebKit::RenderTreeExternalRepresentationCallback::create):
        (WebKit::RenderTreeExternalRepresentationCallback::callbackID):
        * UIProcess/ScriptReturnValueCallback.cpp:
        (WebKit::ScriptReturnValueCallback::~ScriptReturnValueCallback):
        (WebKit::ScriptReturnValueCallback::performCallbackWithReturnValue):
        (WebKit::ScriptReturnValueCallback::invalidate):
        * UIProcess/ScriptReturnValueCallback.h:
        * UIProcess/WebPageProxy.cpp:
        (WebKit::WebPageProxy::close):
        (WebKit::WebPageProxy::getRenderTreeExternalRepresentation):
        (WebKit::WebPageProxy::didReceiveMessage):
        (WebKit::WebPageProxy::didRunJavaScriptInMainFrame):
        (WebKit::WebPageProxy::didGetRenderTreeExternalRepresentation):
        (WebKit::WebPageProxy::processDidExit):
        * UIProcess/WebPageProxy.h:
        * WebKit2.xcodeproj/project.pbxproj:
        * WebProcess/WebPage/WebPage.cpp:
        (WebKit::WebPage::getRenderTreeExternalRepresentation):
        (WebKit::WebPage::didReceiveMessage):
        * WebProcess/WebPage/WebPage.h:
        * win/WebKit2.vcproj:

2010-04-30  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Fix for https://bugs.webkit.org/show_bug.cgi?id=38406
        Add support for sending messages with a size greater than 4096 bytes

        Adds support by putting message bodies that are larger than 4096 bytes
        in OOL memory.

        * Platform/CoreIPC/Connection.cpp:
        (CoreIPC::Connection::sendMessage):
        (CoreIPC::Connection::waitForMessage):
        (CoreIPC::Connection::sendSyncMessage):
        (CoreIPC::Connection::dispatchMessages):
        * Platform/CoreIPC/Connection.h:
        (CoreIPC::Connection::OutgoingMessage::OutgoingMessage):
        (CoreIPC::Connection::OutgoingMessage::messageID):
        (CoreIPC::Connection::send):
        (CoreIPC::Connection::sendSync):
        * Platform/CoreIPC/MessageID.h:
        (CoreIPC::MessageID::):
        (CoreIPC::MessageID::MessageID):
        (CoreIPC::MessageID::equalIgnoringFlags):
        (CoreIPC::MessageID::copyAddingFlags):
        (CoreIPC::MessageID::fromInt):
        (CoreIPC::MessageID::toInt):
        (CoreIPC::MessageID::isMessageBodyOOL):
        * Platform/CoreIPC/mac/ConnectionMac.cpp:
        (CoreIPC::Connection::sendOutgoingMessage):
        (CoreIPC::createArgumentDecoder):

2010-04-28  Mike Thole  <mthole@apple.com>

        Build fix, not reviewed.

        Fix WebKit2 build by stubbing out WebFrameLoaderClient::canAuthenticateAgainstProtectionSpace().

        * WebProcess/WebCoreSupport/WebFrameLoaderClient.cpp:
        (WebKit::WebFrameLoaderClient::canAuthenticateAgainstProtectionSpace):
        * WebProcess/WebCoreSupport/WebFrameLoaderClient.h:

2010-04-28  Sam Weinig  <sam@webkit.org>

        Reviewed by Mark Rowe.

        Only build on SnowLeopard and later when using the Makefile.

        * Makefile:

2010-04-27  Sam Weinig  <sam@webkit.org>

        Reviewed by Maciej Stachowiak.

        Fix for https://bugs.webkit.org/show_bug.cgi?id=38238
        Allow both WebKit and WebKit2 to link to the same WebCore.framework

        * Configurations/WebKit2.xcconfig: Remove the OTHER_LDFLAGS. We don't
        need to set WebCore as a sub_umbrella of WebKit2, since we are not
        reexporting any of its symbols.

2010-04-27  Sam Weinig  <sam@webkit.org>

        Reviewed by Geoffrey Garen.

        Add comment about not using StringImpl::createCFString in WKStringCopyCFString.

        * UIProcess/API/C/cf/WKStringCF.cpp:
        (WKStringCopyCFString):

2010-04-27  Sam Weinig  <sam@webkit.org>

        Reviewed by Geoffrey Garen.

        Remove call to StringImpl::createCFString and instead use CFStringCreateWithCharacters
        directly. StringImpl::createCFString only an optimization when called
        from the thread that WebCore is running on, which is never the case for
        WKStringCopyCFString. We should revisit this later, perhaps adding a
        threadspecific allocator. We also now honor the passed in allocator.

        * UIProcess/API/C/cf/WKStringCF.cpp:
        (WKStringCopyCFString):

2010-04-25  Sam Weinig  <sam@webkit.org>

        Reviewed by Maciej Stachowiak.

        Fix for https://bugs.webkit.org/show_bug.cgi?id=38097
        Disentangle initializing the main thread from initializing threading

        * UIProcess/Launcher/mac/WebProcessLauncher.mm:
        (WebKit::webThreadBody): Add call to initializeMainThread.
        * UIProcess/Launcher/win/WebProcessLauncher.cpp:
        (WebKit::webThreadBody): Ditto.
        * WebProcess/Launching/mac/WebProcessMain.mm:
        (main): Ditto.
        * WebProcess/win/WebProcessMain.cpp:
        (WebKit::WebProcessMain): Ditto.

2010-04-23  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        https://bugs.webkit.org/show_bug.cgi?id=38065
        Merge mac and win DrawingAreaProxyUpdateChunk implementations.

        * UIProcess/API/mac/WKView.mm:
        (-[WKView drawRect:]):
        * UIProcess/DrawingAreaProxy.cpp: Copied from UIProcess/mac/DrawingAreaProxy.mm.
        * UIProcess/DrawingAreaProxy.h: Copied from UIProcess/mac/DrawingAreaProxy.h.
        * UIProcess/DrawingAreaProxyUpdateChunk.cpp: Copied from UIProcess/mac/DrawingAreaProxyUpdateChunk.mm.
        (WebKit::DrawingAreaProxyUpdateChunk::DrawingAreaProxyUpdateChunk):
        (WebKit::DrawingAreaProxyUpdateChunk::paint):
        (WebKit::DrawingAreaProxyUpdateChunk::setSize):
        (WebKit::DrawingAreaProxyUpdateChunk::didSetSize):
        (WebKit::DrawingAreaProxyUpdateChunk::update):
        (WebKit::DrawingAreaProxyUpdateChunk::didReceiveMessage):
        * UIProcess/DrawingAreaProxyUpdateChunk.h: Copied from UIProcess/mac/DrawingAreaProxyUpdateChunk.h.
        * UIProcess/mac/DrawingAreaProxy.h: Removed.
        * UIProcess/mac/DrawingAreaProxy.mm: Removed.
        * UIProcess/mac/DrawingAreaProxyUpdateChunk.h: Removed.
        * UIProcess/mac/DrawingAreaProxyUpdateChunk.mm: Removed.
        * UIProcess/mac/DrawingAreaProxyUpdateChunkMac.mm: Copied from UIProcess/mac/DrawingAreaProxyUpdateChunk.mm.
        (WebKit::DrawingAreaProxyUpdateChunk::page):
        (WebKit::DrawingAreaProxyUpdateChunk::invalidateBackingStore):
        (WebKit::DrawingAreaProxyUpdateChunk::platformPaint):
        (WebKit::DrawingAreaProxyUpdateChunk::drawUpdateChunkIntoBackingStore):
        * UIProcess/win/DrawingAreaProxy.cpp: Removed.
        * UIProcess/win/DrawingAreaProxy.h: Removed.
        * UIProcess/win/DrawingAreaProxyUpdateChunkWin.cpp: Copied from UIProcess/win/DrawingAreaProxy.cpp.
        (WebKit::DrawingAreaProxyUpdateChunk::page):
        (WebKit::DrawingAreaProxyUpdateChunk::ensureBackingStore):
        (WebKit::DrawingAreaProxyUpdateChunk::invalidateBackingStore):
        (WebKit::DrawingAreaProxyUpdateChunk::platformPaint):
        (WebKit::DrawingAreaProxyUpdateChunk::drawUpdateChunkIntoBackingStore):
        * UIProcess/win/WebView.cpp:
        (WebKit::WebView::WebView):
        (WebKit::WebView::onPaintEvent):
        * WebKit2.xcodeproj/project.pbxproj:
        * win/WebKit2.vcproj:

2010-04-23  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Fix for https://bugs.webkit.org/show_bug.cgi?id=38059
        Merge mac and win DrawingAreaUpdateChunk implementations.

        * UIProcess/win/DrawingAreaProxy.cpp:
        (WebKit::DrawingAreaProxy::didSetSize):
        (WebKit::DrawingAreaProxy::didReceiveMessage):
        * UIProcess/win/DrawingAreaProxy.h:
        * WebKit2.xcodeproj/project.pbxproj:
        * WebProcess/WebPage/DrawingAreaUpdateChunk.cpp: Copied from WebProcess/WebPage/mac/DrawingAreaUpdateChunk.cpp.
        (WebKit::DrawingAreaUpdateChunk::setSize):
        * WebProcess/WebPage/DrawingAreaUpdateChunk.h: Copied from WebProcess/WebPage/mac/DrawingAreaUpdateChunk.h.
        * WebProcess/WebPage/mac/DrawingAreaUpdateChunk.cpp: Removed.
        * WebProcess/WebPage/mac/DrawingAreaUpdateChunk.h: Removed.
        * WebProcess/WebPage/mac/DrawingAreaUpdateChunkMac.cpp: Copied from WebProcess/WebPage/mac/DrawingAreaUpdateChunk.cpp.
        * WebProcess/WebPage/win/DrawingAreaUpdateChunk.cpp: Removed.
        * WebProcess/WebPage/win/DrawingAreaUpdateChunk.h: Removed.
        * WebProcess/WebPage/win/DrawingAreaUpdateChunkWin.cpp: Copied from WebProcess/WebPage/win/DrawingAreaUpdateChunk.cpp.
        (WebKit::DrawingAreaUpdateChunk::paintIntoUpdateChunk):
        * win/WebKit2.vcproj:

2010-04-23  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Remove an assert. (It's not valid when resizing).

        * WebProcess/WebPage/win/DrawingAreaUpdateChunk.cpp:
        (WebKit::DrawingAreaUpdateChunk::didUpdate):

2010-04-23  Anders Carlsson  <andersca@apple.com>

        Fix build.

        * UIProcess/win/DrawingAreaProxy.cpp:
        (WebKit::DrawingAreaProxy::paint):
        (WebKit::DrawingAreaProxy::setSize):
        (WebKit::DrawingAreaProxy::didReceiveMessage):
        * WebProcess/WebPage/win/DrawingAreaUpdateChunk.cpp:
        (WebKit::DrawingAreaUpdateChunk::setSize):
        (WebKit::DrawingAreaUpdateChunk::didReceiveMessage):

2010-04-22  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Remove an assert. (It's not valid when resizing).

        * WebProcess/WebPage/mac/DrawingAreaUpdateChunk.cpp:
        (WebKit::DrawingAreaUpdateChunk::didUpdate):

2010-04-22  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Merge the prefix headers.

        * Configurations/BaseTarget.xcconfig:
        * WebKit2.xcodeproj/project.pbxproj:
        * WebKit2Prefix.h:
        * WebKit2_Prefix.pch: Removed.

2010-04-22  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Don't pass the new size when calling didSetSize, it's possible to get
        the size from the update chunk.

        * UIProcess/mac/DrawingAreaProxyUpdateChunk.h:
        * UIProcess/mac/DrawingAreaProxyUpdateChunk.mm:
        (WebKit::DrawingAreaProxyUpdateChunk::didSetSize):
        (WebKit::DrawingAreaProxyUpdateChunk::didReceiveMessage):
        * WebProcess/WebPage/mac/DrawingAreaUpdateChunk.cpp:
        (WebKit::DrawingAreaUpdateChunk::setSize):

2010-04-22  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Rename SetFrame and DidSetFrame to SetSize and DidSetSize.

        * Shared/CoreIPCSupport/DrawingAreaMessageKinds.h:
        (DrawingAreaMessage::):
        * Shared/CoreIPCSupport/DrawingAreaProxyMessageKinds.h:
        (DrawingAreaProxyMessage::):
        * UIProcess/mac/DrawingAreaProxyUpdateChunk.mm:
        (WebKit::DrawingAreaProxyUpdateChunk::drawRectIntoContext):
        (WebKit::DrawingAreaProxyUpdateChunk::setSize):
        (WebKit::DrawingAreaProxyUpdateChunk::didReceiveMessage):
        * WebProcess/WebPage/mac/DrawingAreaUpdateChunk.cpp:
        (WebKit::DrawingAreaUpdateChunk::setSize):
        (WebKit::DrawingAreaUpdateChunk::didReceiveMessage):

2010-04-22  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Fix for https://bugs.webkit.org/show_bug.cgi?id=38002
        Add rudimentary statistics gathering for WebKit2

        * UIProcess/API/C/WKContext.cpp:
        (WKContextGetStatistics):
        * UIProcess/API/C/WKContextPrivate.h: Copied from WebKit2/UIProcess/API/C/WKContext.h.
        * UIProcess/API/C/WKPageNamespace.cpp:
        (WKPageNamespaceGetContext):
        * UIProcess/API/C/WKPageNamespace.h:
        * UIProcess/WebContext.cpp:
        (WebKit::WebContext::getStatistics):
        * UIProcess/WebContext.h:
        * UIProcess/WebPageNamespace.cpp:
        (WebKit::WebPageNamespace::getStatistics):
        * UIProcess/WebPageNamespace.h:
        * UIProcess/WebPageProxy.cpp:
        (WebKit::WebPageProxy::getStatistics):
        * UIProcess/WebPageProxy.h:
        * UIProcess/WebProcessProxy.cpp:
        (WebKit::WebProcessProxy::numberOfPages):
        * UIProcess/WebProcessProxy.h:
        * WebKit2.xcodeproj/project.pbxproj:
        * win/WebKit2.vcproj:

2010-04-20  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Don't paint the web page before we've blit the last update chunk to the backing store.

        * UIProcess/win/DrawingAreaProxy.cpp:
        (WebKit::DrawingAreaProxy::update):
        (WebKit::DrawingAreaProxy::didReceiveMessage):
        * UIProcess/win/DrawingAreaProxy.h:
        * WebProcess/WebPage/win/DrawingAreaUpdateChunk.cpp:
        (WebKit::DrawingAreaUpdateChunk::DrawingAreaUpdateChunk):
        (WebKit::DrawingAreaUpdateChunk::display):
        (WebKit::DrawingAreaUpdateChunk::scheduleDisplay):
        (WebKit::DrawingAreaUpdateChunk::setSize):
        (WebKit::DrawingAreaUpdateChunk::didUpdate):
        (WebKit::DrawingAreaUpdateChunk::didReceiveMessage):
        * WebProcess/WebPage/win/DrawingAreaUpdateChunk.h:

2010-04-20  Anders Carlsson  <andersca@apple.com>

        Fix build.

        * WebProcess/WebCoreSupport/WebFrameLoaderClient.cpp:
        (WebKit::WebFrameLoaderClient::receivedData):

2010-04-20  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Don't paint the web page before we've blit the last update chunk to the backing store
        https://bugs.webkit.org/show_bug.cgi?id=37896

        * Shared/CoreIPCSupport/DrawingAreaMessageKinds.h:
        (DrawingAreaMessage::):
        * UIProcess/mac/DrawingAreaProxyUpdateChunk.h:
        * UIProcess/mac/DrawingAreaProxyUpdateChunk.mm:
        (WebKit::DrawingAreaProxyUpdateChunk::drawUpdateChunkIntoBackingStore):
        (WebKit::DrawingAreaProxyUpdateChunk::update):
        (WebKit::DrawingAreaProxyUpdateChunk::didReceiveMessage):
        * WebProcess/WebPage/mac/DrawingAreaUpdateChunk.cpp:
        (WebKit::DrawingAreaUpdateChunk::DrawingAreaUpdateChunk):
        (WebKit::DrawingAreaUpdateChunk::display):
        (WebKit::DrawingAreaUpdateChunk::scheduleDisplay):
        (WebKit::DrawingAreaUpdateChunk::setSize):
        (WebKit::DrawingAreaUpdateChunk::didUpdate):
        (WebKit::DrawingAreaUpdateChunk::didReceiveMessage):
        * WebProcess/WebPage/mac/DrawingAreaUpdateChunk.h:

2010-04-20  Anders Carlsson  <andersca@apple.com>

        Fix build.

        * WebProcess/WebCoreSupport/WebChromeClient.cpp:
        (WebKit::WebChromeClient::chooseIconForFiles):
        * WebProcess/WebCoreSupport/WebChromeClient.h:

2010-04-19  Anders Carlsson  <andersca@apple.com>

        Fix build.

        * WebProcess/WebCoreSupport/WebFrameLoaderClient.cpp:
        (WebKit::WebFrameLoaderClient::dispatchDidChangeIcons):
        * WebProcess/WebCoreSupport/WebFrameLoaderClient.h:

2010-04-17  Sam Weinig  <weinig@apple.com>

        Reviewed by Jon "The Belly" Honeycutt.

        Remove the need for a .defs file! Define WK_EXPORT.

        * UIProcess/API/C/WKBase.h:
        * WebProcess/win/WebProcessMain.h:
        * win/WebKit2.def: Removed.
        * win/WebKit2.vcproj:

2010-04-17  Sam Weinig  <weinig@apple.com>

        Reviewed by Adam Roben.

        Teach windows MiniBrowser how to work with window.open()
        and targeted links.

        Export WKPageSetPageUIClient.

        * win/WebKit2.def:

2010-04-16  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Fix window.open() and targeted links.

        * UIProcess/WebPageProxy.cpp:
        (WebKit::WebPageProxy::didReceiveSyncMessage): Pass in the new pageID
        instead of 0.

        * WebProcess/WebProcess.cpp:
        (WebKit::WebProcess::createWebPage): Allow for the page to have already
        been created, as is the case with programmatic window opening from within
        WebCore (e.g. window.open() or <a target="_blank">).

2010-04-16  Sam Weinig  <sam@webkit.org>

        Reviewed by Mark Rowe.

        Don't optimize debug builds.

        * WebKit2.xcodeproj/project.pbxproj: Define GCC_OPTIMIZATION_LEVEL correctly.

2010-04-16  Anders Carlsson  <andersca@apple.com>

        Fix build.

        * WebProcess/WebPage/WebPage.cpp:
        (WebKit::WebPage::runJavaScriptInMainFrame):

2010-04-16  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Fix windows build.

        * Platform/win/RunLoopWin.cpp:
        (RunLoop::run):
        * UIProcess/Launcher/win/WebProcessLauncher.cpp:
        (WebKit::webThreadBody):
        (WebKit::launchWebProcess):
        * WebProcess/win/WebProcessMain.cpp:
        (WebKit::WebProcessMain):

2010-04-16  Sam Weinig  <weinig@apple.com>

        Reviewed by Anders Carlsson.

        Make resizing responsive on Windows.

        - Use the same waitFor logic as do for the Mac resizing
          DrawingAreaUpdateChunk code.

        * Shared/win/UpdateChunk.cpp:
        (WebKit::UpdateChunk::UpdateChunk):
        * Shared/win/UpdateChunk.h:
         Add a constructor that only takes an IntRect and allocates
         the shared memory mapping for you.
        * UIProcess/win/DrawingAreaProxy.cpp:
        (WebKit::DrawingAreaProxy::DrawingAreaProxy):
        (WebKit::DrawingAreaProxy::ensureBackingStore):
        (WebKit::DrawingAreaProxy::paint):
        (WebKit::DrawingAreaProxy::drawUpdateChunkIntoBackingStore):
        (WebKit::DrawingAreaProxy::setSize):
        (WebKit::DrawingAreaProxy::didSetSize):
        (WebKit::DrawingAreaProxy::didReceiveMessage):
        * UIProcess/win/DrawingAreaProxy.h:
        Perform wait in paint as we do on the mac.

        * UIProcess/win/WebView.cpp:
        (WebKit::WebView::onSizeEvent):
        Change to use an IntSize.

        * WebProcess/WebPage/win/DrawingAreaUpdateChunk.cpp:
        (WebKit::DrawingAreaUpdateChunk::paintIntoUpdateChunk):
        (WebKit::DrawingAreaUpdateChunk::display):
        (WebKit::DrawingAreaUpdateChunk::setSize):
        * WebProcess/WebPage/win/DrawingAreaUpdateChunk.h:
        Specialize setSize() drawing and factor out painting
        into a helper function.

2010-04-16  Anders Carlsson  <andersca@apple.com>

        Reviewed by David Hyatt.

        Make run loops be allocated as thread specific data.
        https://bugs.webkit.org/show_bug.cgi?id=37723

        * Platform/RunLoop.cpp:
        (RunLoop::initializeMainRunLoop):
        (RunLoop::current):
        (RunLoop::main):
        * Platform/RunLoop.h:
        * Platform/mac/RunLoopMac.mm:
        (RunLoop::run):
        (RunLoop::stop):
        * UIProcess/Launcher/mac/WebProcessLauncher.mm:
        (WebKit::webThreadBody):
        (WebKit::launchWebProcess):
        * UIProcess/ResponsivenessTimer.cpp:
        (WebKit::ResponsivenessTimer::ResponsivenessTimer):
        * WebProcess/Launching/mac/WebProcessMain.mm:
        (main):
        * WebProcess/WebProcess.cpp:
        (WebKit::WebProcess::isSeparateProcess):

2010-04-16  Sam Weinig  <weinig@apple.com>

        Reviewed by Adam Roben.

        Use GDI text rendering on Windows by default.

        * WebProcess/WebPage/win/WebPageWin.cpp:
        (WebKit::WebPage::platformInitialize): Use the AlternateRenderingMode
        setting.

2010-04-16  Sam Weinig  <weinig@apple.com>

        Reviewed by Adam Roben.

        Fix crash when trying to load an invalid URL.

        * WebProcess/WebPage/WebPage.cpp:
        (WebKit::WebPage::loadURL): Use constructor for ResourceRequest
        that takes a KURL instead of the one that takes a String. The one
        that takes a string expects a valid URL.

2010-04-16  Sam Weinig  <weinig@apple.com>

        Reviewed by Adam Roben.

        Make tooltips work. Thanks Adam!

        * UIProcess/win/WebView.cpp:
        (WebKit::WebView::toolTipChanged): Pass the WebView's HWND, not the tooltip's.

2010-04-15  Anders Carlsson  <andersca@apple.com>

        Reviewed by Adam Roben.

        Fix build dependencies.

        * WebKit2.sln:

2010-04-15  Adam Roben  <aroben@apple.com>

        Fix Windows WebKit2 build.

        * UIProcess/WebPageProxy.cpp:
        (WebKit::WebPageProxy::processDidExit):
        * win/WebKit2Generated.make:

2010-04-15  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Add WebHistoryClient support.
        https://bugs.webkit.org/show_bug.cgi?id=37671

        Adds the following callbacks:
            didNavigateWithNavigationData
            didPerformClientRedirect
            didPerformServerRedirect
            didUpdateHistoryTitle

        * Shared/CoreIPCSupport/WebPageProxyMessageKinds.h:
        (WebPageProxyMessage::):
        * Shared/WebNavigationDataStore.h: Added.
        * UIProcess/API/C/WKAPICast.h:
        * UIProcess/API/C/WKBase.h:
        * UIProcess/API/C/WKNavigationData.cpp: Added.
        * UIProcess/API/C/WKNavigationData.h: Added.
        * UIProcess/API/C/WKPage.cpp:
        * UIProcess/API/C/WKPage.h:
        * UIProcess/API/C/WebKit2.h:
        * UIProcess/WebHistoryClient.cpp: Copied from UIProcess/WebUIClient.cpp.
        * UIProcess/WebHistoryClient.h: Copied from UIProcess/WebUIClient.h.
        * UIProcess/WebNavigationData.cpp: Added.
        * UIProcess/WebNavigationData.h: Added.
        * UIProcess/WebPageProxy.cpp:
        * UIProcess/WebPageProxy.h:
        * WebKit2.xcodeproj/project.pbxproj:
        * WebProcess/WebCoreSupport/WebFrameLoaderClient.cpp:
        * win/WebKit2.vcproj:

2010-04-15  Sam Weinig  <sam@webkit.org>

        Reviewed by Adam Roben.

        Remove empty file configurations.

        * win/WebKit2.vcproj:

2010-04-15  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Fix WebKit2s build. Don't return temporaries.

        * UIProcess/API/C/cf/WKStringCF.cpp:
        (WKStringCreateWithCFString):
        * UIProcess/API/C/cf/WKURLCF.cpp:
        (WKURLCreateWithCFURL):
        (WKURLCopyCFURL):

2010-04-12  Geoffrey Garen  <ggaren@apple.com>

        Reviewed by Anders Carlsson.

        Fixed complexity and performance FIXME created by using KURL in the UI
        process -- it turned out that everywhere we were using KURL, we could
        have just used String instead. (That's how Windows WebKit works, too.)

        I kept WKURLRef and WKStringRef distinct opaque types in the API for now,
        though, since there may be profit in changing their backing stores in the
        future, and it's nice for the API to encode a difference between generic
        strings and strings that are valid, canonical URLs.

        * Shared/KURLWrapper.h: Removed. Yay!

        * Shared/WebCoreTypeArgumentMarshalling.h: Nixed KURL marshalling functions.
        Old callers marshal Strings now, instead. (This is what KURL was doing
        under the covers, anyway.)

        * UIProcess/API/C/WKAPICast.h:
        (toWK): Backed by StringImpl* now.
        (toURLRef): Added a disambiguating function for specifying that you want
        a WKURLRef, since StringImpl* converts to WKStringRef by default.

        * UIProcess/API/C/WKFrame.cpp:
        (WKFrameGetProvisionalURL):
        (WKFrameGetURL):
        * UIProcess/API/C/WKPage.cpp:
        (WKPageLoadURL):
        * UIProcess/API/C/WKURL.cpp:
        * UIProcess/API/C/cf/WKURLCF.cpp:
        (WKURLCreateWithCFURL):
        (WKURLCopyCFURL):
        * UIProcess/WebFrameProxy.cpp:
        (WebKit::WebFrameProxy::didStartProvisionalLoad):
        (WebKit::WebFrameProxy::didCommitLoad):
        * UIProcess/WebFrameProxy.h:
        (WebKit::WebFrameProxy::url):
        (WebKit::WebFrameProxy::provisionalURL):
        * UIProcess/WebPageProxy.cpp:
        (WebKit::WebPageProxy::loadURL):
        (WebKit::WebPageProxy::didReceiveMessage):
        (WebKit::WebPageProxy::didStartProvisionalLoadForFrame):
        (WebKit::WebPageProxy::decidePolicyForNavigationAction):
        (WebKit::WebPageProxy::decidePolicyForNewWindowAction):
        (WebKit::WebPageProxy::decidePolicyForMIMEType):
        (WebKit::WebPageProxy::processDidExit):
        * UIProcess/WebPageProxy.h:
        (WebKit::WebPageProxy::urlAtProcessExit):
        * UIProcess/WebPolicyClient.cpp:
        (WebKit::WebPolicyClient::decidePolicyForNavigationAction):
        (WebKit::WebPolicyClient::decidePolicyForNewWindowAction):
        (WebKit::WebPolicyClient::decidePolicyForMIMEType):
        * UIProcess/WebPolicyClient.h:
        * WebKit2.xcodeproj/project.pbxproj:
        * WebProcess/WebCoreSupport/WebFrameLoaderClient.cpp:
        (WebKit::WebFrameLoaderClient::dispatchDidStartProvisionalLoad):
        (WebKit::WebFrameLoaderClient::dispatchDecidePolicyForMIMEType):
        (WebKit::WebFrameLoaderClient::dispatchDecidePolicyForNewWindowAction):
        (WebKit::WebFrameLoaderClient::dispatchDecidePolicyForNavigationAction):
        * WebProcess/WebPage/WebPage.cpp:
        (WebKit::WebPage::loadURL):
        (WebKit::WebPage::didReceiveMessage):
        * WebProcess/WebPage/WebPage.h: Replaced KURL / KURLWrapper with String.

2010-04-14  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Fix horizontal scrollbar repainting
        https://bugs.webkit.org/show_bug.cgi?id=37626

        Make sure that the update chunk is flipped because that's what WebCore expects.
        
        * Shared/mac/UpdateChunk.cpp:
        (WebKit::UpdateChunk::createImage):
        * Shared/mac/UpdateChunk.h:
        Add new createImage member function that creates a CGImageRef from the update chunk.
        
        * UIProcess/mac/DrawingAreaProxyUpdateChunk.mm:
        (WebKit::DrawingAreaProxyUpdateChunk::drawUpdateChunkIntoBackingStore):
        Pass the right rectangle here; CoreGraphics wants it in non-flipped coordinates.
        
        (WebKit::DrawingAreaProxyUpdateChunk::ensureBackingStore):
        Create a flipped backing store.

        * WebProcess/WebPage/mac/DrawingAreaUpdateChunk.cpp:
        (WebKit::DrawingAreaUpdateChunk::paintIntoUpdateChunk):
        Flip the update chunk.

2010-04-14  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Add WKRetainPtr helper class as private header
        https://bugs.webkit.org/show_bug.cgi?id=37603

        WKRetainPtr is just like RetainPtr, but works for WK types instead of
        CF/NS types.

        * UIProcess/API/cpp: Added.
        * UIProcess/API/cpp/WKRetainPtr.h: Added.
        * WebKit2.xcodeproj/project.pbxproj: Add new file.
        * win/WebKit2.vcproj: Ditto.

2010-04-14  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Make the WebProcess a LSUIElement to suppress its icon from the Dock.

        * WebKit2.xcodeproj/project.pbxproj:
        * WebProcess/Info.plist:

2010-04-14  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        Factor code to paint into an update chunk out into a separate function.
        https://bugs.webkit.org/show_bug.cgi?id=37594

        * WebProcess/WebPage/mac/DrawingAreaUpdateChunk.cpp:
        (WebKit::DrawingAreaUpdateChunk::paintIntoUpdateChunk):
        (WebKit::DrawingAreaUpdateChunk::display):
        (WebKit::DrawingAreaUpdateChunk::setSize):
        * WebProcess/WebPage/mac/DrawingAreaUpdateChunk.h:

2010-04-13  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Fix reported leaks when quitting MiniBrowser with open pages.

        * WebProcess/WebPage/WebPage.h: Make close() public.
        * WebProcess/WebProcess.cpp:
        (WebKit::WebProcess::WebProcess):
        (WebKit::WebProcess::removeWebPage):
        (WebKit::WebProcess::didClose): If the UIProcess disappears, close
        the live pages in an effort to not leak.
        * WebProcess/WebProcess.h:

2010-04-13  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Do a JS collection and clear the memory cache to improve leaks output
        when exiting. Only do this in debug builds as it is slow.

        * UIProcess/API/mac/WKView.h:
        * UIProcess/WebProcessProxy.cpp:
        * WebProcess/WebPage/WebPage.cpp:
        * WebProcess/WebProcess.cpp:
        (WebKit::WebProcess::shutdown):
        (WebKit::WebProcess::didClose):

2010-04-13  Sam Weinig  <sam@webkit.org>

        Reviewed by Adele Peterson.

        Post a null event after calling [NSApp stop] to flush the run loop
        and finish teardown.

        * Platform/mac/RunLoopMac.mm:
        (RunLoop::stop):

2010-04-12  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Add #ifdef so that WKView is not included on the mac if not
        compiling objective-c.

        * UIProcess/API/C/WebKit2.h:

2010-04-12  Anders Carlsson  <andersca@apple.com>

        Reviewed by Adam Roben.

        Add WebKit2 solution file.

        * WebKit2.sln: Added.

2010-04-11  Sam Weinig  <sam@webkit.org>

        Reviewed by Darin Adler.

        Fix for https://bugs.webkit.org/show_bug.cgi?id=37417
        Move duplicated internal CoreIPC message kinds to a
        header.

        * Platform/CoreIPC/Connection.cpp:
        (CoreIPC::Connection::processIncomingMessage):
        * Platform/CoreIPC/CoreIPCMessageKinds.h: Added.
        (CoreIPC::CoreIPCMessage::):
        (CoreIPC::):
        * Platform/CoreIPC/mac/ConnectionMac.cpp:
        * WebKit2.xcodeproj/project.pbxproj:
        * win/WebKit2.vcproj:

2010-04-11  Sam Weinig  <sam@webkit.org>

        Rubber-stamped by Anders Carlsson.

        Disable not-implemented warnings by default for now.

        * Shared/NotImplemented.h:

2010-04-10  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Fix for https://bugs.webkit.org/show_bug.cgi?id=37399
        Remove use of STL data structures from CoreIPC code

        * Platform/CoreIPC/ArgumentDecoder.cpp:
        (CoreIPC::ArgumentDecoder::ArgumentDecoder):
        (CoreIPC::ArgumentDecoder::decodeBytes):
        (CoreIPC::ArgumentDecoder::removeAttachment):
        * Platform/CoreIPC/ArgumentDecoder.h:
        Use WTF::Deque instead of std::queue and WTF::Vector
        instead of std::vector. Replace use of malloc/free with 
        fastMalloc/fastFree.

        * Platform/CoreIPC/ArgumentEncoder.cpp:
        (CoreIPC::ArgumentEncoder::addAttachment):
        (CoreIPC::ArgumentEncoder::releaseAttachments):
        * Platform/CoreIPC/ArgumentEncoder.h:
        Use WTF::Vector instead of std::list. Replace use of malloc/free
        with fastMalloc/fastFree.

        * Platform/CoreIPC/Connection.cpp:
        (CoreIPC::Connection::sendMessage):
        (CoreIPC::Connection::waitForMessage):
        (CoreIPC::Connection::processIncomingMessage):
        (CoreIPC::Connection::sendOutgoingMessages):
        (CoreIPC::Connection::dispatchMessages):
        * Platform/CoreIPC/Connection.h:
        * Platform/CoreIPC/mac/ConnectionMac.cpp:
        (CoreIPC::Connection::sendOutgoingMessage):
        (CoreIPC::createArgumentDecoder):
        Use WTF::Vector instead of std::queue.

        * Platform/RunLoop.cpp:
        (RunLoop::performWork):
        (RunLoop::scheduleWork):
        * Platform/RunLoop.h:
        Ditto.

        * Platform/WorkQueue.h:
        * Platform/win/WorkQueueWin.cpp:
        (WorkQueue::scheduleWork):
        (WorkQueue::performWork):
        Ditto.

2010-04-10  Mark Rowe  <mrowe@apple.com>

        Fix an obviously incorrect part of the Xcode configuration cleanup that resulted in debug builds
        asserting shortly after launch.

        * WebKit2.xcodeproj/project.pbxproj: Fix the setting of DEBUG_DEFINES for the Debug configuration.

2010-04-09  Mark Rowe  <mrowe@apple.com>

        Reviewed by Sam Weinig.

        Bring the WebKit2 Xcode configuration in to sync with recent changes to the WebKit Xcode configuration files.

        In particular, this updates the FEATURE_DEFINES to match those used in the other projects, and brings in
        the changes to support building WebKit for older Mac OS X versions from the current Mac OS X version.

        * Configurations/Base.xcconfig:
        * Configurations/DebugRelease.xcconfig:
        * Configurations/FeatureDefines.xcconfig:
        * Configurations/Version.xcconfig:

2010-04-09  Mark Rowe  <mrowe@apple.com>

        Reviewed by Sam Weinig.

        Clean up the Xcode project configuration.

        Common target settings are pulled out in to BaseTarget.xcconfig.  The majority of setting overrides are
        removed from the Xcode project itself.  Info.plist files are updated to match those used in other frameworks.

        * Configurations/BaseTarget.xcconfig: Copied from WebKit2/Configurations/WebKit2.xcconfig.
        * Configurations/WebKit2.xcconfig:
        * Configurations/WebProcess.xcconfig: Copied from WebKit2/Configurations/WebKit2.xcconfig.
        * Info.plist:
        * WebKit2.xcodeproj/project.pbxproj:
        * WebProcess-Info.plist: Removed.
        * WebProcess/Info.plist: Moved from WebProcess-Info.plist.

2010-04-09  Mark Rowe  <mrowe@apple.com>

        Build fix.

        * WebProcess/WebCoreSupport/mac/WebSystemInterface.m:
        (InitWebCoreSystemInterface): Update for recent WKSI changes.

2010-04-09  Sam Weinig  <sam@webkit.org>

        Reviewed by Darin Adler.

        Fix for https://bugs.webkit.org/show_bug.cgi?id=37351
        Cannot build with build-webkit --webkit2

        Add some headers that it seems others are not getting
        already.

        * Platform/mac/WorkQueueMac.cpp: #inlude <mach/mach_port.h>
        * Shared/mac/UpdateChunk.cpp: #inlude <mach/vm_map.h>

2010-04-09  Anders Carlsson  <andersca@apple.com>

        More build fixes.
        
        * WebProcess/win/WebProcessMain.h:
        Include windows.h here.
        
        * win/WebKit2.def:
        Add new exports.

        * win/WebKit2.vcproj:
        Add new files.

2010-04-09  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Add new WKString.h and WKURL.h headers to top
        level include.

        * UIProcess/API/C/WebKit2.h:

2010-04-09  Anders Carlsson  <andersca@apple.com>

        More Windows build fixes.
        
        * Shared/NotImplemented.h:
        * UIProcess/API/C/cf/WKURLCF.cpp:
        Fix typo.
        
        (WKURLCreateWithCFURL):
        * UIProcess/API/C/cf/WKURLCF.h:
        Ditto.
        
        * win/WebKit2Generated.make:
        Copy the new CF headers.

2010-04-09  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Two more #include sorting issues.

        * Shared/NotImplemented.h:
        * WebProcess/WebPage/win/DrawingAreaUpdateChunk.cpp:

2010-04-09  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Fix minor style nits found by the style-script.

        * Platform/CoreIPC/ArgumentDecoder.h:
        * Platform/CoreIPC/ArgumentEncoder.cpp:
        * Platform/CoreIPC/Attachment.cpp:
        * Platform/CoreIPC/Connection.cpp:
        * Platform/CoreIPC/Connection.h:
        * Platform/CoreIPC/mac/ConnectionMac.cpp:
        * Platform/CoreIPC/win/ConnectionWin.cpp:
        * Platform/WorkQueue.h:
        * Platform/mac/WorkQueueMac.cpp:
        * Platform/win/RunLoopWin.cpp:
        * Shared/KURLWrapper.h:
        * Shared/WebCoreTypeArgumentMarshalling.h:
        * Shared/mac/UpdateChunk.cpp:
        * UIProcess/API/C/WKPage.cpp:
        * UIProcess/API/C/WKURL.cpp:
        * UIProcess/Launcher/win/WebProcessLauncher.cpp:
        * UIProcess/ResponsivenessTimer.cpp:
        * UIProcess/WebLoaderClient.cpp:
        * UIProcess/WebPageProxy.h:
        * UIProcess/WebPolicyClient.cpp:
        * UIProcess/WebUIClient.cpp:
        * UIProcess/win/DrawingAreaProxy.cpp:
        * UIProcess/win/WebView.cpp:
        * WebProcess/Launching/win/WebProcessWinMain.cpp:
        * WebProcess/WebCoreSupport/WebChromeClient.cpp:
        * WebProcess/WebCoreSupport/WebFrameLoaderClient.cpp:
        * WebProcess/WebCoreSupport/mac/WebSystemInterface.h:
        * WebProcess/WebCoreSupport/win/WebCoreLocalizedStrings.cpp:
        * WebProcess/WebCoreSupport/win/WebErrorsWin.cpp:
        * WebProcess/WebPage/WebFrame.h:
        * WebProcess/WebPage/WebPage.cpp:
        * WebProcess/WebPage/mac/DrawingAreaUpdateChunk.cpp:
        * WebProcess/WebProcess.h:
        * WebProcess/win/WebLocalizableStrings.cpp:
        * WebProcess/win/WebLocalizableStrings.h:
        * WebProcess/win/WebProcessMain.cpp:

2010-04-09  Anders Carlsson  <andersca@apple.com>

        Fix Windows build.

        * Shared/NotImplemented.h:
        Include stdio.h.

2010-04-09  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Fix for https://bugs.webkit.org/show_bug.cgi?id=37347
        Don't use CF types in the new C API

        Replace all uses of CF types in the C API.
        - Replace CFStringRef with WKStringRef.
        - Replace CFURLRef with WKURLRef.

        * WebKit2.xcodeproj/project.pbxproj: Add new files.

        * Shared/KURLWrapper.h: Added. RefCounted wrapper around KURL.
        * UIProcess/API/C/WKAPICast.h: Add new conversions.
        * UIProcess/API/C/WKBase.h: Add new types.
        * UIProcess/API/C/WKFrame.cpp:
        * UIProcess/API/C/WKFrame.h: 
        * UIProcess/API/C/WKPage.cpp:
        * UIProcess/API/C/WKPage.h:
        Replace uses of CF types with WK equivalents.

        * UIProcess/API/C/WKString.cpp: Added.
        * UIProcess/API/C/WKString.h: Added.
        Represents a WebCore::StringImpl*.

        * UIProcess/API/C/WKURL.cpp: Added.
        * UIProcess/API/C/WKURL.h: Added.
        Represents a WebKit::KURLWrapper*.

        * UIProcess/API/C/cf: Added.
        * UIProcess/API/C/cf/WKStringCF.cpp: Added.
        * UIProcess/API/C/cf/WKStringCF.h: Added.
        * UIProcess/API/C/cf/WKURLCF.cpp: Added.
        * UIProcess/API/C/cf/WKURLCF.h: Added.
        CoreFoundation conversion files. Allows converting
         WKStringRef <-> CFStringRef
         WKURLRef <-> CFURLRef

        * UIProcess/ScriptReturnValueCallback.cpp:
        (WebKit::ScriptReturnValueCallback::performCallbackWithReturnValue):
        * UIProcess/ScriptReturnValueCallback.h:
        * UIProcess/WebFrameProxy.cpp:
        (WebKit::WebFrameProxy::didStartProvisionalLoad):
        (WebKit::WebFrameProxy::didCommitLoad):
        * UIProcess/WebFrameProxy.h:
        (WebKit::WebFrameProxy::url):
        (WebKit::WebFrameProxy::provisionalURL):
        * UIProcess/WebLoaderClient.cpp:
        (WebKit::WebLoaderClient::didReceiveTitleForFrame):
        * UIProcess/WebLoaderClient.h:
        * UIProcess/WebPageProxy.cpp:
        (WebKit::WebPageProxy::close):
        (WebKit::WebPageProxy::didReceiveTitleForFrame):
        (WebKit::WebPageProxy::decidePolicyForNavigationAction):
        (WebKit::WebPageProxy::decidePolicyForNewWindowAction):
        (WebKit::WebPageProxy::decidePolicyForMIMEType):
        (WebKit::WebPageProxy::runJavaScriptAlert):
        (WebKit::WebPageProxy::didRunJavaScriptInMainFrame):
        (WebKit::WebPageProxy::processDidExit):
        * UIProcess/WebPageProxy.h:
        (WebKit::WebPageProxy::pageTitle):
        (WebKit::WebPageProxy::urlAtProcessExit):
        * UIProcess/WebPolicyClient.cpp:
        (WebKit::WebPolicyClient::decidePolicyForNavigationAction):
        (WebKit::WebPolicyClient::decidePolicyForNewWindowAction):
        (WebKit::WebPolicyClient::decidePolicyForMIMEType):
        * UIProcess/WebPolicyClient.h:
        * UIProcess/WebUIClient.cpp:
        (WebKit::WebUIClient::runJavaScriptAlert):
        * UIProcess/WebUIClient.h:
        Don't use CF types internally at all.

        * WebProcess/WebCoreSupport/WebFrameLoaderClient.cpp:
        (WebKit::WebFrameLoaderClient::frameLoaderDestroyed):
        Fix typo.

2010-04-08  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        Add build support for WebKit2.

        * Configurations: Added.
        * Configurations/Base.xcconfig: Added.
        * Configurations/DebugRelease.xcconfig: Added.
        * Configurations/FeatureDefines.xcconfig: Added.
        * Configurations/Version.xcconfig: Added.
        * Configurations/WebKit2.xcconfig: Added.
        * English.lproj: Added.
        * English.lproj/InfoPlist.strings: Added.
        * Info.plist: Added.
        * Makefile: Added.
        * WebKit2.xcodeproj: Added.
        * WebKit2.xcodeproj/project.pbxproj: Added.
        * WebKit2Prefix.cpp: Added.
        * WebKit2Prefix.h: Added.
        * WebKit2_Prefix.pch: Added.
        * WebProcess-Info.plist: Added.
        * version.plist: Added.
        * win: Added.
        * win/WebKit2.def: Added.
        * win/WebKit2.vcproj: Added.
        * win/WebKit2Generated.make: Added.
        * win/WebKit2Generated.vcproj: Added.
        * win/WebKit2WebProcess.vcproj: Added.

2010-04-08  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig.

        https://bugs.webkit.org/show_bug.cgi?id=37301
        Add WebKit2/UIProcess directory.

        * UIProcess: Added.
        * UIProcess/API: Added.
        * UIProcess/API/C: Added.
        * UIProcess/API/C/WKAPICast.h: Added.
        * UIProcess/API/C/WKBase.h: Added.
        * UIProcess/API/C/WKContext.cpp: Added.
        * UIProcess/API/C/WKContext.h: Added.
        * UIProcess/API/C/WKFrame.cpp: Added.
        * UIProcess/API/C/WKFrame.h: Added.
        * UIProcess/API/C/WKFramePolicyListener.cpp: Added.
        * UIProcess/API/C/WKFramePolicyListener.h: Added.
        * UIProcess/API/C/WKPage.cpp: Added.
        * UIProcess/API/C/WKPage.h: Added.
        * UIProcess/API/C/WKPageNamespace.cpp: Added.
        * UIProcess/API/C/WKPageNamespace.h: Added.
        * UIProcess/API/C/WKPreferences.cpp: Added.
        * UIProcess/API/C/WKPreferences.h: Added.
        * UIProcess/API/C/WebKit2.h: Added.
        * UIProcess/API/mac: Added.
        * UIProcess/API/mac/PageClientImpl.h: Added.
        * UIProcess/API/mac/PageClientImpl.mm: Added.
        * UIProcess/API/mac/WKView.h: Added.
        * UIProcess/API/mac/WKView.mm: Added.
        * UIProcess/API/mac/WKViewInternal.h: Added.
        * UIProcess/API/win: Added.
        * UIProcess/API/win/WKAPICastWin.h: Added.
        * UIProcess/API/win/WKBaseWin.h: Added.
        * UIProcess/API/win/WKView.cpp: Added.
        * UIProcess/API/win/WKView.h: Added.
        * UIProcess/Launcher: Added.
        * UIProcess/Launcher/WebProcessLauncher.h: Added.
        * UIProcess/Launcher/mac: Added.
        * UIProcess/Launcher/mac/WebProcessLauncher.mm: Added.
        * UIProcess/Launcher/win: Added.
        * UIProcess/Launcher/win/WebProcessLauncher.cpp: Added.
        * UIProcess/PageClient.h: Added.
        * UIProcess/ProcessModel.h: Added.
        * UIProcess/ResponsivenessTimer.cpp: Added.
        * UIProcess/ResponsivenessTimer.h: Added.
        * UIProcess/ScriptReturnValueCallback.cpp: Added.
        * UIProcess/ScriptReturnValueCallback.h: Added.
        * UIProcess/WebContext.cpp: Added.
        * UIProcess/WebContext.h: Added.
        * UIProcess/WebFramePolicyListenerProxy.cpp: Added.
        * UIProcess/WebFramePolicyListenerProxy.h: Added.
        * UIProcess/WebFrameProxy.cpp: Added.
        * UIProcess/WebFrameProxy.h: Added.
        * UIProcess/WebLoaderClient.cpp: Added.
        * UIProcess/WebLoaderClient.h: Added.
        * UIProcess/WebPageNamespace.cpp: Added.
        * UIProcess/WebPageNamespace.h: Added.
        * UIProcess/WebPageProxy.cpp: Added.
        * UIProcess/WebPageProxy.h: Added.
        * UIProcess/WebPolicyClient.cpp: Added.
        * UIProcess/WebPolicyClient.h: Added.
        * UIProcess/WebPreferences.cpp: Added.
        * UIProcess/WebPreferences.h: Added.
        * UIProcess/WebProcessManager.cpp: Added.
        * UIProcess/WebProcessManager.h: Added.
        * UIProcess/WebProcessProxy.cpp: Added.
        * UIProcess/WebProcessProxy.h: Added.
        * UIProcess/WebUIClient.cpp: Added.
        * UIProcess/WebUIClient.h: Added.
        * UIProcess/mac: Added.
        * UIProcess/mac/DrawingAreaProxy.h: Added.
        * UIProcess/mac/DrawingAreaProxy.mm: Added.
        * UIProcess/mac/DrawingAreaProxyUpdateChunk.h: Added.
        * UIProcess/mac/DrawingAreaProxyUpdateChunk.mm: Added.
        * UIProcess/win: Added.
        * UIProcess/win/DrawingAreaProxy.cpp: Added.
        * UIProcess/win/DrawingAreaProxy.h: Added.
        * UIProcess/win/WebView.cpp: Added.
        * UIProcess/win/WebView.h: Added.

2010-04-08  Anders Carlsson  <andersca@apple.com>

        Reviewed by Sam Weinig and Oliver Hunt.

        https://bugs.webkit.org/show_bug.cgi?id=37300
        Add WebKit2/WebProcess directory.

        * WebProcess: Added.
        * WebProcess/Launching: Added.
        * WebProcess/Launching/mac: Added.
        * WebProcess/Launching/mac/WebProcessMain.mm: Added.
        * WebProcess/Launching/win: Added.
        * WebProcess/Launching/win/WebProcessWinMain.cpp: Added.
        * WebProcess/WebCoreSupport: Added.
        * WebProcess/WebCoreSupport/WebChromeClient.cpp: Added.
        * WebProcess/WebCoreSupport/WebChromeClient.h: Added.
        * WebProcess/WebCoreSupport/WebContextMenuClient.cpp: Added.
        * WebProcess/WebCoreSupport/WebContextMenuClient.h: Added.
        * WebProcess/WebCoreSupport/WebDragClient.cpp: Added.
        * WebProcess/WebCoreSupport/WebDragClient.h: Added.
        * WebProcess/WebCoreSupport/WebEditorClient.cpp: Added.
        * WebProcess/WebCoreSupport/WebEditorClient.h: Added.
        * WebProcess/WebCoreSupport/WebErrors.h: Added.
        * WebProcess/WebCoreSupport/WebFrameLoaderClient.cpp: Added.
        * WebProcess/WebCoreSupport/WebInspectorClient.h: Added.
        * WebProcess/WebCoreSupport/mac: Added.
        * WebProcess/WebCoreSupport/mac/WebErrorsMac.mm: Added.
        * WebProcess/WebCoreSupport/mac/WebSystemInterface.h: Added.
        * WebProcess/WebCoreSupport/mac/WebSystemInterface.m: Added.
        * WebProcess/WebCoreSupport/win: Added.
        * WebProcess/WebCoreSupport/win/WebCoreLocalizedStrings.cpp: Added.
        * WebProcess/WebCoreSupport/win/WebErrorsWin.cpp: Added.
        * WebProcess/WebPage: Added.
        * WebProcess/WebPage/DrawingArea.cpp: Added.
        * WebProcess/WebPage/DrawingArea.h: Added.
        * WebProcess/WebPage/WebFrame.cpp: Added.
        * WebProcess/WebPage/WebFrame.h: Added.
        * WebProcess/WebPage/WebPage.cpp: Added.
        * WebProcess/WebPage/WebPage.h: Added.
        * WebProcess/WebPage/mac: Added.
        * WebProcess/WebPage/mac/DrawingAreaUpdateChunk.cpp: Added.
        * WebProcess/WebPage/mac/DrawingAreaUpdateChunk.h: Added.
        * WebProcess/WebPage/mac/WebPageMac.mm: Added.
        * WebProcess/WebPage/win: Added.
        * WebProcess/WebPage/win/DrawingAreaUpdateChunk.cpp: Added.
        * WebProcess/WebPage/win/DrawingAreaUpdateChunk.h: Added.
        * WebProcess/WebPage/win/WebPageWin.cpp: Added.
        * WebProcess/WebProcess.cpp: Added.
        * WebProcess/WebProcess.h: Added.
        * WebProcess/win: Added.
        * WebProcess/win/DllMain.cpp: Added.
        * WebProcess/win/WebLocalizableStrings.cpp: Added.
        * WebProcess/win/WebLocalizableStrings.h: Added.
        * WebProcess/win/WebProcessMain.cpp: Added.
        * WebProcess/win/WebProcessMain.h: Added.

2010-04-08  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        https://bugs.webkit.org/show_bug.cgi?id=37295
        Add WebKit2/Shared directory.

        * Shared: Added.
        * Shared/CoreIPCSupport: Added.
        * Shared/CoreIPCSupport/DrawingAreaMessageKinds.h: Added.
        * Shared/CoreIPCSupport/DrawingAreaProxyMessageKinds.h: Added.
        * Shared/CoreIPCSupport/WebPageMessageKinds.h: Added.
        * Shared/CoreIPCSupport/WebPageProxyMessageKinds.h: Added.
        * Shared/CoreIPCSupport/WebProcessMessageKinds.h: Added.
        * Shared/NotImplemented.h: Added.
        * Shared/WebCoreTypeArgumentMarshalling.h: Added.
        * Shared/WebEvent.h: Added.
        * Shared/WebEventConversion.cpp: Added.
        * Shared/WebEventConversion.h: Added.
        * Shared/WebPreferencesStore.cpp: Added.
        * Shared/WebPreferencesStore.h: Added.
        * Shared/mac: Added.
        * Shared/mac/UpdateChunk.cpp: Added.
        * Shared/mac/UpdateChunk.h: Added.
        * Shared/mac/WebEventFactory.h: Added.
        * Shared/mac/WebEventFactory.mm: Added.
        * Shared/win: Added.
        * Shared/win/UpdateChunk.cpp: Added.
        * Shared/win/UpdateChunk.h: Added.
        * Shared/win/WebEventFactory.cpp: Added.
        * Shared/win/WebEventFactory.h: Added.

2010-04-08  Sam Weinig  <sam@webkit.org>

        Reviewed by Anders Carlsson.

        https://bugs.webkit.org/show_bug.cgi?id=37293
        Add WebKit2/Platform directory.

        * Platform: Added.
        * Platform/CoreIPC: Added.
        * Platform/CoreIPC/ArgumentDecoder.cpp: Added.
        * Platform/CoreIPC/ArgumentDecoder.h: Added.
        * Platform/CoreIPC/ArgumentEncoder.cpp: Added.
        * Platform/CoreIPC/ArgumentEncoder.h: Added.
        * Platform/CoreIPC/Arguments.h: Added.
        * Platform/CoreIPC/Attachment.cpp: Added.
        * Platform/CoreIPC/Attachment.h: Added.
        * Platform/CoreIPC/Connection.cpp: Added.
        * Platform/CoreIPC/Connection.h: Added.
        * Platform/CoreIPC/MessageID.h: Added.
        * Platform/CoreIPC/mac: Added.
        * Platform/CoreIPC/mac/ConnectionMac.cpp: Added.
        * Platform/CoreIPC/mac/MachPort.h: Added.
        * Platform/CoreIPC/win: Added.
        * Platform/CoreIPC/win/ConnectionWin.cpp: Added.
        * Platform/PlatformProcessIdentifier.h: Added.
        * Platform/RunLoop.cpp: Added.
        * Platform/RunLoop.h: Added.
        * Platform/WorkItem.h: Added.
        * Platform/WorkQueue.cpp: Added.
        * Platform/WorkQueue.h: Added.
        * Platform/mac: Added.
        * Platform/mac/RunLoopMac.mm: Added.
        * Platform/mac/WorkQueueMac.cpp: Added.
        * Platform/win: Added.
        * Platform/win/RunLoopWin.cpp: Added.

2010-04-08  Sam Weinig  <sam@webkit.org>

        Rubber-stamped by Mark Rowe.

        Add WebKit2 directory.
