2006-04-07  John Sullivan  <sullivan@apple.com>

        Reviewed by Tim Omernick.
        
        - fixed <rdar://problem/4507054> If an icon file is removed from disk behind Safari's back, 
        Safari will not try to refetch it
        
        In addition to letting WebIconDatabase recover from disk/memory mismatches as per 4507054, I also found
        a bug in the way icons are remembered that could account for some of the other cases where
        site icons didn't appear (and you'd get an ERROR on debug builds about WebIconDatabase saying it
        had some icon when it really doesn't).

        * Misc/WebIconDatabase.m:
        (-[WebIconDatabase iconForURL:withSize:cache:]):
        When the icon file for a previously-saved site icon isn't found, forget about the darn icon URL thoroughly
        so that this situation is self-correcting. Formerly, once you got into this state WebKit would never find
        the icon again (short of removing the entire icon database cleanly). Note that this does *not* change
        the behavior of sites that didn't have a site icon when WebKit checked -- these will continue to not
        return a site icon indefinitely (that's a separate, possibly performance-sensitive issue).
        (-[WebIconDatabase _retainIconForIconURLString:]):
        This code did the wrong thing in the case where an icon was in the process of being forgotten about. In
        that case, the icon would still be in _private->iconsOnDiskWithURLs, so we wouldn't try to save it here,
        so the new icon wouldn't stick.

2006-04-07  David Hyatt  <hyatt@apple.com>

        Re-enable coalesced updates.  Our move to a single timer has essentially
        implemented coalescing of updates anyway, so the regression has already
        come back.  Since we have to deal with that now anyway, there's no reason
        to visually tear also. :)

        Reviewed by darin

        * ChangeLog:
        * WebView/WebView.m:
        (-[WebView _commonInitializationWithFrameName:groupName:]):

2006-04-05  Darin Adler  <darin@apple.com>

        - fixed a storage leak from that last check-in

        * WebView/WebUnarchivingState.m: (-[WebUnarchivingState dealloc]):
        Release the two dictionaries.

2006-04-05  Maciej Stachowiak  <mjs@apple.com>

        Reviewed by Eric.
        
        - start on factoring WebArchive unpacking more into a separate class.
        http://bugzilla.opendarwin.org/show_bug.cgi?id=8208
        
        * WebKit.xcodeproj/project.pbxproj:
        * WebView/WebDataSource.m:
        (-[WebDataSourcePrivate dealloc]):
        (-[WebDataSource _addToUnarchiveState:]):
        (-[WebDataSource _popSubframeArchiveWithName:]):
        (-[WebDataSource _documentFragmentWithArchive:]):
        (-[WebDataSource _setupForReplaceByMIMEType:]):
        (-[WebDataSource subresourceForURL:]):
        * WebView/WebDataSourcePrivate.h:
        * WebView/WebFrame.m:
        (-[WebFrame _loadRequest:archive:]):
        (-[WebFrame loadRequest:]):
        (-[WebFrame loadArchive:]):
        * WebView/WebFramePrivate.h:
        * WebView/WebHTMLRepresentation.m:
        (-[WebHTMLRepresentation loadArchive]):
        * WebView/WebUnarchivingState.h: Added.
        * WebView/WebUnarchivingState.m: Added.
        (-[WebUnarchivingState init]):
        (-[WebUnarchivingState addArchive:]):
        (-[WebUnarchivingState archivedResourceForURL:]):
        (-[WebUnarchivingState popSubframeArchiveWithFrameName:]):

2006-04-04  Timothy Hatcher  <timothy@apple.com>

        Reviewed by Darin.

        The Debug and Release frameworks are now built with install paths relative to the build products directory.
        This removes the need for other projects to build with -framework WebCore and -framework JavaScriptCore. 

        * WebKit.xcodeproj/project.pbxproj:

2006-04-04  John Sullivan  <sullivan@apple.com>

        Reviewed by Adele Peterson.

        - WebKit part of <rdar://problem/4498418> "Autosaved" searchterms are saved during private browsing

        * WebView/WebView.m:
        (-[WebView _updateWebCoreSettingsFromPreferences:]):
        Pass private browsing setting down to WebCore.

2006-04-03  John Sullivan  <sullivan@apple.com>

        Reviewed by Tim Hatcher.
        
        - re-fixed <rdar://problem/4481198> REGRESSION (TOT): search results list in bookmarks view 
        remains when search text is deleted

        * WebView/WebView.m:
        (-[WebView searchFor:direction:caseSensitive:wrap:]):
        I fixed this recently, but then broke it again by adding an early bail-out to this method. So
        now I'm removing the early bail-out.

2006-04-02  Trey Matteson  <trey@usa.net>

        Reviewed by Maciej.

        fix http://bugzilla.opendarwin.org/show_bug.cgi?id=8121
        REGRESSION: 404s are not displayed

        * WebView/WebMainResourceLoader.m:
        (-[WebMainResourceLoader continueAfterContentPolicy:response:]):
        Only cancel failed loads for object elements, not for frames or a whole page.

2006-04-02  Maciej Stachowiak  <mjs@apple.com>

        Reviewed by Hyatt.

        - fixed <rdar://problem/4198619> REGRESSION: tabbing through links fails after hitting text field w/ sys's "tab to all controls" off
        - fixed <rdar://problem/4463760> REGRESSION: Can't tab from old text field (like password fields) to new text field (6811)
        (http://bugzilla.opendarwin.org/show_bug.cgi?id=6811)
        - fixed tab and shift tab don't select the right things
        http://bugzilla.opendarwin.org/show_bug.cgi?id=5685

        * WebCoreSupport/WebFrameBridge.m:
        (-[WebFrameBridge willMakeFirstResponderForNodeFocus]): New method
        - let WebHTMLView know that the next time it becomes first
        responder, it's to change focus within the page and the right node
        has already been set, so it should not move focus forward or
        backward inside it.
        * WebView/WebHTMLView.m:
        (-[NSArray needsPanelToBecomeKey]): Override to return YES, oddly enough this
        is the right way to tell AppKit that you should be in the tab cycle loop.
        (-[NSArray becomeFirstResponder]): Don't move forward or back in tab cycle
        when this becomeFirstResponder is for tabbing from a control in the page.
        (-[WebHTMLView _willMakeFirstResponderForNodeFocus]): Note that the next
        time this view becomes first responder, it will be for in-page focus 
        navigation.
        * WebView/WebHTMLViewInternal.h:

2006-04-01  Darin Adler  <darin@apple.com>

        Reviewed by Maciej.

        - fix http://bugzilla.opendarwin.org/show_bug.cgi?id=8105
          REGRESSION (NativeTextField): Option-delete deletes one space before the deleted word

        Test: fast/forms/input-text-option-delete.html

        * WebView/WebHTMLView.m:
        (-[WebHTMLView _deleteWithDirection:granularity:killRing:isTypingAction:]): Pass NO for
        smartDeleteOK. Smart deletion only applies to deleting a word at a time, and none of
        the callers of this function that delete a word at a time want smart deletion.
        (-[WebHTMLView deleteToEndOfLine:]): Fixed tiny formatting glitch.

2006-03-31  Timothy Hatcher  <timothy@apple.com>

        Reviewed by Darin.

        We need to set reachedTerminalState to YES before we release
        the resources to prevent a double dealloc of WebView

        Fixes <rdar://problem/4372628> crash deallocating a WebView in -[WebFrame stopLoading]

        * WebView/WebLoader.m:
        (-[NSURLProtocol releaseResources]): set reachedTerminalState earlier

2006-03-31  John Sullivan  <sullivan@apple.com>

        Reviewed by Tim Omernick.
        
        Some cleanup in the WebIconDatabase code in a fruitless search for the cause
        of the mysterious -[WebFileDatabase performSetObject:forKey] crash

        * Misc/WebIconDatabase.m:
        (-[WebIconDatabase _createFileDatabase]):
        removed obsolete comment
        (-[WebIconDatabase _loadIconDictionaries]):
        Added ERRORs for unexpected early returns. Made dictionaries be autoreleased until
        the end of the method where they are retained, so that the early returns don't leak;
        added ASSERTs that the _private->dictionary values aren't being leaked.
        (-[WebIconDatabase _updateFileDatabase]):
        Added an ERROR for an unexpected early return, and made a trivial style fix.

2006-03-31  Trey Matteson  <trey@usa.net>

        Reviewed by Maciej, landed by ap.

        http://bugzilla.opendarwin.org/show_bug.cgi?id=7739
        REGRESSION: Assertion failure loading acid2 test in -[WebCoreFrameBridge installInFrame:]

        Tests: http/tests/misc/acid2.html, http/tests/misc/acid2-pixel.html

        The gist of this change is that we must cancel the load from the Webkit side when we
        realize we're switching to the fallback content.  This is somewhat a temp workaround
        since control of loading will be moving to WebCore.

        * WebView/WebMainResourceLoader.m:
        (-[WebMainResourceLoader continueAfterContentPolicy:response:]):

2006-03-30  Justin Garcia  <justin.garcia@apple.com>

        Reviewed by darin
        
        http://bugzilla.opendarwin.org/show_bug.cgi?id=6989
        REGRESSION: Plain-text mode needed for contenteditable area used in new text field

        * WebView/WebHTMLView.m:
        (-[WebHTMLView _canEditRichly]): Added.
        (-[WebHTMLView _canIncreaseSelectionListLevel]): Use _canEditRichly
        (-[WebHTMLView _canDecreaseSelectionListLevel]): Ditto.
        (-[WebHTMLView _increaseSelectionListLevel]):
        (-[WebHTMLView _decreaseSelectionListLevel]):
        (-[NSArray validateUserInterfaceItem:]): 
        Split rich text editing actions off from ones that can be applied anywhere.
        (-[NSArray _applyStyleToSelection:withUndoAction:]):
        (-[NSArray _applyParagraphStyleToSelection:withUndoAction:]):
        (-[NSArray _alignSelectionUsingCSSValue:withUndoAction:]):
        * WebView/WebHTMLViewPrivate.h:

2006-03-29  Tim Omernick  <timo@apple.com>

        Reviewed by John Sullivan.

        <rdar://problem/4495316> REGRESSION (420+): After page has loaded, spinning progress indicator is displayed on
        tab at versiontracker.com

        * WebView/WebFrame.m:
        (-[WebFrame _receivedMainResourceError:]):
        Call -_clientRedirectCancelledOrFinished: here so that the frame load delegate is notified that the redirect's
        status has changed, if there was a redirect.  The frame load delegate may have saved some state about
        the redirect in its -webView:willPerformClientRedirectToURL:delay:fireDate:forFrame:.  Since we are definitely
        not going to use this provisional resource, as it was cancelled, notify the frame load delegate that the redirect
        has ended.
        The fix for 4432562 was similar to this, but only took care of the case where the redirect load was actually
        committed to the frame.  The new call to -_clientRedirectCancelledOrFinished: handles the case where the redirect
        load was successful, but was not committed.  This happens with downloads.
        
2006-03-29  John Sullivan  <sullivan@apple.com>

        Reviewed by Tim Omernick.
        
        - fixed these bugs:
        <rdar://problem/4483806> REGRESSION (417.8-TOT): PDFs don't scale correctly with auto-size (5356)
        <rdar://problem/3874856> Safari PDF display should be full width by default rather than 
        sized to show the entire page

        * WebView/WebPDFRepresentation.m:
        (-[WebPDFRepresentation finishedLoadingWithDataSource:]):
        Let the WebPDFView handle setting the document, because that's the best time to apply
        the sizing-related preferences.
        
        * WebView/WebPDFView.h:
        eliminated firstLayoutDone ivar and -PDFSubview public method; added -setPDFDocument:
        
        * WebView/WebPDFView.m:
        (-[WebPDFView initWithFrame:]):
        eliminate use of obsolete firstLayoutDone ivar
        (-[WebPDFView _applyPDFDefaults]):
        renamed from _readPDFDefaults for clarity
        (-[WebPDFView layout]):
        removed code that applied the preferences here. This was too early to handle auto-sizing correctly,
        because -layout can be called before the document exists, and calling setAutoSize:YES at that
        point confuses PDFView into setting the scale factor to 20 (the maximum).
        (-[WebPDFView setPDFDocument:]):
        New method, does what WebPDFRepresentation used to do and also applies the preferences here.
        This is a good place to apply them because the document is guaranteed to now exist (of course).
        (-[WebPDFView PDFSubview]):
        Moved this into a new FileInternal category because it's still needed by another class in
        this file but no longer needs to be public.
        
        * WebView/WebPreferences.m:
        (+[WebPreferences initialize]):
        Change WebKitPDFScaleFactorPreferenceKey to 0, which represents auto-size. This fixes 3874856,
        but wasn't feasible until 4483806 was fixed.

2006-03-28  Darin Adler  <darin@apple.com>

        Reviewed by Geoff.

        - added a build step that checks for init routines

        * WebKit.xcodeproj/project.pbxproj: Added a custom build phase that invokes the
        check-for-global-initializers script.

2006-03-28  Tim Omernick  <timo@apple.com>

        Reviewed by Darin.

        <rdar://problem/3694090> -[WebBaseNetscapePluginView finalize] is incorrect; design change needed

        * Plugins/WebBaseNetscapePluginView.m:
        (-[WebBaseNetscapePluginView initWithFrame:]):
        Don't observe preferences changes here -- we only want to observe preferences while the view is 
        installed in the view hierarchy.  Plugins will appropriately start and stop themselves when added to
        or removed from a window.
        (-[WebBaseNetscapePluginView dealloc]):
        Don't remove observers here -- they should have been removed when the view was removed from its
        window.
        (-[WebBaseNetscapePluginView finalize]):
        ditto
        (-[WebBaseNetscapePluginView viewWillMoveToWindow:]):
        Stop observing preferences when the view is removed from its window.
        (-[WebBaseNetscapePluginView viewDidMoveToWindow]):
        Start observing preferences when the view is added to a window.

2006-03-27  Tim Omernick  <timo@apple.com>

        Reviewed by Eric.

        <rdar://problem/3694090> -[WebBaseNetscapePluginView finalize] is incorrect; design change needed

        * ChangeLog:
        * Plugins/WebBaseNetscapePluginView.m:
        (-[WebBaseNetscapePluginView dealloc]):
        Instead of calling -stop, assert that the plugin is not running.  A plugin view cannot be deallocated
        until it is removed from its window.  When a plugin view is removed from its window, it calls -stop
        on itself.  Therefore I believe that this call to -stop is unnecessary; if I'm wrong, then the
        assertion will help catch any edge cases.
        (-[WebBaseNetscapePluginView finalize]):
        ditto

2006-03-27  Tim Omernick  <timo@apple.com>

        Reviewed by Eric.

        <rdar://problem/3694086> -[WebBaseNetscapePluginStream finalize] is incorrect; design change needed

        * Plugins/WebBaseNetscapePluginStream.m:
        (-[WebBaseNetscapePluginStream dealloc]):
        Assert that the stream file path either never existed, or was deleted and NULL-ed out.  The stream file
        is now deleted immediately after calling NPP_StreamAsFile().
        (-[WebBaseNetscapePluginStream finalize]):
        ditto
        (-[WebBaseNetscapePluginStream _destroyStream]):
        Delete the file after calling NPP_StreamAsFile(), instead of in -dealloc/-finalize.  It should be OK
        to delete the file here -- NPP_StreamAsFile() is always called immediately before NPP_DestroyStream()
        (the stream destruction function), so there can be no expectation that a plugin will read the stream file
        asynchronously after NPP_StreamAsFile() is called.

2006-03-27  Tim Omernick  <timo@apple.com>

        Reviewed by Eric.

        <rdar://problem/3694093> -[WebBasePluginPackage finalize] is incorrect; design change needed

        Call -unload on plug-in packages instead of relying on -dealloc/-finalize to do it.  Currently
        the only place plug-in packages are deallocated is when refreshing the set of plugins, as when
        handling JavaScript's navigator.plugins.refresh().

        * Plugins/WebBasePluginPackage.m:
        (-[WebBasePluginPackage dealloc]):
        Assert that the plug-in has been unloaded by the time -dealloc is called.
        (-[WebBasePluginPackage finalize]):
        ditto

        * Plugins/WebPluginDatabase.m:
        (-[WebPluginDatabase refresh]):
        Call -unload on the plug-in packages before releasing them.

2006-03-27  Tim Omernick  <timo@apple.com>

        Reviewed by Tim Hatcher.

        Part of <rdar://problem/4448350> Deprecated ObjC language API used in JavaScriptCore, WebCore,
        WebKit and WebBrowser

        * Carbon/HIViewAdapter.h:
        HIViewAdapter is no longer an NSView subclass, since we no longer pose it as NSView.
        * Carbon/HIViewAdapter.m:
        (+[NSView bindHIViewToNSView:nsView:]):
        Replace individual NSView methods instead of posing as NSView.
        (_webkit_NSView_setNeedsDisplay):
        Replacement implementation of -[NSView setNeedsDisplay:].
        (_webkit_NSView_setNeedsDisplayInRect):
        Replacement implementation of -[NSView setNeedsDisplayInRect:]
        (_webkit_NSView_nextValidKeyView):
        Replacement implementation of -[NSView nextValidKeyView]

2006-03-27  John Sullivan  <sullivan@apple.com>

        Reviewed by Darin Adler.
        
        Removed two overzealous assertions that the steps to reproduce 4451831 were running into.
        Improved comments to match.

        * WebCoreSupport/WebFrameBridge.m:
        (-[WebFrameBridge _nextKeyViewOutsideWebFrameViewsWithValidityCheck:]):
        Remove assertion that _inNextKeyViewOutsideWebFrameViews should always be false here.
        
        * WebView/WebHTMLView.m:
        (-[NSArray nextValidKeyView]):
        Removed assertion that the frame should never be the main frame here.

2006-03-27  Tim Omernick  <timo@apple.com>

        Reviewed by Tim Hatcher.

        Removed tabs & reformatted code.
        
        * Carbon/HIViewAdapter.m:
        (+[NSView bindHIViewToNSView:nsView:]):
        (+[NSView getHIViewForNSView:]):
        (+[NSView unbindNSView:]):
        (-[NSView setNeedsDisplay:]):
        (-[NSView setNeedsDisplayInRect:]):
        (-[NSView nextValidKeyView]):
        (SetViewNeedsDisplay):

2006-03-26  Justin Garcia  <justin.garcia@apple.com>

        Reviewed by darin
        
        <http://bugzilla.opendarwin.org/show_bug.cgi?id=7974>
        Add EditActions and WebUndoActions for CreateLink and Unlink

        * English.lproj/Localizable.strings:
        * WebCoreSupport/WebFrameBridge.m:
        (-[WebFrameBridge nameForUndoAction:]):

2006-03-23  Tim Omernick  <timo@apple.com>

        Reviewed by John Sullivan.

        At John's suggestion, renamed a private WebFrame method and tightened up some of the redirect logic I recently touched.

        * WebView/WebFramePrivate.h:
        Renamed -_clientRedirectCancelled: to -_clientRedirectCancelledOrFinished:, since we call this both when a redirect is
        cancelled and when a redirect is successfully committed.
        * WebCoreSupport/WebFrameBridge.m:
        (-[WebFrameBridge reportClientRedirectCancelled:]):
        Call renamed WebFrame method.
        * WebView/WebFrame.m:
        Added sentRedirectNotification flag to WebFramePrivate.  This flag is set when we notify the frame load delegate that a
        redirect will occur.  We check this flag when committing a provisional load to ensure that the frame load delegate is
        notified that the redirect finished.
        (-[WebFrame _commitProvisionalLoad:]):
        After committing a provisional load, make sure that the frame load delegate is notified that there is no longer a pending
        redirect.
        (-[WebFrame _clientRedirectedTo:delay:fireDate:lockHistory:isJavaScriptFormAction:]):
        Set the new sentRedirectNotification flag.
        (-[WebFrame _clientRedirectCancelledOrFinished:]):
        Renamed method.
        Clear the sentRedirectNotification flag.
        (-[WebFrame _continueLoadRequestAfterNavigationPolicy:formState:]):
        Call renamed method.

2006-03-23  Tim Omernick  <timo@apple.com>

        Reviewed by John Sullivan.

        <rdar://problem/4439752> TinyMCE: "Search in Google" context menu is active but fails to work when selection is active
        in textarea field.

        * DefaultDelegates/WebDefaultContextMenuDelegate.m:
        (-[WebDefaultUIDelegate menuItemWithTag:target:representedObject:]):
        Added a representedObject parameter, which is set on the newly created menu item.
        (-[WebDefaultUIDelegate contextMenuItemsForElement:defaultMenuItems:]):
        Instead of setting the representedObject on each menu item after creating them all, pass the element to
        -menuItemWithTag:target:representedObject:.
        (-[WebDefaultUIDelegate editingContextMenuItemsForElement:defaultMenuItems:]):
        ditto.  This fixes 4439752 because this method failed to set the representedObject on the menu items as
        -contextMenuItemsForElement:defaultMenuItems: did.

2006-03-23  Darin Adler  <darin@apple.com>

        Reviewed by Eric.

        - fix <rdar://problem/4380465> repro crash when unsuccessfully attempting to import image from Services menu

        * WebView/WebDataSource.m:
        (-[WebDataSource _imageElementWithImageResource:]): Quietly do nothing if passed nil.
        (-[WebDataSource _documentFragmentWithImageResource:]): Ditto.

2006-03-22  Tim Omernick  <timo@apple.com>

        Reviewed by Kevin Decker.

        Even better fix for <rdar://problem/4432562>.  We need to notify the frame delegate of a finished redirect for both
        "fast" and "slow" redirects, after committing the load.  My previous change only notified for "fast", history-locking
        redirects.  Now we notify the frame delegate after committing any kind of provisional load, not just in the case of
        a fast redirect.

        * WebView/WebFrame.m:
        (-[WebFrame _transitionToCommitted:]):
        (-[WebFrame _commitProvisionalLoad:]):

2006-03-22  Tim Omernick  <timo@apple.com>

        Reviewed by Kevin Decker.

        Better fix for <rdar://problem/4432562> REGRESSION (TOT): Safari's "stop loading" active, "view source" inactive after page load [7058]

        * WebView/WebFrame.m:
        (-[WebFrame _transitionToCommitted:]):
        Cancel the client redirect when we commit the provisional load, if we were waiting for a redirect.
        This is a better fix for 7058 (<rdar://problem/4432562>).  The original fix for 7058 changed the timing of the redirect cancel
        in such a way that WebKit was precluded from ever reusing back/forward list entries for redirects.  Clearing the redirect state
        here actually makes logical sense, as the redirect's target page is being committed at this point.

2006-03-21  Darin Adler  <darin@apple.com>

        - fix http://bugzilla.opendarwin.org/show_bug.cgi?id=3784
          <rdar://problem/4483827> JavaScript save dialog disappears right away (sheet triggers blur event) (3784)

        * WebView/WebHTMLView.m:
        (-[WebHTMLView _updateFocusState]): Treat window as having focus if its sheet is key.
        (-[WebHTMLView addWindowObservers]): Observe all focus notifications, not just the ones involving this window.
        (-[WebHTMLView removeWindowObservers]): Ditto.
        (-[WebHTMLView windowDidBecomeKey:]): Add checks so that we call the methods only when appropriate,
        since this will now be called for all windows.
        (-[WebHTMLView windowDidResignKey:]): Ditto.

2006-03-21  Adele Peterson  <adele@apple.com>

        Reviewed by Darin.

        - Fix for http://bugzilla.opendarwin.org/show_bug.cgi?id=6813
        elementAtPoint needs to return input element when clicking on new text field

        * WebView/WebDocumentInternal.h: Added elementAtPoint:allowShadowContent:
        * WebView/WebHTMLView.m:
        (-[NSArray elementAtPoint:]): Does not allow shadow content.  This way, by default, callers would get the input element instead of the inner div.
        (-[NSArray elementAtPoint:allowShadowContent:]): Allows callers to specify whether or not the element can be a shadow node.
        (-[WebHTMLView _startDraggingImage:at:operation:event:sourceIsDHTML:DHTMLWroteData:]): Allows shadow content when getting element.
        (-[WebHTMLView _mayStartDragAtEventLocation:]): ditto.
        (-[NSArray _isSelectionEvent:]): ditto.
        (-[NSArray _canProcessDragWithDraggingInfo:]): ditto.
        * WebView/WebFrame.m: (-[WebFrame _actionInformationForNavigationType:event:originalURL:]): Does not allow shadow content when getting element.
        * WebView/WebImageView.m: (-[WebImageView elementAtPoint:allowShadowContent:]): Added to conform to the WebDocumentElement protocol.
        * WebView/WebPDFView.m: (-[WebPDFView elementAtPoint:allowShadowContent:]): ditto.
        * WebView/WebTextView.m: (-[WebTextView elementAtPoint:allowShadowContent:]): ditto.

2006-03-21  Tim Omernick  <timo@apple.com>

        Reviewed by Tim Hatcher and Darin.

        <rdar://problem/4427068> LMGetCurApRefNum, CloseConnection and GetDiskFragment deprecated, used in Netscape
        plugin code

        * Plugins/WebNetscapeDeprecatedFunctions.h: Added.
        * Plugins/WebNetscapeDeprecatedFunctions.c: Added.
        Added wrappers for deprecated CFM and LowMem functions.  These exist in a separate file so that we can set
        -Wno-deprecated-declarations on this one file without ignoring other deprecated function usage elsewhere.
        (WebGetDiskFragment):
        (WebCloseConnection):
        (WebLMGetCurApRefNum):
        (WebLMSetCurApRefNum):

        * Plugins/WebNetscapePluginPackage.h:
        Don't include connID ivar in 64-bit, since CFM is not supported in 64-bit.
        * Plugins/WebNetscapePluginPackage.m:
        (+[WebNetscapePluginPackage initialize]):
        Don't bother setting the resource refNum in 64-bit, because the API to get and set it does not exist.
        A theoretical 64-bit plugin couldn't possibly rely this, since there is no API.
        (-[WebNetscapePluginPackage unloadWithoutShutdown]):
        No need to close the connID in 64-bit.
        (-[WebNetscapePluginPackage load]):
        Don't load CFM bundles in 64-bit, because CFM is not supported.

        * WebKit.xcodeproj/project.pbxproj:
        Added WebNetscapeDeprecatedFunctions.[hm].

2006-03-21  John Sullivan  <sullivan@apple.com>

        Reviewed by Kevin Decker.
        
        - fixed <rdar://problem/4485637> Implementors of searchFor:direction:caseSensitive:wrap: should bail 
        out early if search string is empty
        
        This doesn't change any existing behavior, but avoids unnecessary work.

        * Misc/WebSearchableTextView.m:
        (-[WebSearchableTextView searchFor:direction:caseSensitive:wrap:]):
        bail out immediately (returning NO) if search string is empty
        
        * WebView/WebHTMLView.m:
        (-[WebView searchFor:direction:caseSensitive:wrap:]):
        ditto
        
        * WebView/WebPDFView.m:
        (-[WebPDFView searchFor:direction:caseSensitive:wrap:]):
        ditto
        
        * WebView/WebView.m:
        (-[WebView searchFor:direction:caseSensitive:wrap:]):
        ditto

2006-03-20  Tim Omernick  <timo@apple.com>

        Reviewed by John Sullivan.

        Moved -_contentView from WebFrameViewInternal to WebFrameViewPrivate.  Safari
        needs this.

        * WebView/WebFrameView.m:
        (-[WebFrameView _contentView]):
        * WebView/WebFrameViewInternal.h:
        * WebView/WebFrameViewPrivate.h:

2006-03-17  Mitz Pettel  <opendarwin.org@mitzpettel.com>

        Reviewed by Darin, landed by Beth.

        - fix http://bugzilla.opendarwin.org/show_bug.cgi?id=7693
          WebKit relies on unpredictable timing for onload events

        * WebView/WebDataSource.m:
        (-[WebDataSource _receivedMainResourceError:complete:]): Check for 
        completion on the WebCore side before checking on the WebKit side, 
        to ensure that the onload event is emitted before the WebFrame load 
        delegate is sent the webView:didFinishLoadForFrame: message. For 
        DumpRenderTree, this ensures that the render tree is dumped after 
        the onload handler is run.
        * WebView/WebLoader.m:
        (-[NSURLProtocol didFailWithError:]): If load has already been 
        cancelled (which could happen if the parent's onload handler caused 
        the frame to detach), do nothing.

2006-03-17  John Sullivan  <sullivan@apple.com>

        Reviewed by Beth Dakin
        
        - fixed <rdar://problem/4239051> Sometimes "Copy Link" in Safari results in a 
        URL on the pasteboard with no usable "title"

        * History/WebURLsWithTitles.m:
        (+[WebURLsWithTitles writeURLs:andTitles:toPasteboard:]):
        trim whitespace from titles that are put on pasteboard. This leaves an empty string
        for the title in cases where there's no displayed text, like an image in an <a> element
        that happens to have whitespace in the source, e.g. <a href="foo"> <img whatever></a>

2006-03-17  Darin Adler  <darin@apple.com>

        - missing bit of my check-in yesterday

        Maciej moved setWindowFrame for me, but I also had removed
        setWindowContentRect.

        * WebCoreSupport/WebFrameBridge.m: Removed unused setWindowContextRect and
        windowContentRect methods.

2006-03-17  Adele Peterson  <adele@apple.com>

        Reviewed by Hyatt.

        WebKit part of fix for:
        http://bugzilla.opendarwin.org/show_bug.cgi?id=7797 
        Can't set background color on new text fields

        Added function to draw bezeled text field without drawing background.

        * WebCoreSupport/WebGraphicsBridge.m:
        (-[WebGraphicsBridge drawBezeledTextFieldCell:enabled:]): Added.

2006-03-16  Maciej Stachowiak  <mjs@apple.com>

        Reviewed by Eric.
        
        - move setWindowFrame / windowFrame to WebPageBridge to fix build

        * WebCoreSupport/WebFrameBridge.m:
        * WebCoreSupport/WebPageBridge.m:
        (-[WebPageBridge setWindowFrame:]):
        (-[WebPageBridge windowFrame]):

2006-03-15  Darin Adler  <darin@apple.com>

        Fix by Patrick Beard, reviewed by me.

        - fix <rdar://problem/4478181> WebPluginController leaks NSArray and NSMutableSet objects

        * Plugins/WebPluginController.m:
        (-[WebPluginController initWithDocumentView:]): Call CFMakeCollectable on the CFSet
        so we can act like it's an NSSet.
        (-[WebPluginController dealloc]): Release _views and _checksInProgress.

2006-03-13  Tim Omernick  <timo@apple.com>

        Reviewed by Maciej.

        <rdar://problem/4476873> Support printing for plugin documents (not embedded plugins)

        * WebView/WebFrameViewPrivate.h:
        * WebView/WebFrameView.m:
        (-[WebFrameView documentViewShouldHandlePrint]):
        Called by the host application before it initializes and runs a print operation.  If NO
        is returned, the host application will abort its print operation and call
        -printDocumentView on the WebFrameView.  The document view is then expected to run its
        own print operation.  If YES is returned, the host application's print operation will
        continue as normal.
        (-[WebFrameView printDocumentView]):
        Called by the host application when the WebFrameView returns YES from -documentViewShouldHandlePrint.

        * Plugins/WebNetscapePluginDocumentView.m:
        (-[WebNetscapePluginDocumentView documentViewShouldHandlePrint]):
        Allow the plugin to take over printing if it defines an NPP_Print function
        (-[WebNetscapePluginDocumentView printDocumentView]):
        Print the plugin document.

2006-03-13  Geoffrey Garen  <ggaren@apple.com>

        Reviewed by timo.

        - Fixed the load progress indicator to give more incremental feedback, 
        and to stop spending so much time near 100%.

        I did two things:
        (1) Fixed some bugs and a misspelling in the previous heuristic's 
        implementation
        (2) Added two new rules to the heuristic:
            (a) Treat the first layout as the half-way point.
            (b) Just like we jump the first 10% to indicate that a load has
            started, jump the last 10% to indicate that a load has finished.

        Rule 2a is good for two reasons. First, it seems unnatural for loading
        to be "more than half done" when you can't even see anything. Second,
        in the early stages of laading our estimate of how much we'll need to
        load is often off by as much as 6000% (e.g., cnn.com). So anything that
        makes the progress indicator more conservative in the early stages of 
        loading is helpful.

        Rule 2b is good because it's confusing for loading to be "100% done"
        but still ongoing.

        FIXME: The indicator still isn't perfect. For example, the old behavior
        shows up @ moviefone.com. Two areas for future work:
        (1) Estimate number of linked resources. Our code estimates the size
        of a single resource, but does nothing to estimate the number of
        resources that resource might link to. This is the key to why we're
        so wrong at the beginning.
        (2) Improve "when to do first layout" heuristic. A JavaScript query
        for a style property forces layout, creating a phantom first layout 
        with no content, essentially nullifying 2a for certain pages.
        
        Filed <rdar://problem/4475834> to track estimating the number of 
        linked resources. Phantom layouts are already on Hyatt's radar.

        * WebView/WebFrame.m:
        (-[WebFrame _setState:]): Update firstLayoutDone
        (-[WebFrame _numPendingOrLoadingRequests:]): Bug fix: In the recurisve 
        case, query 'frame' instead of 'self', so that we actually recurse.
        (-[WebFrame _firstLayoutDone]): New method
        (-[WebFrame _didFirstLayout]): Update firstLayoutDone
        * WebView/WebFramePrivate.h: Added firstLayoutDone ivar
        * WebView/WebView.m:
        (-[WebView _incrementProgressForConnectionDelegate:data:]):
        (1) Implemented 2a and 2b
        (2) Bug fix: only update the 'last time I sent a notification' time if 
        we actually send a notification.
        (3) Don't test for progress < 0 because ensuring progress < max
        also ensures max - progress > 0. (Do still test for progress > max 
        because rounding errors make that a possibility -- although a very 
        minor one.)
        (4) Query only the loading frame and its subframes for pending
        requests instead of defaulting to the main frame. This is a slight
        optimization in cases where the main frame did not begin the load,
        and it makes the code more consistent.

2006-03-13  John Sullivan  <sullivan@apple.com>

        Reviewed by Tim Omernick.
        
        - fixed <rdar://problem/4475857> API: Setting a history item limit programmatically doesn't work

        * History/WebHistory.m:
        (-[WebHistoryPrivate _loadHistoryGuts:URL:error:]):
        use [self historyItemLimit], which prefers the explicitly-set value and falls back to the
        NSUserDefaults value, instead of using the NSUserDefaults value explicitly.

2006-03-10  Darin Adler  <darin@apple.com>

        Reviewed by Adele.

        * WebCoreSupport/WebFrameBridge.m: Remove unused requestedURLString method.

2006-03-10  Darin Adler  <darin@apple.com>

        Reviewed by Geoff.

        - change how frame namespacing works to be more completely on the WebCore side

        * WebView/WebFrameInternal.h: Remove _setFrameNamespace: and _frameNamespace.
        * WebView/WebFrame.m: Ditto.

        * WebView/WebView.m:
        (-[WebView setGroupName:]): Call -[WebCorePageBridge setGroupName:].
        (-[WebView groupName]): Call -[WebCorePageBridge groupName].

2006-03-09  Alexey Proskuryakov  <ap@nypop.com>

        Reviewed by Darin.

        - http://bugzilla.opendarwin.org/show_bug.cgi?id=7656
         Query string always appended to Flash URLs, instead of being replaced.

        * Misc/WebNSURLExtras.h: Added _webkit_URLByRemovingResourceSpecifier.
        * Misc/WebNSURLExtras.m:
        (+[NSURL _web_URLWithData:relativeToURL:]): Call _webkit_URLByRemovingResourceSpecifier to
        work around CFURL not removing non-path components from base URLs in some cases.
        (-[NSURL _webkit_URLByRemovingComponent:]): New generic function for removing URL components.
        (-[NSURL _webkit_URLByRemovingFragment]): Moved implementation to the above method.
        (-[NSURL _webkit_URLByRemovingResourceSpecifier]): Added.

2006-03-07  Darin Adler  <darin@apple.com>

        Reviewed by Anders.

        - fix http://bugzilla.opendarwin.org/show_bug.cgi?id=7655
          unwanted output while running layout tests

        * WebView/WebDataSourcePrivate.h:
        * WebView/WebDataSource.m:
        (-[WebDataSource _setRepresentation:]): Clear the flag that records whether we've sent
        all the data to the representation or not; need this to prevent telling the same representation
        both that we've succeeded and then later that we've failed.
        (-[WebDataSource _setMainDocumentError:]): Don't send an error if representationFinishedLoading
        is already YES. Set representationFinishedLoading.
        (-[WebDataSource _finishedLoading]): Set representationFinishedLoading.
        (-[WebDataSource _setupForReplaceByMIMEType:]): Ditto.

2006-03-06  Tim Omernick  <timo@apple.com>

        Reviewed by Kevin Decker.

        <rdar://problem/4457574> assertion failure watching trailers at netflix.com -[WebNetscapePluginRepresentation
        receivedData:withDataSource:] + 684

        * Plugins/WebNetscapePluginRepresentation.m:
        (-[WebNetscapePluginRepresentation receivedData:withDataSource:]):
        Moved the ASSERT(instance) to the block that actually requires an assertion -- the plugin view should never
        have a NULL instance by the time we start the NPStream (by calling -startStreamWithResponse:).
        Some stream teardown logic changed with my fix to 4153419: when a WebBaseNetscapePluginStream is destroyed,
        it now clears its NPP instance backpointer.  The WebBaseNetscapePluginStream may be destroyed from within
        -startStreamWithResponse: if NPP_NewStream() returns an error.  We can handle this gracefully by changing
        the assertion before -receivedData: to a simple NULL check.
        This is unrelated to the Radar, but prior to this fix, we would attempt an NPP_Write() with the initial
        stream data even if NPP_NewStream() returned an error.  Seems like that alone could cause issues, though
        I'm guessing that plugins handle this in practice.

2006-03-03  Timothy Hatcher  <timothy@apple.com>

        Reviewed by Darin.
        
        <rdar://problem/4411822> wrong element shown in Inspector inspecting main image at apple.com
        <rdar://problem/4411908> in the Web Inspector, state of disclosure triangles should be preserved after search
        http://bugzilla.opendarwin.org/show_bug.cgi?id=6616
        Bug 6616: Double-clicking on a search result seems broken
        http://bugzilla.opendarwin.org/show_bug.cgi?id=6709
        Bug 6709: TypeError: Value undefined (result of expression treeScrollbar.refresh) is not object.

        Code clean up and move more code into JavaScript.
        Removes a few unused ObjC methods.
        Many search fixes. Reveals the focused node when exiting the search.
        Shows a "No Selection" screen when there are no search results.
        Shows a node count for the number of results.
        Fixes a couple of TypeErrors that show on the console.
        Uses the system selection color in the Style pane tables.

        * English.lproj/Localizable.strings: removed localized strings
        * WebInspector.subproj/WebInspector.m:
        (-[WebInspector init]):
        (-[WebInspector dealloc]):
        (-[WebInspector window]):
        (-[WebInspector setSearchQuery:]):
        (-[WebInspector resizeTopArea]):
        (-[WebInspector searchPerformed:]): called from JavaScript when a search happens
        (-[WebInspector _toggleIgnoreWhitespace:]):
        (-[WebInspector _exitSearch:]): exit search results on double click
        (-[WebInspector _focusRootNode:]):
        (-[WebInspector _revealAndSelectNodeInTree:]):
        (-[WebInspector _refreshSearch]):
        (-[WebInspector _update]):
        (-[WebInspector _updateTraversalButtons]):
        (-[WebInspector _updateRoot]):
        (-[WebInspector _updateTreeScrollbar]):
        (-[WebInspector _updateSystemColors]): update CSS with system colors
        (-[WebInspector webView:didFinishLoadForFrame:]):
        (-[WebInspector webView:plugInViewWithArguments:]):
        (-[WebInspector outlineViewSelectionDidChange:]): test for webViewLoaded
        (-[WebInspectorPrivate init]): alloc rightArrowImage and downArrowImage
        (-[WebInspectorPrivate dealloc]): no more matchedRules
        (-[DOMNode _displayName]): removed localization UI_STRING calls.
        * WebInspector.subproj/WebInspectorInternal.h:
        * WebInspector.subproj/webInspector/inspector.css:
        * WebInspector.subproj/webInspector/inspector.html:
        * WebInspector.subproj/webInspector/inspector.js:

2006-03-02  Alexey Proskuryakov  <ap@nypop.com>

        Fixed a typo in the comments added in the previous checkin.

        * WebCoreSupport/WebFrameBridge.m:
        (-[WebFrameBridge syncLoadResourceWithMethod:URL:customHeaders:postData:finalURL:responseHeaders:statusCode:]):
        * WebCoreSupport/WebSubresourceLoader.m:
        (+[WebSubresourceLoader startLoadingResource:withMethod:URL:customHeaders:referrer:forDataSource:]):
        (+[WebSubresourceLoader startLoadingResource:withMethod:URL:customHeaders:postData:referrer:forDataSource:]):

2006-03-02  Alexey Proskuryakov  <ap@nypop.com>

        Reviewed by Darin.

        - http://bugzilla.opendarwin.org/show_bug.cgi?id=7540
          REGRESSION: frequent cache-related crashes

        - http://bugzilla.opendarwin.org/show_bug.cgi?id=7393
          A stale comment about XMLHttpRequest responses being never cached

        * WebCoreSupport/WebFrameBridge.m: Don't call setHTTPHeader if the method is GET.
        (-[WebFrameBridge syncLoadResourceWithMethod:URL:customHeaders:postData:finalURL:responseHeaders:statusCode:]):
        * WebCoreSupport/WebSubresourceLoader.m: Ditto. Also removed a stale comment about
        XMLHTTPRequests.
        (+[WebSubresourceLoader startLoadingResource:withMethod:URL:customHeaders:referrer:forDataSource:]):
        (+[WebSubresourceLoader startLoadingResource:withMethod:URL:customHeaders:postData:referrer:forDataSource:]):

2006-02-23  David Harrison  <harrison@apple.com>

        Reviewed by Justin.

        <rdar://problem/4359736> Support outlining ability with lists

        Added Mail SPI for list level changes.  It is SPI because it is not complete support
        for outlining.  See <rdar://problem/4457070> "API for html lists as note outlines".
        
        * WebView/WebHTMLView.m:
        (-[WebHTMLView _canIncreaseSelectionListLevel]):
        (-[WebHTMLView _canDecreaseSelectionListLevel]):
        (-[WebHTMLView _increaseSelectionListLevel]):
        (-[WebHTMLView _decreaseSelectionListLevel]):
        * WebView/WebHTMLViewPrivate.h:

2006-03-01  Alexey Proskuryakov  <ap@nypop.com>

        Reviewed by Darin.

        - http://bugzilla.opendarwin.org/show_bug.cgi?id=3812
          XMLHttpRequest: PUT, DELETE, HEAD and all other methods but POST actually do a GET.

        All WebKit changes are to use the method parameter passed from WebCore.

        * WebCoreSupport/WebFrameBridge.m:
        (-[WebFrameBridge startLoadingResource:withMethod:URL:customHeaders:]):
        (-[WebFrameBridge startLoadingResource:withMethod:URL:customHeaders:postData:]):
        (-[WebFrameBridge syncLoadResourceWithMethod:URL:customHeaders:postData:finalURL:responseHeaders:statusCode:]):
        * WebCoreSupport/WebSubresourceLoader.h:
        * WebCoreSupport/WebSubresourceLoader.m:
        (+[WebSubresourceLoader startLoadingResource:withMethod:URL:customHeaders:referrer:forDataSource:]):
        (+[WebSubresourceLoader startLoadingResource:withMethod:URL:customHeaders:postData:referrer:forDataSource:]):

2006-03-01  Timothy Hatcher  <timothy@apple.com>

        Reviewed by Darin.

        http://bugzilla.opendarwin.org/show_bug.cgi?id=7450
        elementAtPoint is expensive and should return a smart dictionary
        
        <rdar://problem/2952761> moving the mouse around eats more CPU than I would expect (7450)
        
        elementAtPoint for WebHTMLView now returns a WebElementDictionary,
        when objectForKey is called it will lookup in the DOM, cache and return the value

        * Misc/WebElementDictionary.h: Added.
        * Misc/WebElementDictionary.m: Added.
        (addLookupKey):
        (cacheValueForKey):
        (+[WebElementDictionary initializeLookupTable]):
        (-[WebElementDictionary initWithInnerNonSharedNode:innerNode:URLElement:andPoint:]):
        (-[WebElementDictionary dealloc]):
        (-[WebElementDictionary _fillCache]):
        (-[WebElementDictionary count]):
        (-[WebElementDictionary keyEnumerator]):
        (-[WebElementDictionary objectForKey:]):
        (-[WebElementDictionary _domNode]):
        (-[WebElementDictionary _webFrame]):
        (-[WebElementDictionary _targetWebFrame]):
        (-[WebElementDictionary _title]):
        (-[WebElementDictionary _imageRect]):
        (-[WebElementDictionary _isSelected]):
        * Misc/WebNSViewExtras.m:
        (-[NSView _web_dragImage:element:rect:event:pasteboard:source:offset:]):
        * WebKit.xcodeproj/project.pbxproj:
        * WebView/WebHTMLView.m:
        (-[WebHTMLView _updateMouseoverWithEvent:]):
        (-[WebHTMLView _startDraggingImage:at:operation:event:sourceIsDHTML:DHTMLWroteData:]):
        (-[NSArray elementAtPoint:]):
        * WebView/WebView.m:
        * WebView/WebViewPrivate.h:

2006-02-28  Darin Adler  <darin@apple.com>

        Reviewed by Adele.

        - remove obsolete WebCoreScrollView class

        * WebView/WebDynamicScrollBarsView.h: Change base class to NSScrollView instead of WebCoreScrollView.
        * WebView/WebDynamicScrollBarsView.m: (-[WebDynamicScrollBarsView autoforwardsScrollWheelEvents]): Added.

2006-02-28  John Sullivan  <sullivan@apple.com>

        Reviewed by Eric Seidel
        
        Wean WebKit from one more SPI call. We learned about this new-to-Tiger
        API from filing Radar 4433222.

        * WebView/WebHTMLView.m:
        (-[WebHTMLView _autoscroll]):
        use public CGEventSourceButtonState() instead of WKMouseIsDown() (which was using SPI internally)

2006-02-27  Tim Omernick  <timo@apple.com>

        Reviewed by Adele.

        <rdar://problem/4222043> Safari should reduce null events sent to invisible plugins

        * Plugins/WebBaseNetscapePluginView.h:
        * Plugins/WebBaseNetscapePluginView.m:
        (-[WebBaseNetscapePluginView restartNullEvents]):
        Check to see if the plugin view is completely obscured (scrolled out of view, for example).  If it is
        obscured and it wasn't before, or the other way around, then restart the null event timer so it can
        fire at the appropriate rate.
        (-[WebBaseNetscapePluginView viewHasMoved:]):
        If a plugin is obscured, send it null events as if it were in an inactive window.

2006-02-26  Mitz Pettel  <opendarwin.org@mitzpettel.com>

        Test: fast/frames/empty-frame-document.html

        Reviewed by Darin.

        - fix http://bugzilla.opendarwin.org/show_bug.cgi?id=7293
          REGRESSION: Using Javascript Bookmarklets that reference location.href on a blank tab crashes WebKit

        The crash happened because an empty frame did not have a document.

        * WebView/WebFrame.m:
        (-[WebFrame _commitProvisionalLoad:]): Use "about:blank" instead of an empty URL for empty
        frames. This causes a document to be created for the frame.

2006-02-21  Kevin Decker  <kdecker@apple.com>

        Reviewed by Darin.

        Backed out my previous check in. Since these methods are internal to WebKit (and not private)
        it's perfectly OK for them to remain as categories. 
        * ChangeLog:
        * WebView/WebPreferences.m:
        (-[WebPreferences _integerValueForKey:]):
        (-[WebPreferences _setIntegerValue:forKey:]):
        (-[WebPreferences _floatValueForKey:]):
        (-[WebPreferences _setFloatValue:forKey:]):
        (-[WebPreferences _boolValueForKey:]):
        (-[WebPreferences _setBoolValue:forKey:]):
        * WebView/WebPreferencesPrivate.h:

2006-02-20  Darin Adler  <darin@apple.com>

        Collaborated with Graham Dennis <Graham.Dennis@gmail.com> on this.

        - WebKit part of fix for http://bugzilla.opendarwin.org/show_bug.cgi?id=6831
          contentEditable outline darkens as caret moves

        * WebCoreSupport/WebGraphicsBridge.m:
        (-[WebGraphicsBridge drawFocusRingWithPath:radius:color:]):
        Replaced the old bridge function that set up style with this one that renders a path.

2006-02-19  Darin Adler  <darin@apple.com>

        Reviewed by Maciej.

        - cut out a little unneeded bridge code

        * WebCoreSupport/WebFrameBridge.m:
        (-[WebFrameBridge webView]): Added. Helper, since the WebCore side of the bridge no longer
        has this method.
        (-[WebFrameBridge createWindowWithURL:]): Removed the frameName parameter -- this is now
        handled on the WebCore side. Also return a page bridge instead of a frame bridge.
        (-[WebFrameBridge createModalDialogWithURL:]): Changed to return a page bridge instead of
        a frame bridge.

        * WebView/WebFrame.m: (-[WebFrame webView]): Change to get the webView from the page bridge
        instead of the frame bridge, since it's a per-page thing.

        * WebView/WebView.m: Removed init method since it just does what the default does (calls
        initWithFrame: with a zero rect).
        (-[WebView initWithCoder:]): Added checking so that if the obejcts have the wrong type
        we will fail gracefully instead of hitting "method not found" and the like.
        (-[WebView setPreferencesIdentifier:]): Fix storage leak. The WebPreferences object was
        not released.
        (-[WebView mainFrame]): Removed excess "return nil".
        (-[WebView _pageBridge]): Added. Helper to let you go from the WebView to the bridge
        from outside the WebView class.
        * WebView/WebViewInternal.h: Put _pageBridge into an internal header.

        * WebCoreSupport/WebPageBridge.m: (-[WebPageBridge outerView]): Added. Replaces "webView"
        as public method to tell the WebCore side about the view everything's embedded in.

        - other cleanup

        * WebCoreSupport/WebPageBridge.h: Removed some unneeded declarations.

        * Plugins/WebBaseNetscapePluginView.m: (-[WebBaseNetscapePluginView loadPluginRequest:]):
        Rearrange code so it doesn't have to get the main frame twice.

2006-02-18  Maciej Stachowiak  <mjs@apple.com>

        Not reviewed.
        
        - fix build broken by my last checkin, the remaining code was not doing anything.

        * WebView/WebDataSource.m:
        * WebView/WebDataSourcePrivate.h:
        * WebView/WebFrame.m:
        (-[WebFrame _createPageCacheForItem:]):

2006-02-16  Maciej Stachowiak  <mjs@apple.com>

        Reviewed by Darin.
        
        - removed a few unused fields and methods of WebDataSource

        * WebView/WebDataSource.m:
        * WebView/WebDataSourcePrivate.h:
        * WebView/WebView.m:
        (+[WebView _MIMETypeForFile:]):
        (-[WebView _updateWebCoreSettingsFromPreferences:]):

2006-02-15  Justin Garcia  <justin.garcia@apple.com>

        Reviewed by darin
        
        <http://bugzilla.opendarwin.org/show_bug.cgi?id=7148>
        Add drag and drop support to DumpRenderTree
        
        Added a UI delegate method so that DumpRenderTree can perform dragging on its own.
        Made _updateFocusState SPI, to allow us to test the behavior and appearance of
        windows that have or don't have focus.

        * WebView/WebHTMLView.m:
        (-[WebHTMLView _updateFocusState]):
        (-[NSArray viewDidMoveToWindow]):
        (-[NSArray windowDidBecomeKey:]):
        (-[NSArray windowDidResignKey:]):
        (-[NSArray dragImage:at:offset:event:pasteboard:source:slideBack:]):
        (-[NSArray becomeFirstResponder]):
        (-[NSArray resignFirstResponder]):
        (-[WebHTMLView _formControlIsResigningFirstResponder:]):
        * WebView/WebHTMLViewInternal.h:
        * WebView/WebHTMLViewPrivate.h:
        * WebView/WebUIDelegatePrivate.h:
        * WebView/WebView.m:

2006-02-15  Darin Adler  <darin@apple.com>

        * English.lproj/StringsNotToBeLocalized.txt: Updated for recent changes.

2006-02-15  Maciej Stachowiak  <mjs@apple.com>

        Rubber stamped by Anders.

        * WebView/WebControllerPolicyHandlerDelegate.h: Removed.

2006-02-15  Maciej Stachowiak  <mjs@apple.com>

        Reviewed by Anders.
        
        - remove some voodoo code

        * WebView/WebDataSource.m:
        (-[WebDataSource _setLoading:]): Removed useless ref/deref of self and WebView.
        A WebDataSource cannot be loading unless it is still connected to the WebView that
        owns it and retained by it, because getting disconnected stops loading.

2006-02-13  Maciej Stachowiak  <mjs@apple.com>

        Reviewed by Anders.
        
        Improvements to frame loading:
        
        - remove LayoutAcceptable state entirely
        - fix WebImageView to work right without LayoutAcceptable state
        - move guts of commitIfReady: to WebFrame
        - try to separate page cache loading from normal loading a bit more

        * English.lproj/StringsNotToBeLocalized.txt:
        * WebView/WebDataSource.m:
        (-[WebDataSource _prepareForLoadStart]):
        (-[WebDataSource _loadFromPageCache:]):
        (-[WebDataSource _startLoading]):
        (-[WebDataSource _commitIfReady]):
        (-[WebDataSource _setupForReplaceByMIMEType:]):
        * WebView/WebDataSourcePrivate.h:
        * WebView/WebFrame.m:
        (-[WebFrame _transitionToCommitted:]):
        (-[WebFrame _commitProvisionalLoad:]):
        (-[WebFrame _checkLoadCompleteForThisFrame]):
        (-[WebFrame _continueLoadRequestAfterNavigationPolicy:formState:]):
        * WebView/WebFramePrivate.h:
        * WebView/WebImageRepresentation.h:
        * WebView/WebImageRepresentation.m:
        * WebView/WebImageView.m:
        (-[WebImageView dataSourceUpdated:]):
        (-[WebImageView setNeedsLayout:]):
        (-[WebImageView writeImageToPasteboard:types:]):
        (-[WebImageView copy:]):
        (-[WebImageView mouseDragged:]):
        * WebView/WebView.m:
        (-[WebView _finishedLoadingResourceFromDataSource:]):
        (-[WebView _mainReceivedBytesSoFar:fromDataSource:complete:]):

2006-02-13  John Sullivan  <sullivan@apple.com>

        Reviewed by Tim Omernick.

        Support for highlighting multiple text matches.

        * WebView/WebHTMLViewPrivate.h:
        * WebView/WebHTMLView.m:
        (-[WebHTMLView highlightAllMatchesForString:caseSensitive:]):
        new method, calls through to bridge
        (-[WebHTMLView clearHighlightedMatches]):
        ditto

        * WebView/WebViewPrivate.h:
        * WebView/WebView.m:
        (-[WebView highlightAllMatchesForString:caseSensitive:]):
        new method, calls through to documentView. For now this is hardwired to only work
        with WebHTMLViews.
        (-[WebView clearHighlightedMatches]):
        ditto

2006-02-13  Darin Adler  <darin@apple.com>

        Reviewed by Maciej.

        - move pointer from frame to page over to WebCore

        * WebCoreSupport/WebPageBridge.m: (-[WebPageBridge initWithMainFrameName:webView:frameView:]):
        Call super init to create the page before creating the main frame and calling setMainFrame: with it.

        * WebCoreSupport/WebFrameBridge.h: Remove page pointer, and change init function parameters.
        * WebCoreSupport/WebFrameBridge.m:
        (-[WebFrameBridge initMainFrameWithPage:frameName:view:]): New function that is used only for
        the main frame. Passes the page over to the other side of the bridge.
        (-[WebFrameBridge initSubframeWithRenderer:frameName:view:]): New function that is used only for
        subframes. Passes the renderer over to the other side of the bridge.
        (-[WebFrameBridge mainFrame]):
        (-[WebFrameBridge webView]):
        (-[WebFrameBridge createWindowWithURL:frameName:]):
        (-[WebFrameBridge showWindow]):
        (-[WebFrameBridge areToolbarsVisible]):
        (-[WebFrameBridge setToolbarsVisible:]):
        (-[WebFrameBridge isStatusbarVisible]):
        (-[WebFrameBridge setStatusbarVisible:]):
        (-[WebFrameBridge setWindowFrame:]):
        (-[WebFrameBridge windowFrame]):
        (-[WebFrameBridge setWindowContentRect:]):
        (-[WebFrameBridge windowContentRect]):
        (-[WebFrameBridge setWindowIsResizable:]):
        (-[WebFrameBridge windowIsResizable]):
        (-[WebFrameBridge firstResponder]):
        (-[WebFrameBridge makeFirstResponder:]):
        (-[WebFrameBridge closeWindowSoon]):
        (-[WebFrameBridge runJavaScriptAlertPanelWithMessage:]):
        (-[WebFrameBridge runJavaScriptConfirmPanelWithMessage:]):
        (-[WebFrameBridge canRunBeforeUnloadConfirmPanel]):
        (-[WebFrameBridge runBeforeUnloadConfirmPanelWithMessage:]):
        (-[WebFrameBridge runJavaScriptTextInputPanelWithPrompt:defaultText:returningText:]):
        (-[WebFrameBridge addMessageToConsole:]):
        (-[WebFrameBridge runOpenPanelForFileButtonWithResultListener:]):
        (-[WebFrameBridge setStatusText:]):
        (-[WebFrameBridge syncLoadResourceWithURL:customHeaders:postData:finalURL:responseHeaders:statusCode:]):
        (-[WebFrameBridge focusWindow]):
        (-[WebFrameBridge createChildFrameNamed:withURL:referrer:renderPart:allowsScrolling:marginWidth:marginHeight:]):
        (-[WebFrameBridge userAgentForURL:]):
        (-[WebFrameBridge _nextKeyViewOutsideWebFrameViewsWithValidityCheck:]):
        (-[WebFrameBridge previousKeyViewOutsideWebFrameViews]):
        (-[WebFrameBridge defersLoading]):
        (-[WebFrameBridge setDefersLoading:]):
        (-[WebFrameBridge viewForPluginWithURL:attributeNames:attributeValues:MIMEType:]):
        (-[WebFrameBridge _preferences]):
        (-[WebFrameBridge selectWordBeforeMenuEvent]):
        (-[WebFrameBridge historyLength]):
        (-[WebFrameBridge canGoBackOrForward:]):
        (-[WebFrameBridge goBackOrForward:]):
        (-[WebFrameBridge print]):
        (-[WebFrameBridge pollForAppletInView:]):
        (-[WebFrameBridge respondToChangedContents]):
        (-[WebFrameBridge respondToChangedSelection]):
        (-[WebFrameBridge undoManager]):
        (-[WebFrameBridge issueCutCommand]):
        (-[WebFrameBridge issueCopyCommand]):
        (-[WebFrameBridge issuePasteCommand]):
        (-[WebFrameBridge issuePasteAndMatchStyleCommand]):
        (-[WebFrameBridge canPaste]):
        (-[WebFrameBridge overrideMediaType]):
        (-[WebFrameBridge isEditable]):
        (-[WebFrameBridge shouldChangeSelectedDOMRange:toDOMRange:affinity:stillSelecting:]):
        (-[WebFrameBridge shouldBeginEditing:]):
        (-[WebFrameBridge shouldEndEditing:]):
        (-[WebFrameBridge windowObjectCleared]):
        (-[WebFrameBridge spellCheckerDocumentTag]):
        (-[WebFrameBridge isContinuousSpellCheckingEnabled]):
        (-[WebFrameBridge didFirstLayout]):
        (-[WebFrameBridge dashboardRegionsChanged:]):
        (-[WebFrameBridge createModalDialogWithURL:]):
        (-[WebFrameBridge canRunModal]):
        (-[WebFrameBridge runModal]):
        Change all calls to [_page webView] to use [self webView] instead.

=== WebKit-521.7

2006-02-11  Maciej Stachowiak  <mjs@apple.com>

        Reviewed by Hyatt.
        
        - factor WebArchive creation code out of other classes into new WebArchiver
        http://bugzilla.opendarwin.org/show_bug.cgi?id=7208

        * DOM/WebDOMOperations.m:
        (-[DOMNode webArchive]):
        (-[DOMRange webArchive]):
        * WebKit.xcodeproj/project.pbxproj:
        * WebView/WebArchiver.h: Added.
        * WebView/WebArchiver.m: Added.
        (+[WebArchiver _subframeArchivesForFrame:]):
        (+[WebArchiver archiveFrame:]):
        (+[WebArchiver _archiveCurrentStateForFrame:]):
        (+[WebArchiver _archiveWithMarkupString:fromFrame:nodes:]):
        (+[WebArchiver archiveRange:]):
        (+[WebArchiver archiveNode:]):
        (+[WebArchiver archiveSelectionInFrame:]):
        * WebView/WebDataSource.m:
        (-[WebDataSource webArchive]):
        * WebView/WebDataSourcePrivate.h:
        * WebView/WebHTMLView.m:
        (-[WebHTMLView _writeSelectionWithPasteboardTypes:toPasteboard:cachedAttributedString:]):
        (-[WebHTMLView _writeSelectionToPasteboard:]):
        * WebView/WebHTMLViewPrivate.h:

2006-02-11  Darin Adler  <darin@apple.com>

        * English.lproj/StringsNotToBeLocalized.txt: Updated paths for recent changes in directory structure.

2006-02-11  David Kilzer  <ddkilzer@kilzer.net>

        Reviewed by John Sullivan.

        - Fix http://bugzilla.opendarwin.org/show_bug.cgi?id=7171
        No description in WebKitErrors.m for WebKitErrorPlugInWillHandleLoad

        * English.lproj/Localizable.strings: Added new UI_STRING().
        * Misc/WebKitErrors.m: Added #define for description.
        (registerErrors): Added dictionary entry.

2006-02-09  Tim Omernick  <timo@apple.com>

        Reviewed by Tim Hatcher.

        <rdar://problem/4153419> CrashTracer: 576 crashes in Safari at com.apple.WebKit: NPN_DestroyStream + 56

        I never could reproduce this crasher, which seems to be caused by the Speed Download plugin.  However,
        I did find a way to make the affected code more bulletproof for those who are experiencing the crash.
        
        * Plugins/WebBaseNetscapePluginStream.h:
        Keep a WebBaseNetscapePluginView instead of the WebNetscapePluginPackage, since the plugin view could
        potentially be deallocated before the stream finishes loading.
        * Plugins/WebBaseNetscapePluginStream.m:
        (-[WebBaseNetscapePluginStream _pluginCancelledConnectionError]):
        Use pluginView instead of plugin.
        (-[WebBaseNetscapePluginStream dealloc]):
        Assert that the plugin instance has been nulled out, since that's now part of the stream's teardown
        phase.
        Release pluginView instead of plugin.
        (-[WebBaseNetscapePluginStream setPluginPointer:]):
        Retain the plugin view instead of the plugin package, since the plugin view could be deallocated while
        the stream is running.
        This method now accepts a NULL argument so that we can easily clear out the pluginView backpointer
        (and other ivars derived from it).
        (-[WebBaseNetscapePluginStream startStreamResponseURL:expectedContentLength:lastModifiedDate:MIMEType:]):
        Use pluginView instead of plugin.
        (-[WebBaseNetscapePluginStream _destroyStream]):
        ditto
        (-[WebBaseNetscapePluginStream finishedLoadingWithData:]):
        ditto
        (-[WebBaseNetscapePluginStream cancelLoadAndDestroyStreamWithError]):
        Set the plugin instance to NULL, so that the pluginView backpointer is released.  This method is called
        for every plugin view's stream when the plugin view is stopped/destroyed.
        (-[WebBaseNetscapePluginStream _deliverData]):
        Use pluginView instead of plugin.

== Rolled over to ChangeLog-2006-02-09 ==
