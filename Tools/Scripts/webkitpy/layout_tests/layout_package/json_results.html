<!DocType html>
<style>
tr:hover {
    opacity: 0.7
}

thead tr:nth-child(odd), tr:nth-child(even) {
    background-color: #E3E9FF;
}

tr:nth-child(odd) {
    background-color: #eee;
}

td {
    padding: 0 4px;
}

th:empty, td:empty {
    padding: 0;
}

th {
    -webkit-user-select: none;
    -moz-user-select: none;
}

label {
    margin-left: 10px;
}

#options {
    position: absolute;
    top: 0;
    right: 0;
}
</style>

<script>
var results;
function ADD_RESULTS(input)
{
    results = input;
}
</script>

<script src="full_results.json"></script>

<script>
function stripExtension(test)
{
    var index = test.lastIndexOf('.');
    return test.substring(0, index);
}

var html = '<p>Tests where results did not match expected results:</p>';

if (results.uses_expectations_file)
    html += '<div id=options><label><input class="unexpected-results" type=checkbox checked>Only show unexpected results</label></div>';

html += '<table id="results-table"><thead><tr>' +
        '<th>test</th>' +
        '<th id="text-results-header">text results</th>' +
        '<th id="image-results-header">image results</th>' +
        '<th>failure type</th>';
        
if (results.uses_expectations_file)
    html += '<th>expected failure type</th>';

html += '</tr></thead>';

function testLink(test)
{
    var test_base_path;
    if (results.layout_tests_dir && location.toString().indexOf('file://') != 0)
        test_base_path = results.layout_tests_dir + '/';
    else
        test_base_path = 'http://trac.webkit.org/browser/trunk/LayoutTests/';
    return '<a href="' + test_base_path + test + '">' + test + '</a>';
}

function resultLink(test_prefix, suffix, contents)
{
    return '<a href="' + test_prefix + suffix + '">' + contents + '</a> ';
}

// FIXME: show expected/actual/diff contents inline in iframes
// FIXME: allow zooming in on pixel diffs

var hasTextFailures = false;
var hasImageFailures = false;

html += '<tbody>';

var testsWithStderr = [];
var newTests = [];
var hasHttpTests = false;

for (var test in results.tests) {
  if (results.tests[test].has_stderr)
      testsWithStderr.push(test);

  hasHttpTests = hasHttpTests || test.indexOf('http/') == 0;

  var actual = results.tests[test].actual;
  if (actual == 'MISSING') {
      // FIXME: make sure that new-run-webkit-tests spits out an -actual.txt file for
      // tests with MISSING results.
      newTests.push(test);
      continue;
  }
  
  var expected = results.tests[test].expected || 'PASS';
  if (actual == 'PASS' && (!results.uses_expectations_file || expected == 'PASS'))
    continue;

  var row = '<td>' + testLink(test) + '</td>';
  var test_prefix = stripExtension(test);

  row += '<td>';
  if (actual == 'CRASH')
      row += resultLink(test_prefix, '-stack.txt', 'stack');
  else if (actual.indexOf('TEXT' || actual == 'TIMEOUT') != -1) {
      // FIXME: only include timeout actual/expected results here if we actually spit out results for timeout tests.
      hasTextFailures = true;
      row += resultLink(test_prefix, '-expected.txt', 'expected') +
          resultLink(test_prefix, '-actual.txt', 'actual') +
          resultLink(test_prefix, '-diff.txt', 'diff');
        
      if (results.has_pretty_patch)
          row += resultLink(test_prefix, '-pretty-diff.html', 'pretty diff');

      if (results.has_wdiff)
          row += resultLink(test_prefix, '-wdiff.html', 'wdiff');
  }

  row += '</td><td>';

  if (actual.indexOf('IMAGE') != -1) {
      hasImageFailures = true;
      row += resultLink(test_prefix, '-expected.png', 'expected') +
          resultLink(test_prefix, '-actual.png', 'actual') +
          resultLink(test_prefix, '-diff.png', 'diff');
  }

  row += '</td>';
  row += '<td>' + actual + '</td>';
  
  if (results.uses_expectations_file)
    row += '<td>' + expected + '</td>';

  var isExpected = results.uses_expectations_file && expected == actual;
  html += '<tr class="' + (isExpected ? 'expected' : '') + '">' + row + '</tr>';
}

html += '</tbody></table>'

function appendTestList(tests, header, tableId, fileSuffix, linkName)
{
    tests.sort();

    html += '<p>' + header + '</p><table id="' + tableId + '">';
    for (var i = 0; i < tests.length; i++) {
        var test = tests[i];
        html += '<tr><td>' + testLink(test) + '</td>' +
            '<td>' + resultLink(stripExtension(test), fileSuffix, linkName) + '</td></tr>';
    }
    html += '</table>'
}

if (newTests.length)
    appendTestList(newTests, 'Tests that had no expected results (probably new):', 'new-tests-table', '-actual.txt', 'result');

if (testsWithStderr.length)
    appendTestList(testsWithStderr, 'Tests that had stderr output:', 'stderr-table', '-stderr.txt', 'stderr');

if (hasHttpTests) {
    html += '<p>httpd access log: <a href="access_log.txt">access_log.txt</a></p>' +
        '<p>httpd error log: <a href="error_log.txt">error_log.txt</a></p>';
}

document.write(html);

function toArray(nodeList)
{
    return Array.prototype.slice.call(nodeList);
}

function trim(string)
{
    return string.replace(/^[\s\xa0]+|[\s\xa0]+$/g, '');
}

// Just a namespace for code management.
var TableSorter = {};

TableSorter._forwardArrow = '<svg style="width:10px;height:10px"><polygon points="0,0 10,0 5,10" style="fill:#aaa"></svg>';

TableSorter._backwardArrow = '<svg style="width:10px;height:10px"><polygon points="0,10 10,10 5,0" style="fill:#aaa"></svg>';

TableSorter._sortedContents = function(header, arrow)
{
    return arrow + ' ' + trim(header.textContent) + ' ' + arrow;
}

TableSorter._updateHeaderClassNames = function(newHeader)
{
    var sortHeader = document.querySelector('.sortHeader');
    if (sortHeader) {
        if (sortHeader == newHeader) {
            var isAlreadyReversed = sortHeader.classList.contains('reversed');
            if (isAlreadyReversed)
                sortHeader.classList.remove('reversed');
            else
                sortHeader.classList.add('reversed');
        } else {
            sortHeader.textContent = sortHeader.textContent;
            sortHeader.classList.remove('sortHeader');
            sortHeader.classList.remove('reversed');
        }
    }

    newHeader.classList.add('sortHeader');
}

TableSorter._sortRows = function(newHeader, reversed)
{
    var testsTable = document.querySelector('#results-table');
    var headers = toArray(testsTable.querySelectorAll('th'));
    var sortColumn = headers.indexOf(newHeader);

    var tbody = testsTable.querySelector('tbody');
    var rows = toArray(tbody.querySelectorAll('tr'));

    rows.sort(function(a, b) {
        // Only need to support lexicographic sort for now.
        var aText = a.childNodes[sortColumn].textContent;
        var bText = b.childNodes[sortColumn].textContent;
        
        // Forward sort equal values by test name.
        if (sortColumn && aText == bText) {
            var aTestName = a.childNodes[0].textContent;
            var bTestName = b.childNodes[0].textContent;
            if (aTestName == bTestName)
                return 0;
            return aTestName < bTestName ? -1 : 1;
        }

        if (reversed)
            return aText < bText ? 1 : -1;
        else
            return aText < bText ? -1 : 1;
    });

    for (var i = 0; i < rows.length; i++)
        tbody.appendChild(rows[i]);
}

TableSorter.sortColumn = function(columnNumber)
{
    var newHeader = document.querySelector('#results-table').querySelectorAll('th')[columnNumber];
    TableSorter._sort(newHeader);
}

TableSorter.handleClick = function(e)
{
    var newHeader = e.target;
    if (newHeader.localName != 'th')
        return;
    TableSorter._sort(newHeader);
}

TableSorter._sort = function(newHeader)
{
    TableSorter._updateHeaderClassNames(newHeader);
    
    var reversed = newHeader.classList.contains('reversed');
    var sortArrow = reversed ? TableSorter._backwardArrow : TableSorter._forwardArrow;
    newHeader.innerHTML = TableSorter._sortedContents(newHeader, sortArrow);
    
    TableSorter._sortRows(newHeader, reversed);
}

document.querySelector('#results-table').addEventListener('click', TableSorter.handleClick, false);
TableSorter.sortColumn(0);

var unexpectedStyleNode = document.createElement('style');
document.body.appendChild(unexpectedStyleNode);

function updateExpectedResults()
{
    if (document.querySelector('.unexpected-results').checked)
        unexpectedStyleNode.innerText = '.expected { display: none; }';
    else
        unexpectedStyleNode.innerText = '';
}

updateExpectedResults();
document.querySelector('.unexpected-results').addEventListener('change', updateExpectedResults, false);

if (!hasTextFailures)
  document.body.querySelector('#text-results-header').textContent = '';
if (!hasImageFailures)
  document.body.querySelector('#image-results-header').textContent = '';
</script>
